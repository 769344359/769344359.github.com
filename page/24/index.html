<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shakudada.xyz","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"79C1GXGOC6","apiKey":"225fa4bf2bc37c3e46a671682674fe37","indexName":"my-hexo-blog","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="dinosaur">
<meta property="og:url" content="https://shakudada.xyz/page/24/index.html">
<meta property="og:site_name" content="dinosaur">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="dinosaur">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shakudada.xyz/page/24/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>dinosaur</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dinosaur</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/11/30/%E6%AD%A3%E5%88%99%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/30/%E6%AD%A3%E5%88%99%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">正则模式</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-30 23:34:50" itemprop="dateCreated datePublished" datetime="2019-11-30T23:34:50+08:00">2019-11-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近在看一个php-cs-fix的时候，发现除了贪婪模式和非贪婪模式还有其他模式<br><a target="_blank" rel="noopener" href="https://github.com/FriendsOfPHP/PHP-CS-Fixer/pull/4659">https://github.com/FriendsOfPHP/PHP-CS-Fixer/pull/4659</a></p>
<ul>
<li>相关阅读<br><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000010544411">https://segmentfault.com/a/1190000010544411</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/11/28/mysql-explain-impossible-condition/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/28/mysql-explain-impossible-condition/" class="post-title-link" itemprop="url">mysql explain  impossible condition</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-28 21:14:00" itemprop="dateCreated datePublished" datetime="2019-11-28T21:14:00+08:00">2019-11-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>很好奇explain的时候怎么explain到很多内容的,所以遇到了explain的内容是<code>Impossible ON condition</code>的时候觉得很好奇</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/11/27/php-tokenlizer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/27/php-tokenlizer/" class="post-title-link" itemprop="url">php tokenlizer与php-cs-fixer</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-27 15:47:44" itemprop="dateCreated datePublished" datetime="2019-11-27T15:47:44+08:00">2019-11-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="tokenlizer"><a href="#tokenlizer" class="headerlink" title="tokenlizer"></a>tokenlizer</h2><p>代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$code = &#x27;&lt;?php echo &quot;string1&quot;.&quot;string2&quot;; &gt;&#x27;;</span><br><span class="line"></span><br><span class="line">$tokens = token_get_all($code);</span><br><span class="line"></span><br><span class="line">foreach ($tokens as $token) &#123;</span><br><span class="line"></span><br><span class="line">    if (is_array($token)) &#123;</span><br><span class="line"></span><br><span class="line">        // 行号、标识符字面量、对应内容</span><br><span class="line"></span><br><span class="line">        printf(&quot;%d - %s\t%s\n&quot;, $token[2], token_name($token[0]), $token[1]);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出内容:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1 - T_OPEN_TAG  &lt;?php</span><br><span class="line">1 - T_ECHO      echo</span><br><span class="line">1 - T_WHITESPACE</span><br><span class="line">1 - T_CONSTANT_ENCAPSED_STRING  &quot;string1&quot;</span><br><span class="line">1 - T_CONSTANT_ENCAPSED_STRING  &quot;string2&quot;</span><br><span class="line">1 - T_WHITESPACE</span><br></pre></td></tr></table></figure>
<h2 id="php-cs-fixer"><a href="#php-cs-fixer" class="headerlink" title="php-cs-fixer"></a>php-cs-fixer</h2><p>php-cs-fixer的核心函数是:<code>token_get_all</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$tokens = \defined(&#x27;TOKEN_PARSE&#x27;)</span><br><span class="line">    ? token_get_all($code, TOKEN_PARSE)</span><br><span class="line">    : token_get_all($code);</span><br></pre></td></tr></table></figure>
<p>调用的核心堆栈:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#0 E:\PHP-CS-Fixer\src\Tokenizer\Tokens.php(222): PhpCsFixer\Tokenizer\Tokens-&gt;setCode(&#x27;&lt;?php\n\n/*\n * Th...&#x27;)</span><br><span class="line">#1 E:\PHP-CS-Fixer\src\Runner\Runner.php(171): PhpCsFixer\Tokenizer\Tokens::fromCode(&#x27;&lt;?php\n\n/*\n * Th...&#x27;)</span><br><span class="line">#2 E:\PHP-CS-Fixer\src\Runner\Runner.php(132): PhpCsFixer\Runner\Runner-&gt;fixFile(Object(SplFileInfo), Object(PhpCsFixer\Linter\ProcessLintingResult))</span><br><span class="line">#3 E:\PHP-CS-Fixer\src\Console\Command\FixCommand.php(219): PhpCsFixer\Runner\Runner-&gt;fix()</span><br><span class="line">#4 E:\PHP-CS-Fixer\vendor\symfony\console\Command\Command.php(255): PhpCsFixer\Console\Command\FixCommand-&gt;execute(Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#5 E:\PHP-CS-Fixer\vendor\symfony\console\Application.php(982): Symfony\Component\Console\Command\Command-&gt;run(Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#6 E:\PHP-CS-Fixer\vendor\symfony\console\Application.php(255): Symfony\Component\Console\Application-&gt;doRunCommand(Object(PhpCsFixer\Console\Command\FixCommand), Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#7 E:\PHP-CS-Fixer\src\Console\Application.php(84): Symfony\Component\Console\Application-&gt;doRun(Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#8 E:\PHP-CS-Fixer\vendor\symfony\console\Application.php(148): PhpCsFixer\Console\Application-&gt;doRun(Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#9 E:\PHP-CS-Fixer\php-cs-fixer(101): Symfony\Component\Console\Application-&gt;run()</span><br><span class="line">#10 &#123;main&#125;</span><br></pre></td></tr></table></figure>

<p>举个例子下面的堆栈: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#0 E:\PHP-CS-Fixer\src\Fixer\Operator\BinaryOperatorSpacesFixer.php(339): PhpCsFixer\Fixer\Operator\BinaryOperatorSpacesFixer-&gt;fixWhiteSpaceAroundOperatorToSingleSpace(Object(PhpCsFixer\Tokenizer\Tokens), 19)</span><br><span class="line">#1 E:\PHP-CS-Fixer\src\Fixer\Operator\BinaryOperatorSpacesFixer.php(256): PhpCsFixer\Fixer\Operator\BinaryOperatorSpacesFixer-&gt;fixWhiteSpaceAroundOperator(Object(PhpCsFixer\Tokenizer\Tokens), 19)</span><br><span class="line">#2 E:\PHP-CS-Fixer\src\AbstractFixer.php(75): PhpCsFixer\Fixer\Operator\BinaryOperatorSpacesFixer-&gt;applyFix(Object(SplFileInfo), Object(PhpCsFixer\Tokenizer\Tokens))</span><br><span class="line">#3 E:\PHP-CS-Fixer\src\Runner\Runner.php(192): PhpCsFixer\AbstractFixer-&gt;fix(Object(SplFileInfo), Object(PhpCsFixer\Tokenizer\Tokens))</span><br><span class="line">#4 E:\PHP-CS-Fixer\src\Runner\Runner.php(132): PhpCsFixer\Runner\Runner-&gt;fixFile(Object(SplFileInfo), Object(PhpCsFixer\Linter\ProcessLintingResult))</span><br><span class="line">#5 E:\PHP-CS-Fixer\src\Console\Command\FixCommand.php(219): PhpCsFixer\Runner\Runner-&gt;fix()</span><br><span class="line">#6 E:\PHP-CS-Fixer\vendor\symfony\console\Command\Command.php(255): PhpCsFixer\Console\Command\FixCommand-&gt;execute(Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#7 E:\PHP-CS-Fixer\vendor\symfony\console\Application.php(982): Symfony\Component\Console\Command\Command-&gt;run(Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#8 E:\PHP-CS-Fixer\vendor\symfony\console\Application.php(255): Symfony\Component\Console\Application-&gt;doRunCommand(Object(PhpCsFixer\Console\Command\FixCommand), Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#9 E:\PHP-CS-Fixer\src\Console\Application.php(84): Symfony\Component\Console\Application-&gt;doRun(Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#10 E:\PHP-CS-Fixer\vendor\symfony\console\Application.php(148): PhpCsFixer\Console\Application-&gt;doRun(Object(Symfony\Component\Console\Input\ArgvInput), Object(Symfony\Component\Console\Output\ConsoleOutput))</span><br><span class="line">#11 E:\PHP-CS-Fixer\php-cs-fixer(101): Symfony\Component\Console\Application-&gt;run()</span><br><span class="line">#12 &#123;main&#125;</span><br></pre></td></tr></table></figure>
<p>核心就是给后面加入token<br>&#x2F;&#x2F; todo</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/11/26/docker%E4%B8%8Eiptable/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/26/docker%E4%B8%8Eiptable/" class="post-title-link" itemprop="url">docker与iptable和网桥</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-26 23:41:07" itemprop="dateCreated datePublished" datetime="2019-11-26T23:41:07+08:00">2019-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="如何创建网桥"><a href="#如何创建网桥" class="headerlink" title="如何创建网桥"></a>如何创建网桥</h2><p>创建网桥,可以通过<code>bridge-utils</code>包的<code>brctl</code>来创建一个网桥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sudo brctl addbr br0</span><br></pre></td></tr></table></figure>
<p>然后通过<code>brctl  show</code>可以看到列出的网桥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$brctl  show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces</span><br><span class="line">br0		8000.000000000000	no		</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过<code>strace</code>查看系统调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sudo strace  brctl addbr br1</span><br></pre></td></tr></table></figure>


<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@VM-0-3-ubuntu:~/libnlbuild/bin$ sudo strace  brctl addbr br1</span><br><span class="line">...</span><br><span class="line">socket(AF_UNIX, SOCK_STREAM, 0)         = 3</span><br><span class="line">ioctl(3, SIOCBRADDBR, &quot;br1&quot;)            = 0</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>
<p>看到调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ioctl(3, SIOCBRADDBR, &quot;br1&quot;) </span><br></pre></td></tr></table></figure>
<p><code>3</code> 指的是打开的文件描述符.<code>0,1,2</code>都是特殊的标准输入输出错误等的文件描述符,所以下一个打开的文件就是<code>3</code></p>
<p>我写的一个创建网桥的小例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//  bradd.c</span><br><span class="line">#include &lt;linux/sockios.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line">#include &lt;sys/un.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;sys/ioctl.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">int main()&#123;</span><br><span class="line">        int br_socket_fd,ret;</span><br><span class="line">        if(br_socket_fd = socket(AF_LOCAL, SOCK_STREAM, 0) &lt; 0)&#123;</span><br><span class="line">            perror(&quot;Error: &quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if(ret = ioctl(br_socket_fd, SIOCBRADDBR,&quot;hello&quot;) &lt; 0) // SIOCBRADDBR 由sockios.h 引入</span><br><span class="line">        &#123;</span><br><span class="line">            perror(&quot;ioctl error&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$gcc bradd.c -o </span><br><span class="line">## 需要使用sudo添加网桥</span><br><span class="line">$sudo ./bradd     </span><br></pre></td></tr></table></figure>

<p>然后用<code>brctl show</code> 输出,创建了一个叫hello的网桥:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ brctl show</span><br><span class="line">bridge name	bridge id		STP enabled	interfaces		</span><br><span class="line">docker0		8000.024273119fd1	no		vethe6cf6a0</span><br><span class="line">hello		8000.000000000000	no		</span><br></pre></td></tr></table></figure>

<p>然后我们发现了<code>docker0</code>和<code>hello</code>两个网桥相差一个<code>interfaces</code>,我们如何添加<code>veth</code>呢?</p>
<ul>
<li>在brctl 中可以使用<code>brctl addif</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int br_add_interface(const char *bridge, const char *dev)</span><br><span class="line">&#123;</span><br><span class="line">	struct ifreq ifr;</span><br><span class="line">	...</span><br><span class="line">	int ifindex = if_nametoindex(dev);</span><br><span class="line">	...</span><br><span class="line">	strncpy(ifr.ifr_name, bridge, IFNAMSIZ);</span><br><span class="line">	ifr.ifr_ifindex = ifindex;</span><br><span class="line">	err = ioctl(br_socket_fd, SIOCBRADDIF, &amp;ifr);</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
最后调用linux 的<code>net/bridge/br_if.c</code>:</li>
</ul>
<p>&#x2F;&#x2F; dev 是我们要添加的设备<br>&#x2F;&#x2F; br 是我们的网桥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">/* called with RTNL */</span><br><span class="line">int br_add_if(struct net_bridge *br, struct net_device *dev,</span><br><span class="line">	      struct netlink_ext_ack *extack)</span><br><span class="line">&#123;</span><br><span class="line">	struct net_bridge_port *p;</span><br><span class="line">	int err = 0;</span><br><span class="line">	unsigned br_hr, dev_hr;</span><br><span class="line">	bool changed_addr;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	p = new_nbp(br, dev);</span><br><span class="line">	if (IS_ERR(p))</span><br><span class="line">		return PTR_ERR(p);</span><br><span class="line"></span><br><span class="line">	call_netdevice_notifiers(NETDEV_JOIN, dev);</span><br><span class="line"></span><br><span class="line">	err = dev_set_allmulti(dev, 1);</span><br><span class="line">	if (err) &#123;</span><br><span class="line">		kfree(p);	/* kobject not yet init&#x27;d, manually free */</span><br><span class="line">		goto err1;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = kobject_init_and_add(&amp;p-&gt;kobj, &amp;brport_ktype, &amp;(dev-&gt;dev.kobj),</span><br><span class="line">				   SYSFS_BRIDGE_PORT_ATTR);</span><br><span class="line">	if (err)</span><br><span class="line">		goto err2;</span><br><span class="line"></span><br><span class="line">	err = br_sysfs_addif(p);</span><br><span class="line">	if (err)</span><br><span class="line">		goto err2;</span><br><span class="line"></span><br><span class="line">	err = br_netpoll_enable(p);</span><br><span class="line">	if (err)</span><br><span class="line">		goto err3;</span><br><span class="line"></span><br><span class="line">	err = netdev_rx_handler_register(dev, br_handle_frame, p);</span><br><span class="line">	if (err)</span><br><span class="line">		goto err4;</span><br><span class="line"></span><br><span class="line">	dev-&gt;priv_flags |= IFF_BRIDGE_PORT;</span><br><span class="line"></span><br><span class="line">	err = netdev_master_upper_dev_link(dev, br-&gt;dev, NULL, NULL, extack);</span><br><span class="line">	if (err)</span><br><span class="line">		goto err5;</span><br><span class="line"></span><br><span class="line">	err = nbp_switchdev_mark_set(p);</span><br><span class="line">	if (err)</span><br><span class="line">		goto err6;</span><br><span class="line"></span><br><span class="line">	dev_disable_lro(dev);</span><br><span class="line"></span><br><span class="line">	list_add_rcu(&amp;p-&gt;list, &amp;br-&gt;port_list);</span><br><span class="line"></span><br><span class="line">	nbp_update_port_count(br);</span><br><span class="line"></span><br><span class="line">	netdev_update_features(br-&gt;dev);</span><br><span class="line"></span><br><span class="line">	br_hr = br-&gt;dev-&gt;needed_headroom;</span><br><span class="line">	dev_hr = netdev_get_fwd_headroom(dev);</span><br><span class="line">	if (br_hr &lt; dev_hr)</span><br><span class="line">		update_headroom(br, dev_hr);</span><br><span class="line">	else</span><br><span class="line">		netdev_set_rx_headroom(dev, br_hr);</span><br><span class="line"></span><br><span class="line">	if (br_fdb_insert(br, p, dev-&gt;dev_addr, 0))</span><br><span class="line">		netdev_err(dev, &quot;failed insert local address bridge forwarding table\n&quot;);</span><br><span class="line"></span><br><span class="line">	if (br-&gt;dev-&gt;addr_assign_type != NET_ADDR_SET) &#123;</span><br><span class="line">		/* Ask for permission to use this MAC address now, even if we</span><br><span class="line">		 * don&#x27;t end up choosing it below.</span><br><span class="line">		 */</span><br><span class="line">		err = dev_pre_changeaddr_notify(br-&gt;dev, dev-&gt;dev_addr, extack);</span><br><span class="line">		if (err)</span><br><span class="line">			goto err7;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = nbp_vlan_init(p, extack);</span><br><span class="line">	if (err) &#123;</span><br><span class="line">		netdev_err(dev, &quot;failed to initialize vlan filtering on this port\n&quot;);</span><br><span class="line">		goto err7;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	spin_lock_bh(&amp;br-&gt;lock);</span><br><span class="line">	changed_addr = br_stp_recalculate_bridge_id(br);</span><br><span class="line"></span><br><span class="line">	if (netif_running(dev) &amp;&amp; netif_oper_up(dev) &amp;&amp;</span><br><span class="line">	    (br-&gt;dev-&gt;flags &amp; IFF_UP))</span><br><span class="line">		br_stp_enable_port(p);</span><br><span class="line">	spin_unlock_bh(&amp;br-&gt;lock);</span><br><span class="line"></span><br><span class="line">	br_ifinfo_notify(RTM_NEWLINK, NULL, p);</span><br><span class="line"></span><br><span class="line">	if (changed_addr)</span><br><span class="line">		call_netdevice_notifiers(NETDEV_CHANGEADDR, br-&gt;dev);</span><br><span class="line"></span><br><span class="line">	br_mtu_auto_adjust(br);</span><br><span class="line">	br_set_gso_limits(br);</span><br><span class="line"></span><br><span class="line">	kobject_uevent(&amp;p-&gt;kobj, KOBJ_ADD);</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加虚拟设备:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># strace  ip link add vethaaa type veth peer name vethbbb</span><br><span class="line">execve(&quot;/sbin/ip&quot;, [&quot;ip&quot;, &quot;link&quot;, &quot;add&quot;, &quot;vethaaa&quot;, &quot;type&quot;, &quot;veth&quot;, &quot;peer&quot;, &quot;name&quot;, &quot;vethbbb&quot;], 0x7ffed8af30f0 /* 23 vars */) </span><br><span class="line">...</span><br><span class="line">socket(AF_NETLINK, SOCK_RAW|SOCK_CLOEXEC, NETLINK_ROUTE) = 3</span><br><span class="line">setsockopt(3, SOL_SOCKET, SO_SNDBUF, [32768], 4) = 0</span><br><span class="line">setsockopt(3, SOL_SOCKET, SO_RCVBUF, [1048576], 4) = 0</span><br><span class="line">setsockopt(3, SOL_NETLINK, NETLINK_EXT_ACK, [1], 4) = 0</span><br><span class="line">bind(3, &#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, 12) = 0</span><br><span class="line">getsockname(3, &#123;sa_family=AF_NETLINK, nl_pid=26226, nl_groups=00000000&#125;, [12]) = 0</span><br><span class="line">sendto(3, &#123;&#123;len=32, type=RTM_NEWLINK, flags=NLM_F_REQUEST|NLM_F_ACK, seq=0, pid=0&#125;, &#123;ifi_family=AF_UNSPEC, ifi_type=ARPHRD_NETROM, ifi_index=0, ifi_flags=0, ifi_change=0&#125;&#125;, 32, 0, NULL, 0) = 32</span><br><span class="line">recvmsg(3, &#123;msg_name=&#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, msg_namelen=12, msg_iov=[&#123;iov_base=&#123;&#123;len=52, type=NLMSG_ERROR, flags=0, seq=0, pid=26226&#125;, &#123;error=-ENODEV, msg=&#123;&#123;len=32, type=RTM_NEWLINK, flags=NLM_F_REQUEST|NLM_F_ACK, seq=0, pid=0&#125;, &#123;ifi_family=AF_UNSPEC, ifi_type=ARPHRD_NETROM, ifi_index=0, ifi_flags=0, ifi_change=0&#125;&#125;&#125;&#125;, iov_len=16384&#125;], msg_iovlen=1, msg_controllen=0, msg_flags=0&#125;, 0) = 52</span><br><span class="line">access(&quot;/proc/net&quot;, R_OK)               = 0</span><br><span class="line">access(&quot;/proc/net/unix&quot;, R_OK)          = 0</span><br><span class="line">socket(AF_UNIX, SOCK_DGRAM|SOCK_CLOEXEC, 0) = 4</span><br><span class="line">ioctl(4, SIOCGIFINDEX, &#123;ifr_name=&quot;vethaaa&quot;&#125;) = -1 ENODEV (No such device)</span><br><span class="line">close(4)                                = 0</span><br><span class="line">brk(NULL)                               = 0x560e12455000</span><br><span class="line">brk(0x560e12476000)                     = 0x560e12476000</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/lib/ip/link_veth.so&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">sendmsg(3, &#123;msg_name=&#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, msg_namelen=12, msg_iov=[&#123;iov_base=&#123;&#123;len=92, type=RTM_NEWLINK, flags=NLM_F_REQUEST|NLM_F_ACK|NLM_F_EXCL|NLM_F_CREATE, seq=1576836139, pid=0&#125;, &#123;ifi_family=AF_UNSPEC, ifi_type=ARPHRD_NETROM, ifi_index=0, ifi_flags=0, ifi_change=0&#125;, [&#123;&#123;nla_len=12, nla_type=IFLA_IFNAME&#125;, &quot;vethaaa&quot;&#125;, &#123;&#123;nla_len=48, nla_type=IFLA_LINKINFO&#125;, [&#123;&#123;nla_len=8, nla_type=IFLA_INFO_KIND&#125;, &quot;veth&quot;...&#125;, &#123;&#123;nla_len=36, nla_type=IFLA_INFO_DATA&#125;, &quot;\x20\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0c\x00\x03\x00\x76\x65\x74\x68\x62\x62\x62\x00&quot;&#125;]&#125;]&#125;, iov_len=92&#125;], msg_iovlen=1, msg_controllen=0, msg_flags=0&#125;, 0) = 92</span><br><span class="line">recvmsg(3, &#123;msg_name=&#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, msg_namelen=12, msg_iov=[&#123;iov_base=NULL, iov_len=0&#125;], msg_iovlen=1, msg_controllen=0, msg_flags=MSG_TRUNC&#125;, MSG_PEEK|MSG_TRUNC) = 36</span><br><span class="line">recvmsg(3, &#123;msg_name=&#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, msg_namelen=12, msg_iov=[&#123;iov_base=&#123;&#123;len=36, type=NLMSG_ERROR, flags=NLM_F_CAPPED, seq=1576836139, pid=26226&#125;, &#123;error=0, msg=&#123;len=92, type=RTM_NEWLINK, flags=NLM_F_REQUEST|NLM_F_ACK|NLM_F_EXCL|NLM_F_CREATE, seq=1576836139, pid=0&#125;&#125;&#125;, iov_len=36&#125;], msg_iovlen=1, msg_controllen=0, msg_flags=0&#125;, 0) = 36</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">socket(AF_NETLINK, SOCK_RAW|SOCK_CLOEXEC, NETLINK_ROUTE) = 3</span><br><span class="line">setsockopt(3, SOL_SOCKET, SO_SNDBUF, [32768], 4) = 0</span><br><span class="line">setsockopt(3, SOL_SOCKET, SO_RCVBUF, [1048576], 4) = 0</span><br><span class="line">setsockopt(3, SOL_NETLINK, NETLINK_EXT_ACK, [1], 4) = 0</span><br><span class="line">bind(3, &#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, 12) = 0</span><br><span class="line">getsockname(3, &#123;sa_family=AF_NETLINK, nl_pid=18263, nl_groups=00000000&#125;, [12]) = 0</span><br><span class="line">sendto(3, &#123;&#123;len=32, type=RTM_NEWLINK, flags=NLM_F_REQUEST|NLM_F_ACK, seq=0, pid=0&#125;, &#123;ifi_family=AF_UNSPEC, ifi_type=ARPHRD_NETROM, ifi_index=0, ifi_flags=0, ifi_change=0&#125;&#125;, 32, 0, NULL, 0) = 32</span><br><span class="line">recvmsg(3, &#123;msg_name=&#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, msg_namelen=12, msg_iov=[&#123;iov_base=&#123;&#123;len=52, type=NLMSG_ERROR, flags=0, seq=0, pid=18263&#125;, &#123;error=-EPERM, msg=&#123;&#123;len=32, type=RTM_NEWLINK, flags=NLM_F_REQUEST|NLM_F_ACK, seq=0, pid=0&#125;, &#123;ifi_family=AF_UNSPEC, ifi_type=ARPHRD_NETROM, ifi_index=0, ifi_flags=0, ifi_change=0&#125;&#125;&#125;&#125;, iov_len=16384&#125;], msg_iovlen=1, msg_controllen=0, msg_flags=0&#125;, 0) = 52</span><br><span class="line">access(&quot;/proc/net&quot;, R_OK)               = 0</span><br><span class="line">access(&quot;/proc/net/unix&quot;, R_OK)          = 0</span><br><span class="line">socket(AF_UNIX, SOCK_DGRAM|SOCK_CLOEXEC, 0) = 4</span><br><span class="line">ioctl(4, SIOCGIFINDEX, &#123;ifr_name=&quot;p1&quot;&#125;) = -1 ENODEV (No such device)</span><br><span class="line">close(4)                                = 0</span><br><span class="line">brk(NULL)                               = 0x5595d01bb000</span><br><span class="line">brk(0x5595d01dc000)                     = 0x5595d01dc000</span><br><span class="line">openat(AT_FDCWD, &quot;/usr/lib/ip/link_veth.so&quot;, O_RDONLY|O_CLOEXEC) = -1 ENOENT (No such file or directory)</span><br><span class="line">sendmsg(3, &#123;msg_name=&#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, msg_namelen=12, msg_iov=[&#123;iov_base=&#123;&#123;len=84, type=RTM_NEWLINK, flags=NLM_F_REQUEST|NLM_F_ACK|NLM_F_EXCL|NLM_F_CREATE, seq=1576748752, pid=0&#125;, &#123;ifi_family=AF_UNSPEC, ifi_type=ARPHRD_NETROM, ifi_index=0, ifi_flags=0, ifi_change=0&#125;, [&#123;&#123;nla_len=7, nla_type=IFLA_IFNAME&#125;, &quot;p1&quot;&#125;, &#123;&#123;nla_len=44, nla_type=IFLA_LINKINFO&#125;, [&#123;&#123;nla_len=8, nla_type=IFLA_INFO_KIND&#125;, &quot;veth&quot;...&#125;, &#123;&#123;nla_len=32, nla_type=IFLA_INFO_DATA&#125;, &quot;\x1c\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x00\x03\x00\x70\x32\x00\x00&quot;&#125;]&#125;]&#125;, iov_len=84&#125;], msg_iovlen=1, msg_controllen=0, msg_flags=0&#125;, 0) = 84</span><br><span class="line">recvmsg(3, &#123;msg_name=&#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, msg_namelen=12, msg_iov=[&#123;iov_base=NULL, iov_len=0&#125;], msg_iovlen=1, msg_controllen=0, msg_flags=MSG_TRUNC&#125;, MSG_PEEK|MSG_TRUNC) = 104</span><br><span class="line">recvmsg(3, &#123;msg_name=&#123;sa_family=AF_NETLINK, nl_pid=0, nl_groups=00000000&#125;, msg_namelen=12, msg_iov=[&#123;iov_base=&#123;&#123;len=104, type=NLMSG_ERROR, flags=0, seq=1576748752, pid=18263&#125;, &#123;error=-EPERM, msg=&#123;&#123;len=84, type=RTM_NEWLINK, flags=NLM_F_REQUEST|NLM_F_ACK|NLM_F_EXCL|NLM_F_CREATE, seq=1576748752, pid=0&#125;, &#123;ifi_family=AF_UNSPEC, ifi_type=ARPHRD_NETROM, ifi_index=0, ifi_flags=0, ifi_change=0&#125;, [&#123;&#123;nla_len=7, nla_type=IFLA_IFNAME&#125;, &quot;p1&quot;&#125;, &#123;&#123;nla_len=44, nla_type=IFLA_LINKINFO&#125;, [&#123;&#123;nla_len=8, nla_type=IFLA_INFO_KIND&#125;, &quot;veth&quot;...&#125;, &#123;&#123;nla_len=32, nla_type=IFLA_INFO_DATA&#125;, &quot;\x1c\x00\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x00\x03\x00\x70\x32\x00\x00&quot;&#125;]&#125;]&#125;&#125;&#125;, iov_len=104&#125;], msg_iovlen=1, msg_controllen=0, msg_flags=0&#125;, 0) = 104</span><br><span class="line">write(2, &quot;RTNETLINK answers: Operation not&quot;..., 43RTNETLINK answers: Operation not permitted</span><br><span class="line">) = 43</span><br><span class="line">exit_group(2)                           = ?</span><br><span class="line">+++ exited with 2 +++</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>linux 相关的netlink veth内容:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// drivers\net\veth.c</span><br><span class="line">static struct rtnl_link_ops veth_link_ops = &#123;</span><br><span class="line">	.kind		= DRV_NAME,</span><br><span class="line">	.priv_size	= sizeof(struct veth_priv),</span><br><span class="line">	.setup		= veth_setup,</span><br><span class="line">	.validate	= veth_validate,</span><br><span class="line">	.newlink	= veth_newlink,</span><br><span class="line">	.dellink	= veth_dellink,</span><br><span class="line">	.policy		= veth_policy,</span><br><span class="line">	.maxtype	= VETH_INFO_MAX,</span><br><span class="line">	.get_link_net	= veth_get_link_net,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">E:\linux-master\net\netlink\af_netlink.c</span><br><span class="line">static const struct proto_ops netlink_ops = &#123;</span><br><span class="line">	.family =	PF_NETLINK,</span><br><span class="line">	.owner =	THIS_MODULE,</span><br><span class="line">	.release =	netlink_release,</span><br><span class="line">	.bind =		netlink_bind,</span><br><span class="line">	.connect =	netlink_connect,</span><br><span class="line">	.socketpair =	sock_no_socketpair,</span><br><span class="line">	.accept =	sock_no_accept,</span><br><span class="line">	.getname =	netlink_getname,</span><br><span class="line">	.poll =		datagram_poll,</span><br><span class="line">	.ioctl =	netlink_ioctl,</span><br><span class="line">	.listen =	sock_no_listen,</span><br><span class="line">	.shutdown =	sock_no_shutdown,</span><br><span class="line">	.setsockopt =	netlink_setsockopt,</span><br><span class="line">	.getsockopt =	netlink_getsockopt,</span><br><span class="line">	.sendmsg =	netlink_sendmsg,</span><br><span class="line">	.recvmsg =	netlink_recvmsg,</span><br><span class="line">	.mmap =		sock_no_mmap,</span><br><span class="line">	.sendpage =	sock_no_sendpage,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


<h2 id="添加veth-设备"><a href="#添加veth-设备" class="headerlink" title="添加veth 设备"></a>添加veth 设备</h2><p>首先是添加socket </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  socket () at ../sysdeps/unix/syscall-template.S:78</span><br><span class="line">#1  0x00005555555b60c7 in rtnl_open_byproto (rth=0x5555557d8020 &lt;rth&gt;, subscriptions=0, protocol=&lt;optimized out&gt;) at libnetlink.c:194</span><br><span class="line">#2  0x000055555555f956 in main (argc=9, argv=0x7fffffffe548) at ip.c:308</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 6, __libc_sendmsg (fd=3, msg=msg@entry=0x7fffffffdd70, flags=flags@entry=0) at ../sysdeps/unix/sysv/linux/sendmsg.c:28</span><br><span class="line">28	../sysdeps/unix/sysv/linux/sendmsg.c: No such file or directory.</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  __libc_sendmsg (fd=3, msg=msg@entry=0x7fffffffdd70, flags=flags@entry=0) at ../sysdeps/unix/sysv/linux/sendmsg.c:28</span><br><span class="line">#1  0x00005555555b5c8f in __rtnl_talk_iov (rtnl=0x5555557d8020 &lt;rth&gt;, iov=iov@entry=0x7fffffffddf0, iovlen=iovlen@entry=1, answer=answer@entry=0x0, show_rtnl_err=show_rtnl_err@entry=true, </span><br><span class="line">    errfn=0x0) at libnetlink.c:887</span><br><span class="line">#2  0x00005555555b7225 in __rtnl_talk (errfn=0x0, show_rtnl_err=true, answer=&lt;optimized out&gt;, n=0x7fffffffde40, rtnl=&lt;optimized out&gt;) at libnetlink.c:1000</span><br><span class="line">#3  rtnl_talk (rtnl=&lt;optimized out&gt;, n=n@entry=0x7fffffffde40, answer=answer@entry=0x0) at libnetlink.c:1006</span><br><span class="line">#4  0x000055555557bc6e in iplink_modify (cmd=cmd@entry=16, flags=flags@entry=1536, argc=3, argc@entry=6, argv=&lt;optimized out&gt;, argv@entry=0x7fffffffe560) at iplink.c:1084</span><br><span class="line">#5  0x000055555557c0c6 in do_iplink (argc=7, argv=0x7fffffffe558) at iplink.c:1641</span><br><span class="line">#6  0x000055555555ff0c in do_cmd (argv0=0x7fffffffe7d8 &quot;link&quot;, argc=8, argv=0x7fffffffe550) at ip.c:113</span><br><span class="line">#7  0x000055555555f9a0 in main (argc=9, argv=0x7fffffffe548) at ip.c:317</span><br></pre></td></tr></table></figure>

<p>比如命令<code>ip link add veth_0 type veth peer name veth_0_peer</code><br>初始化的时候req.n 的长度是32</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> p req.n.nlmsg_len </span><br><span class="line">$1 = 32</span><br></pre></td></tr></table></figure>
<p>经过<code>ret = iplink_parse(argc, argv, &amp;req, &amp;type);</code> 后变成<code>44</code>,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p ((char *)n)[32]@64</span><br><span class="line">$50 = &quot;\v\000\003\000veth_0\000\000\064\000\022\000\b\000\001\000veth(\000\002\000$\000\001&quot;, &#x27;\000&#x27; &lt;repeats 17 times&gt;, &quot;\020\000\003\000veth_0_peer&quot;</span><br></pre></td></tr></table></figure>
<h2 id="iptables是什么？"><a href="#iptables是什么？" class="headerlink" title="iptables是什么？"></a>iptables是什么？</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># type iptables</span><br><span class="line">iptables is hashed (/sbin/iptables)</span><br></pre></td></tr></table></figure>

<p>iptables命令为什么可以处理那些问题呢？</p>
<h2 id="iptable原理"><a href="#iptable原理" class="headerlink" title="iptable原理"></a>iptable原理</h2><p>iptable就是通过socket  netlink做特别的通信,改变netfilter子系统的相关hook</p>
<p><a target="_blank" rel="noopener" href="https://netfilter.org/projects/iptables/downloads.html">源码</a><br><a target="_blank" rel="noopener" href="https://my.oschina.net/qihh/blog/62169">相关阅读</a></p>
<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yhp-smarthome/p/6910787.html">https://www.cnblogs.com/yhp-smarthome/p/6910787.html</a></li>
<li><a target="_blank" rel="noopener" href="https://goyalankit.com/blog/linux-bridge">https://goyalankit.com/blog/linux-bridge</a></li>
<li><a target="_blank" rel="noopener" href="http://www.linuxfromscratch.org/blfs/view/svn/basicnet/bridge-utils.html">http://www.linuxfromscratch.org/blfs/view/svn/basicnet/bridge-utils.html</a></li>
<li><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v3.3.3/source/include/linux/sockios.h#L122">https://elixir.bootlin.com/linux/v3.3.3/source/include/linux/sockios.h#L122</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.chinaunix.net/uid-27017686-id-5057025.html">http://blog.chinaunix.net/uid-27017686-id-5057025.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wenqiang/p/6306727.html">https://www.cnblogs.com/wenqiang/p/6306727.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/sty23122555/article/details/51581979">https://blog.csdn.net/sty23122555/article/details/51581979</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000016080251">https://segmentfault.com/a/1190000016080251</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wenqiang/p/6634447.html">https://www.cnblogs.com/wenqiang/p/6634447.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/11/26/java-%E5%BC%82%E5%B8%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/26/java-%E5%BC%82%E5%B8%B8/" class="post-title-link" itemprop="url">java 异常</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-26 13:06:07" itemprop="dateCreated datePublished" datetime="2019-11-26T13:06:07+08:00">2019-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="异常例子"><a href="#异常例子" class="headerlink" title="异常例子"></a>异常例子</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import java.io.*;</span><br><span class="line">public class className</span><br><span class="line">&#123;</span><br><span class="line">  public void deposit(double amount) throws RemoteException</span><br><span class="line">  &#123;</span><br><span class="line">    // Method implementation</span><br><span class="line">    throw new RemoteException();</span><br><span class="line">  &#125;</span><br><span class="line">  //Remainder of class definition</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="异常的实质是什么"><a href="#异常的实质是什么" class="headerlink" title="异常的实质是什么?"></a>异常的实质是什么?</h2><p>实质就是一个获取堆栈的类,这个类特别的地方在于可以获取堆栈,核心也在于获取堆栈和捕获异常</p>
<h2 id="checked-exception"><a href="#checked-exception" class="headerlink" title="checked exception"></a>checked exception</h2><p><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-11.html">来源</a></p>
<blockquote>
<p>The unchecked exception classes are the run-time exception classes and the error classes.</p>
</blockquote>
<blockquote>
<p>The checked exception classes are all exception classes other than the unchecked exception classes. That is, the checked exception classes are Throwable and all its subclasses other than RuntimeException and its subclasses and Error and its subclasses.</p>
</blockquote>
<p><code>uncheckded exception</code>就是运行时异常类和<code>error</code>类,其他都是<code>checked exception</code>  </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/11/25/java-string-%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/25/java-string-%E7%9B%B8%E5%85%B3%E5%86%85%E5%AE%B9/" class="post-title-link" itemprop="url">java string 相关内容</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-25 12:43:34" itemprop="dateCreated datePublished" datetime="2019-11-25T12:43:34+08:00">2019-11-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>版本是java8</p>
<h2 id="基本类型和对象"><a href="#基本类型和对象" class="headerlink" title="基本类型和对象"></a>基本类型和对象</h2><p>java的string是什么呢?<br>很明显是对象</p>
<h2 id="特化的"><a href="#特化的" class="headerlink" title="特化的+"></a>特化的+</h2><blockquote>
<p>15.18.1. String Concatenation Operator +<br>If only one operand expression is of type String, then string conversion (§5.1.11) is performed on the other operand to produce a string at run time.<br><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-15.html#jls-15.18.1">来源</a></p>
</blockquote>
<p>java的字符串连接符是<code>+</code>,而php的是<code>.</code></p>
<h2 id="stringbuilder"><a href="#stringbuilder" class="headerlink" title="stringbuilder"></a>stringbuilder</h2><h2 id="string常量折叠"><a href="#string常量折叠" class="headerlink" title="string常量折叠"></a>string常量折叠</h2><p>由于上面提到的jls8中的<code>String Concatenation Operator +</code>提到相关内容,如果操作符中只有一个string类型的话,类型转换会发生在运行时.没有规定两个都是string的时候怎么处理,所以javac将他折叠了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/** If tree is a concatenation of string literals, replace it</span><br><span class="line">  *  by a single literal representing the concatenated string.</span><br><span class="line">  */</span><br><span class="line"> protected JCExpression foldStrings(JCExpression tree) &#123;</span><br><span class="line">     if (!allowStringFolding)</span><br><span class="line">         return tree;</span><br><span class="line">     ListBuffer&lt;JCExpression&gt; opStack = new ListBuffer&lt;&gt;();</span><br><span class="line">     ListBuffer&lt;JCLiteral&gt; litBuf = new ListBuffer&lt;&gt;();</span><br><span class="line">     boolean needsFolding = false;</span><br><span class="line">     JCExpression curr = tree;</span><br><span class="line">     while (true) &#123;</span><br><span class="line">         if (curr.hasTag(JCTree.Tag.PLUS)) &#123;</span><br><span class="line">             JCBinary op = (JCBinary)curr;</span><br><span class="line">             needsFolding |= foldIfNeeded(op.rhs, litBuf, opStack, false);</span><br><span class="line">             curr = op.lhs;</span><br><span class="line">         &#125; else &#123;</span><br><span class="line">             needsFolding |= foldIfNeeded(curr, litBuf, opStack, true);</span><br><span class="line">             break; //last one!</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     if (needsFolding) &#123;</span><br><span class="line">         List&lt;JCExpression&gt; ops = opStack.toList();</span><br><span class="line">         JCExpression res = ops.head;</span><br><span class="line">         for (JCExpression op : ops.tail) &#123;</span><br><span class="line">             res = F.at(op.getStartPosition()).Binary(optag(TokenKind.PLUS), res, op);</span><br><span class="line">             storeEnd(res, getEndPos(op));</span><br><span class="line">         &#125;</span><br><span class="line">         return res;</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         return tree;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>
<p>[foldStrings]<a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk/blob/6bab0f539fba8fb441697846347597b4a0ade428/src/jdk.compiler/share/classes/com/sun/tools/javac/parser/JavacParser.java#L950">https://github.com/openjdk/jdk/blob/6bab0f539fba8fb441697846347597b4a0ade428/src/jdk.compiler/share/classes/com/sun/tools/javac/parser/JavacParser.java#L950</a></p>
<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/355089/difference-between-stringbuilder-and-stringbuffer">https://stackoverflow.com/questions/355089/difference-between-stringbuilder-and-stringbuffer</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk/blob/6bab0f539fba8fb441697846347597b4a0ade428/src/jdk.compiler/share/classes/com/sun/tools/javac/parser/JavacParser.java#L950">https://github.com/openjdk/jdk/blob/6bab0f539fba8fb441697846347597b4a0ade428/src/jdk.compiler/share/classes/com/sun/tools/javac/parser/JavacParser.java#L950</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/11/21/composer-ext/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/21/composer-ext/" class="post-title-link" itemprop="url">composer-ext</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-21 13:21:37" itemprop="dateCreated datePublished" datetime="2019-11-21T13:21:37+08:00">2019-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>看到phpstorm的相关警告,经常会看到phpstorm会警告没有<code>ext-json</code>,我才最近发现composer.json会添加相关的扩展校验.</p>
<p>举个例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&quot;require&quot;: &#123;</span><br><span class="line">    &quot;php&quot;: &quot;&gt;=5.4.0&quot;,</span><br><span class="line">    &quot;topthink/framework&quot;: &quot;^5.0&quot;,</span><br><span class="line">    &quot;php-imap/php-imap&quot;: &quot;~2.0&quot;,</span><br><span class="line">    &quot;phpoffice/phpspreadsheet&quot;: &quot;^1.3&quot;,</span><br><span class="line">    &quot;hprose/hprose&quot;: &quot;^2.0&quot;,</span><br><span class="line">    &quot;ext-json&quot;: &quot;*&quot;   // 这就是解析require json 扩展</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>这个就是校验是否含有<code>json</code>扩展,那么composer是怎么实现的呢?其实是通过<code>extension_loaded</code>这个函数取查看扩展版本的</p>
<p>实现是在composer的129行<a target="_blank" rel="noopener" href="https://github.com/composer/composer/blob/79a300eaac89be9a4b05cd992930f343ba4f084d/src/Composer/DependencyResolver/Problem.php">实现</a>,通过<code>extension_loaded</code>获取扩展.</p>
<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/en/function.extension-loaded.php">https://www.php.net/manual/en/function.extension-loaded.php</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/11/14/java%E7%9A%84package%E4%B8%8E%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/14/java%E7%9A%84package%E4%B8%8E%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84/" class="post-title-link" itemprop="url">java的package与文件路径与编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-11-14 14:33:37" itemprop="dateCreated datePublished" datetime="2019-11-14T14:33:37+08:00">2019-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>写了很久的php的原生代码,对php相对路径自动加载这类坑的恐惧已经深入骨髓了.<br>java和golang也有类似的内容,对于写java没多久的我来说,先记录一下</p>
<p>关于类名和classpath的关系,oracle的文档有相关的<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/classpath.html#BEHCGBFB">描述</a></p>
<blockquote>
<p>Class Path and Package Names</p>
</blockquote>
<blockquote>
<p>Java classes are organized into packages that are mapped to directories in the file system. But, unlike the file system, whenever you specify a package name, you specify the whole package name and never part of it. For example, the package name for java.awt.Button is always specified as java.awt.</p>
</blockquote>
<blockquote>
<p>For example, suppose you want the JRE to find a class named Cool.class in the package utility.myapp. If the path to that directory is &#x2F;java&#x2F;MyClasses&#x2F;utility&#x2F;myapp, then you would set the class path so that it contains &#x2F;java&#x2F;MyClasses. To run that application, you could use the following java command:</p>
</blockquote>
<blockquote>
<p>java -classpath &#x2F;java&#x2F;MyClasses utility.myapp.Cool<br>When the application runs, the JVM uses the class path settings to find any other classes defined in the utility.myapp package that are used by the Cool class.</p>
</blockquote>
<blockquote>
<p>The entire package name is specified in the command. It is not possible, for example, to set the class path so it contains &#x2F;java&#x2F;MyClasses&#x2F;utility and use the command java myapp.Cool. The class would not be found.</p>
</blockquote>
<p>You might wonder what defines the package name for a class. The answer is that the package name is part of the class and cannot be modified, except by recompiling the class.</p>
<p>首先说编译:<br>查看<code>javac</code> 的帮助:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac --help</span><br><span class="line">Usage: javac &lt;options&gt; &lt;source files&gt;</span><br></pre></td></tr></table></figure>
<p>javac 的参数是:<br><code>javac+文件路径</code></p>
<p>举个例子:<br>现在在com的上一级目录上</p>
<p>下面是HelloWorld.java的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">package com.helloworld;</span><br><span class="line">  </span><br><span class="line">public class HelloWorld</span><br><span class="line">&#123;</span><br><span class="line">        static public int m = 1;</span><br><span class="line">        public int i = 1;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ls </span><br><span class="line">com</span><br><span class="line"># tree </span><br><span class="line">.</span><br><span class="line">└── com</span><br><span class="line">    └── helloworld</span><br><span class="line">        └── HelloWorld.java</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我要怎么编译com&#x2F;hellowrld&#x2F;HelloWorld.java下面的文件呢? </p>
<p>这么编译就可以了:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac com/helloworld/*.java</span><br></pre></td></tr></table></figure>

<p>然后看一下目录树,在下面多了一个<strong>class</strong>文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># tree</span><br><span class="line">.</span><br><span class="line">└── com</span><br><span class="line">    └── helloworld</span><br><span class="line">        ├── HelloWorld.class</span><br><span class="line">        └── HelloWorld.java</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>重新开始,我们看看<code>-d</code> 这个参数有什么用:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># mkdir classes</span><br><span class="line"># tree</span><br><span class="line">.</span><br><span class="line">├── classess</span><br><span class="line">└── com</span><br><span class="line">    └── helloworld</span><br><span class="line">        └── HelloWorld.java</span><br></pre></td></tr></table></figure>
<p>那么我们编译之后会在设置的<code>-d</code>的目录里面添加相关目录:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># javac -d ./classes/    com/helloworld/*.java</span><br><span class="line"># tree</span><br><span class="line">.</span><br><span class="line">├── classes</span><br><span class="line">│   └── com</span><br><span class="line">│       └── helloworld</span><br><span class="line">│           └── HelloWorld.class</span><br><span class="line">├── classess</span><br><span class="line">└── com</span><br><span class="line">    └── helloworld</span><br><span class="line">        └── HelloWorld.java</span><br></pre></td></tr></table></figure>





<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinat_30955745/article/details/84348725">https://blog.csdn.net/sinat_30955745/article/details/84348725</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/f-ck-need-u/p/8127529.html">https://www.cnblogs.com/f-ck-need-u/p/8127529.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/moveofgod/p/3809653.html">https://www.cnblogs.com/moveofgod/p/3809653.html</a></li>
<li><a target="_blank" rel="noopener" href="https://www3.ntu.edu.sg/home/ehchua/programming/java/J9c_PackageClasspath.html">https://www3.ntu.edu.sg/home/ehchua/programming/java/J9c_PackageClasspath.html</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/classpath.html">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/classpath.html#</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/4800781/how-to-compile-multiple-java-source-files-in-command-line">https://stackoverflow.com/questions/4800781/how-to-compile-multiple-java-source-files-in-command-line</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2441760/differences-between-classpath-and-sourcepath-options-of-javac">https://stackoverflow.com/questions/2441760/differences-between-classpath-and-sourcepath-options-of-javac</a></li>
<li><a target="_blank" rel="noopener" href="https://community.oracle.com/thread/1566469">https://community.oracle.com/thread/1566469</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_25665807/article/details/74747868">https://blog.csdn.net/qq_25665807/article/details/74747868</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/10/31/ast%E6%9E%84%E9%80%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/31/ast%E6%9E%84%E9%80%A0/" class="post-title-link" itemprop="url">ast构造</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-31 15:09:23" itemprop="dateCreated datePublished" datetime="2019-10-31T15:09:23+08:00">2019-10-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="抽象语法树-Abstract-Syntax-Tree"><a href="#抽象语法树-Abstract-Syntax-Tree" class="headerlink" title="抽象语法树(Abstract Syntax Tree)"></a>抽象语法树(Abstract Syntax Tree)</h2><p>上一篇简单介绍了lex和yacc</p>
<p>这次主要是介绍构造一个抽象语法树</p>
<p>比如<code>1+2+3</code>构造成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1 </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/10/22/composer%E7%9A%84psr4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/22/composer%E7%9A%84psr4/" class="post-title-link" itemprop="url">composer的psr4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-22 15:38:14" itemprop="dateCreated datePublished" datetime="2019-10-22T15:38:14+08:00">2019-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="composer的psr4"><a href="#composer的psr4" class="headerlink" title="composer的psr4"></a>composer的psr4</h1><p>我这次主要是要描述composer的psr4自动加载相关内容.php有很多历史的包袱,所以需要做很多妥协,而namespace 以及自动加载也是.</p>
<h2 id="include-和-require的大坑"><a href="#include-和-require的大坑" class="headerlink" title="include 和 require的大坑"></a>include 和 require的大坑</h2><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>include 和require的区别什么的可能还是某些面试官的问题之一,但是include和require都有一个致命的大坑,include和require一个相对路径是相对于<code>工作目录</code>的.</p>
<p>举个例子.</p>
<p>当前在index.php 的目录中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># tree</span><br><span class="line"></span><br><span class="line">test</span><br><span class="line">   ├── index.php</span><br><span class="line">   ├── relative.php</span><br><span class="line">   └── subdir</span><br><span class="line">       ├── a.php</span><br><span class="line">       └── relative.php</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>index.php</code> 的代码很简单,就是包含一个路径</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;./subdir/a.php&quot;;</span><br></pre></td></tr></table></figure>
<p>两个relative.php 文件分别输出自己的路径<br><code>subdir/relative.php</code>文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo &quot;test/subdir/relative.php&quot;</span><br></pre></td></tr></table></figure>

<p><code>relative.php</code>文件:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo &quot;test/relative.php&quot;;</span><br></pre></td></tr></table></figure>

<p>那么如果与index.php 同目录下会include哪一个呢? </p>
<p>答案是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># php index.php </span><br><span class="line">test/relative.php</span><br></pre></td></tr></table></figure>
<p>include了与index.php 同一个目录下的relative.php 文件</p>
<p>而如果你在index.php的上一层目录执行,也就是<code>test</code>目录它甚至会报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php test/index.php </span><br><span class="line">PHP Warning:  include(./subdir/a.php): failed to open stream: No such file or directory in /root/test/index.php on line 2</span><br><span class="line">PHP Warning:  include(): Failed opening &#x27;./subdir/a.php&#x27; for inclusion (include_path=&#x27;.:/usr/share/php&#x27;) in /root/test/index.php on line 2</span><br></pre></td></tr></table></figure>

<p>这一切都是因为当是相对路径的时候,调用了<code>getcwd()</code>来获取工作目录,如果你使用shell的<code>pwd</code>话也可以看自己的工作目录.</p>
<p>由于这个比较坑的特性,php的代码如果手工使用include并且还使用了相对路径,那之后就非常难以维护了.所以我们需要尽量减少使用include相对路径,因为你知道的原因,你一旦写了一个相对路径,总会有后人copy and paste你的代码,然后把这个include也复制进去了,而这就是下一个屎坑的开始.</p>
<p>所以,自动加载可以减缓这种大坑的产生,因为他可以减少手工include<code>相对路径</code>的风险,因为他们往往会这样include文件<code>include __DIR__ . &#39;aaa/bbb/ccc.php&#39;</code>,由于不是相对路径,所以会好很多.</p>
<h4 id="CLI模式与CGI-x2F-FASTCGI工作目录的不同"><a href="#CLI模式与CGI-x2F-FASTCGI工作目录的不同" class="headerlink" title="CLI模式与CGI&#x2F;FASTCGI工作目录的不同"></a>CLI模式与CGI&#x2F;FASTCGI工作目录的不同</h4><p>CLI SAPI <strong>不会</strong>将当前目录改为已运行的脚本所在的目录。</p>
<p>以下范例显示了本模块与 CGI SAPI 模块之间的不同：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// 名为 test.php 的简单测试程序</span><br><span class="line">echo getcwd(), &quot;\n&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>在使用 CGI 版本时，其输出为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/tmp</span><br><span class="line"></span><br><span class="line">$ php-cgi -f another_directory/test.php</span><br><span class="line">/tmp/another_directory</span><br></pre></td></tr></table></figure>
<p>明显可以看到 PHP 将当前目录改成了刚刚运行过的脚本所在的目录。</p>
<p>使用 CLI SAPI 模式，得到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pwd</span><br><span class="line">/tmp</span><br><span class="line"></span><br><span class="line">$ php -q another_directory/test.php</span><br><span class="line">/tmp</span><br></pre></td></tr></table></figure>
<h4 id="include-和require-的opcode和getcwd"><a href="#include-和require-的opcode和getcwd" class="headerlink" title="include 和require 的opcode和getcwd"></a>include 和require 的opcode和getcwd</h4><p>require 和include 词法分析和语法分析后,生成opcode是73,<code>ZEND_INCLUDE_OR_EVAL</code>,在include或者require之后,如果是相对路径</p>
<p>最后会调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VCWD_GETCWD(cwd, MAXPATHLEN)</span><br></pre></td></tr></table></figure>
<p>这个最后就是调用glibc 下面的<code>getcwd</code></p>
<h4 id="getcwd-系统调用"><a href="#getcwd-系统调用" class="headerlink" title="getcwd 系统调用"></a>getcwd 系统调用</h4><p>每个进程task_struct会有fs_struct 结构,这个结构体会含有<code>pwd</code> 和<code>root</code>,如果使用<code>getcwd()</code>这个函数,通过glibc会通过系统调用读取fs_struct的pwd属性并返回</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">static void get_fs_root_and_pwd_rcu(struct fs_struct *fs, struct path *root,</span><br><span class="line">				    struct path *pwd)</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">		*root = fs-&gt;root;</span><br><span class="line">		*pwd = fs-&gt;pwd;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">SYSCALL_DEFINE2(getcwd, char __user *, buf, unsigned long, size)</span><br><span class="line">&#123;</span><br><span class="line">	int error;</span><br><span class="line">	struct path pwd, root;</span><br><span class="line">	char *page = __getname();</span><br><span class="line"></span><br><span class="line">	if (!page)</span><br><span class="line">		return -ENOMEM;</span><br><span class="line"></span><br><span class="line">	rcu_read_lock();</span><br><span class="line">	get_fs_root_and_pwd_rcu(current-&gt;fs, &amp;root, &amp;pwd);  // 每个进程会关联一个fs_struct结构,fs_struct 结构有两个属性root和pwd描述了root目录和pwd目录</span><br><span class="line"></span><br><span class="line">	char *cwd = page + PATH_MAX;</span><br><span class="line">	int buflen = PATH_MAX;</span><br><span class="line"></span><br><span class="line">	prepend(&amp;cwd, &amp;buflen, &quot;\0&quot;, 1);</span><br><span class="line">	error = prepend_path(&amp;pwd, &amp;root, &amp;cwd, &amp;buflen);  </span><br><span class="line">    ...</span><br><span class="line">    copy_to_user(buf, cwd, len)                    // 将处理后的pwd 返回到用户态</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="include和require总结"><a href="#include和require总结" class="headerlink" title="include和require总结"></a>include和require总结</h4><p>include以及require如果引入<strong>相对路径</strong>的文件,那么这个相对路径都是相对于<code>getcwd()</code>,也就是当前工作目录.</p>
<p>而cgi和cli模式又有不同</p>
<ul>
<li>cli模式下的当前路径就是shell <code>pwd</code>的值</li>
<li>而cgi 这个SAPI和cli这个CLI SAPI不一样的地方在于他会帮你切换一次工作目录到第一次运行的php文件的当前目录作为工作目录.</li>
</ul>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>命名空间是什么?</p>
<p>其实就是一堆限定符.</p>
<p>为什么要有命名空间?<br>因为我们要复用别人的代码,你想引用别人的一个库,别人库里写了个<code>hello</code>函数,你也写了个<code>hello</code>函数.这就麻烦了,所以引入命名空间,只要保证大家的命名空间不一样,那样就算大家都有相同的函数名,也不会冲突了.</p>
<h2 id="自动加载"><a href="#自动加载" class="headerlink" title="自动加载"></a>自动加载</h2><p>开始说到自动加载了,自动加载.什么是自动加载呢? </p>
<p>其实就是动态include,或者叫做运行时include.</p>
<p>平时我们怎么include文件的呢? </p>
<p>就是手工include一堆文件,就像我刚才上面的例子一样.这样至少有两个风险:</p>
<ul>
<li>新手使用了相对路径include</li>
<li>得手工引入,但是include会重复引入文件,得使用<code>include_once</code> 或者<code>require_once</code></li>
</ul>
<p>就风险而言,新手使用相对路径引入的危险是非常大的.重复引入只是会校验多一点有一点性能影响而言.</p>
<h4 id="spl-autoload-register"><a href="#spl-autoload-register" class="headerlink" title="spl_autoload_register"></a>spl_autoload_register</h4><p><code>spl_autoload_*</code>这一类的函数都是php自动加载的核心函数,实现自动加载则是依赖<code>spl_autoload_register</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/* &#123;&#123;&#123; proto bool spl_autoload_register([mixed autoload_function [, bool throw [, bool prepend]]])</span><br><span class="line"> Register given function as __autoload() implementation */</span><br><span class="line">PHP_FUNCTION(spl_autoload_register)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">		if (zend_hash_add_mem(SPL_G(autoload_functions), lc_name, &amp;alfi, sizeof(autoload_func_info)) == NULL) &#123;</span><br><span class="line">			...</span><br><span class="line">		&#125;</span><br><span class="line">		... </span><br><span class="line">&#125; /* &#125;&#125;&#125; */</span><br></pre></td></tr></table></figure>
<p>然后相关的调用会在<code>zend_hash_exists(EG(class_table), lc_name)</code> 判断是否在全局的<code>EG(class_table)</code> 里面<br>下面的<code>spl_autoload_call</code>是一个例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(spl_autoload_call)</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">	if (SPL_G(autoload_functions)) &#123;     // spl_autoload_register 放进去的 SPL_G(autoload_functions)</span><br><span class="line">		int l_autoload_running = SPL_G(autoload_running);</span><br><span class="line">		SPL_G(autoload_running) = 1;</span><br><span class="line">		lc_name = zend_string_alloc(Z_STRLEN_P(class_name), 0);</span><br><span class="line">		zend_str_tolower_copy(ZSTR_VAL(lc_name), Z_STRVAL_P(class_name), Z_STRLEN_P(class_name));</span><br><span class="line">		zend_hash_internal_pointer_reset_ex(SPL_G(autoload_functions), &amp;pos);</span><br><span class="line">		while (zend_hash_get_current_key_ex(SPL_G(autoload_functions), &amp;func_name, &amp;num_idx, &amp;pos) == HASH_KEY_IS_STRING) &#123;   // 循环回调函数</span><br><span class="line">			alfi = zend_hash_get_current_data_ptr_ex(SPL_G(autoload_functions), &amp;pos);</span><br><span class="line">			zend_call_method(Z_ISUNDEF(alfi-&gt;obj)? NULL : &amp;alfi-&gt;obj, alfi-&gt;ce, &amp;alfi-&gt;func_ptr, ZSTR_VAL(func_name), ZSTR_LEN(func_name), retval, 1, class_name, NULL);    // 调用注册的回调函数</span><br><span class="line"></span><br><span class="line">			if (zend_hash_exists(EG(class_table), lc_name)) &#123;   // 回调找到了类名,则跳出循环</span><br><span class="line"></span><br><span class="line">				break;</span><br><span class="line">			&#125;</span><br><span class="line">			zend_hash_move_forward_ex(SPL_G(autoload_functions), &amp;pos);</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">	&#125; </span><br><span class="line">	..</span><br><span class="line">&#125; /* &#125;&#125;&#125; */</span><br></pre></td></tr></table></figure>
<p>自动加载流程其实很简单<br>自动加载的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// test.php</span><br><span class="line">spl_autoload_register(function ($class) &#123;</span><br><span class="line">    include  &quot;$class&quot; . &#x27;.php&#x27;;</span><br><span class="line">&#125;);</span><br><span class="line">$obj = new ClassA();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以及类<code>ClassA.php</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class ClassA&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>下面是堆栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  zif_spl_autoload_call (execute_data=0x7fffef61e0a0, return_value=0x7fffffffa2f0) at /home/dinosaur/Downloads/php-7.2.2/ext/spl/php_spl.c:393</span><br><span class="line">#1  0x0000000000932807 in zend_call_function (fci=0x7fffffffa330, fci_cache=0x7fffffffa300) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_execute_API.c:833</span><br><span class="line">#2  0x0000000000933000 in zend_lookup_class_ex (name=0x7fffe6920b58, key=0x7fffe70e63f0, use_autoload=1) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_execute_API.c:990</span><br><span class="line">#3  0x0000000000933dbd in zend_fetch_class_by_name (class_name=0x7fffe6920b58, key=0x7fffe70e63f0, fetch_type=512) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_execute_API.c:1425</span><br><span class="line">#4  0x00000000009b7e46 in ZEND_NEW_SPEC_CONST_HANDLER () at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:3211</span><br><span class="line">#5  0x0000000000a380a4 in execute_ex (ex=0x7fffef61e030) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:59929</span><br><span class="line">#6  0x0000000000a3d0ab in zend_execute (op_array=0x7fffef683300, return_value=0x0) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:63760</span><br><span class="line">#7  0x000000000094cd22 in zend_execute_scripts (type=8, retval=0x0, file_count=3) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend.c:1496</span><br><span class="line">#8  0x00000000008b0b4a in php_execute_script (primary_file=0x7fffffffcaa0) at /home/dinosaur/Downloads/php-7.2.2/main/main.c:2590</span><br><span class="line">#9  0x0000000000a3fd23 in do_cli (argc=2, argv=0x1441a60) at /home/dinosaur/Downloads/php-7.2.2/sapi/cli/php_cli.c:1011</span><br><span class="line">#10 0x0000000000a40ee0 in main (argc=2, argv=0x1441a60) at /home/dinosaur/Downloads/php-7.2.2/sapi/cli/php_cli.c:1404</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>所以整个自动加载的核心流程就是在查找类的时候会去调用<code>spl_autoload_call</code>，这个函数则会回调注册的自动加载函数，直到遍历所有的回调函数都没有找到或者在某个遍历的时候找到了直接返回。</p>
<h2 id="psr规范与psr4"><a href="#psr规范与psr4" class="headerlink" title="psr规范与psr4"></a>psr规范与psr4</h2><p><code>psr</code>是<code>PHP Standards Recommendations</code>的简称,而psr4和psr0有都是和自动加载相关的内容.</p>
<p>其实就是规定了一个简单的替换</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\Aura\Web\Response\Status	Aura\Web	/path/to/aura-web/src/	/path/to/aura-web/src/Response/Status.php</span><br></pre></td></tr></table></figure>
<p>psr4规定了我们如何去加载一个文件: 将完全限定名用前缀地址替换,后面则是后面的文件.<br>举个例子:<br>你要加载的类是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\Aura\Web\Response\Status</span><br></pre></td></tr></table></figure>
<p>那么你可以使用<code>Aura\Web</code> 映射<code>/path/to/aura-web/src/</code>,那么类<code>\Aura\Web\Response\Status</code>就会去<code>/path/to/aura-web/src/Response/Status.php</code>文件找</p>
<p>可以说有点像nginx的路由配置:<br>下面是nginx的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /images/ &#123;</span><br><span class="line">　　　　# 匹配任何已 /images/ 开头的任何查询并且停止搜索。任何正则表达式将不会被测试。</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么上面的<code>\Aura\Web\Response\Status</code>的psr4 有点像这样:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location ^~ /Aura/Web/ &#123;</span><br><span class="line">　　　　root /path/to/aura-web/src/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/7378814/are-php-include-paths-relative-to-the-file-or-the-calling-code">https://stackoverflow.com/questions/7378814/are-php-include-paths-relative-to-the-file-or-the-calling-code</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.die.net/man/3/getcwd">https://linux.die.net/man/3/getcwd</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.die.net/man/1/pwd">https://linux.die.net/man/1/pwd</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wuheshi/article/details/52872463">https://blog.csdn.net/wuheshi/article/details/52872463</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/769344359/reading-php7-code/blob/master/include_or_require.md">https://github.com/769344359/reading-php7-code/blob/master/include_or_require.md</a></li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/features.commandline.php">https://www.php.net/manual/zh/features.commandline.php</a></li>
<li><a target="_blank" rel="noopener" href="https://www.php.net/manual/zh/language.oop5.autoload.php">https://www.php.net/manual/zh/language.oop5.autoload.php</a></li>
<li><a target="_blank" rel="noopener" href="https://www.php-fig.org/psr/">https://www.php-fig.org/psr/</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/23/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><span class="page-number current">24</span><a class="page-number" href="/page/25/">25</a><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/25/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">dinosaur</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">256</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/769344359" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;769344359" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/thedinosaurmail@gmail.com" title="E-Mail → thedinosaurmail@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dinosaur</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
