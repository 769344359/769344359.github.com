<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shakudada.xyz","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"79C1GXGOC6","apiKey":"225fa4bf2bc37c3e46a671682674fe37","indexName":"my-hexo-blog","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="dinosaur">
<meta property="og:url" content="https://shakudada.xyz/page/25/index.html">
<meta property="og:site_name" content="dinosaur">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="dinosaur">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shakudada.xyz/page/25/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>dinosaur</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dinosaur</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/10/19/php-try-catch/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/19/php-try-catch/" class="post-title-link" itemprop="url">php7 异常、错误以及相关坑</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-19 14:02:25" itemprop="dateCreated datePublished" datetime="2019-10-19T14:02:25+08:00">2019-10-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="php7-异常、错误以及相关坑"><a href="#php7-异常、错误以及相关坑" class="headerlink" title="php7 异常、错误以及相关坑"></a>php7 异常、错误以及相关坑</h1><p>php 的坑非常之多，有高低版本的，有历史包袱类的。也有与其他语言不一致导致的知识迁移导致的坑。</p>
<h2 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h2><p> <a target="_blank" rel="noopener" href="https://www.php.net/manual/en/language.errors.php7.php">throwable</a></p>
<blockquote>
<p>PHP 7 changes how most errors are reported by PHP. Instead of reporting errors through the traditional error reporting mechanism used by PHP 5, most errors are now reported by throwing Error exceptions.</p>
</blockquote>
<blockquote>
<p>(人肉机翻)php 7 改变了php大多数的errors的警告提示方式。和php 5 传统的error　reporting　机制不同，php 的大多数错误通过抛出错误异常来警告提示。</p>
</blockquote>
<h2 id="填坑开始"><a href="#填坑开始" class="headerlink" title="填坑开始"></a>填坑开始</h2><h3 id="例子１"><a href="#例子１" class="headerlink" title="例子１"></a>例子１</h3><ul>
<li>php 版本７,除以０的错误会变成异常<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// test.php</span><br><span class="line">try &#123;</span><br><span class="line">   echo 1%0;</span><br><span class="line">&#125; catch (DivisionByZeroError $e) &#123;</span><br><span class="line">    echo &quot;bbb&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
然后执行<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php test.php </span><br><span class="line">bbb</span><br></pre></td></tr></table></figure>
输出<code>bbb</code> ,也就是被try catch 住了。</li>
</ul>
<p>那么我们先看php 是怎么catch 住这个错误的</p>
<p>堆栈如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, zend_throw_exception_ex (exception_ce=0x14cfe70, code=0, format=0x1087ea4 &quot;Modulo by zero&quot;) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_exceptions.c:913</span><br><span class="line">913	&#123;</span><br><span class="line">(gdb) bt</span><br><span class="line">#0  zend_throw_exception_ex (exception_ce=0x14cfe70, code=0, format=0x1087ea4 &quot;Modulo by zero&quot;) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_exceptions.c:913</span><br><span class="line">#1  0x00000000009b9feb in ZEND_MOD_SPEC_CONST_CONST_HANDLER () at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:4270</span><br><span class="line">#2  0x0000000000a381e4 in execute_ex (ex=0x7fffef61e030) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:59989</span><br><span class="line">#3  0x0000000000a3d0ab in zend_execute (op_array=0x7fffef684300, return_value=0x0) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:63760</span><br><span class="line">#4  0x000000000094cd22 in zend_execute_scripts (type=8, retval=0x0, file_count=3) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend.c:1496</span><br><span class="line">#5  0x00000000008b0b4a in php_execute_script (primary_file=0x7fffffffca10) at /home/dinosaur/Downloads/php-7.2.2/main/main.c:2590</span><br><span class="line">#6  0x0000000000a3fd23 in do_cli (argc=2, argv=0x1441f40) at /home/dinosaur/Downloads/php-7.2.2/sapi/cli/php_cli.c:1011</span><br><span class="line">#7  0x0000000000a40ee0 in main (argc=2, argv=0x1441f40) at /home/dinosaur/Downloads/php-7.2.2/sapi/cli/php_cli.c:1404</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/nickbai/php7/363302">相关阅读</a></p>
<h3 id="例子二"><a href="#例子二" class="headerlink" title="例子二"></a>例子二</h3><p>php 版本７</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">try &#123;</span><br><span class="line">   echo 1/0;      // 取余改成了除法</span><br><span class="line">&#125; catch (DivisionByZeroError $e) &#123;</span><br><span class="line">    echo &quot;bbb&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Warning: Division by zero in /home/dinosaur/test/test.php on line 3</span><br><span class="line">INF</span><br></pre></td></tr></table></figure>
<p>发现了不一样了吗？</p>
<p>①　抛了warning 没有被try catch 住</p>
<p>②　php 脚本继续执行，(并输出INF)</p>
<p>我们看看堆栈：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  zend_error (type=2, format=0x107dcfc &quot;Division by zero&quot;) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend.c:1105</span><br><span class="line">#1  0x000000000093fb5b in div_function (result=0x7fffef61e090, op1=0x7fffe70e61c0, op2=0x7fffe70e61d0) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_operators.c:1173</span><br><span class="line">#2  0x00000000009a82a0 in fast_div_function (result=0x7fffef61e090, op1=0x7fffe70e61c0, op2=0x7fffe70e61d0) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_operators.h:738</span><br><span class="line">#3  0x00000000009b9f22 in ZEND_DIV_SPEC_CONST_CONST_HANDLER () at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:4251</span><br><span class="line">#4  0x0000000000a381d4 in execute_ex (ex=0x7fffef61e030) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:59986</span><br><span class="line">#5  0x0000000000a3d0ab in zend_execute (op_array=0x7fffef684300, return_value=0x0) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend_vm_execute.h:63760</span><br><span class="line">#6  0x000000000094cd22 in zend_execute_scripts (type=8, retval=0x0, file_count=3) at /home/dinosaur/Downloads/php-7.2.2/Zend/zend.c:1496</span><br><span class="line">#7  0x00000000008b0b4a in php_execute_script (primary_file=0x7fffffffca10) at /home/dinosaur/Downloads/php-7.2.2/main/main.c:2590</span><br><span class="line">#8  0x0000000000a3fd23 in do_cli (argc=2, argv=0x1441f40) at /home/dinosaur/Downloads/php-7.2.2/sapi/cli/php_cli.c:1011</span><br><span class="line">#9  0x0000000000a40ee0 in main (argc=2, argv=0x1441f40) at /home/dinosaur/Downloads/php-7.2.2/sapi/cli/php_cli.c:1404</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>zend_error 翻到最底下就是<code>write</code> 系统调用了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (Z_LVAL_P(op2) == 0) &#123;</span><br><span class="line">	zend_error(E_WARNING, &quot;Division by zero&quot;);</span><br><span class="line">	ZVAL_DOUBLE(result, ((double) Z_LVAL_P(op1) / (double) Z_LVAL_P(op2)));</span><br><span class="line">	return SUCCESS;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>zend_error</code>后就<code>return</code> 了，所以后面的程序可以继续执行</p>
<h3 id="对比总结"><a href="#对比总结" class="headerlink" title="对比总结"></a>对比总结</h3><p><code>1/0</code> 不会被抛出异常，会有warning　并继续执行　</p>
<p>坑点在于：</p>
<ul>
<li>不是所有的error都能被catch</li>
<li>没有被catch 住的话会继续执行</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/10/18/lex%E5%92%8Cyacc%E4%BE%8B%E5%AD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/18/lex%E5%92%8Cyacc%E4%BE%8B%E5%AD%90/" class="post-title-link" itemprop="url">lex和yacc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-18 15:15:22" itemprop="dateCreated datePublished" datetime="2019-10-18T15:15:22+08:00">2019-10-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h2><p>lex主要是用来做词法分析用的,简单来说就是分词.<br>每次调用yylex都会返回一个词,lucence的标准分词器也是用lex一类的包分好词的.<br>Lucene的分词分好之后会构造倒排索引.</p>
<h3 id="lex例子"><a href="#lex例子" class="headerlink" title="lex例子"></a>lex例子</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">%&#123;</span><br><span class="line">%&#125;</span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">end  &#123; ECHO ;return 2 ;&#125;</span><br><span class="line"></span><br><span class="line">aaa &#123;ECHO ;&#125;</span><br><span class="line"></span><br><span class="line">.|\N &#123;&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">int main()&#123;</span><br><span class="line">    yylex();</span><br><span class="line">&#125;</span><br><span class="line">int yywrap()&#123;</span><br><span class="line"> return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lex test.lex</span><br></pre></td></tr></table></figure>

<h3 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h3><p>语法分析是什么? </p>
<p>语法分析是一个特别的规则系统,或者说.语法分析是一个图灵机,可以表达正则表达式无法表达的内容</p>
<p>语法分析如何选择?<br>语法分析的一个关键问题是如何在多个产生式中选择一个产生式,有且仅有一个产生式.</p>
<p>bison是yacc的gun版本<br>和flex一样,bison也是分成3个部分,使用<code>%%</code>分割<br>Linux下面开源的yacc版本为bison  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">...定义段...</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">...规则段...</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">...用户子例程段...</span><br></pre></td></tr></table></figure>
<p>第一个部分主要是c的相关声明和token声明,非终结符的声明等<br>第二部分主要是产生式和语义动作<br>第三部分则是执行的相关c函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">/* Infix notation calculator--calc */</span><br><span class="line">  </span><br><span class="line">%&#123;</span><br><span class="line">#define YYSTYPE double</span><br><span class="line">#include &lt;math.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">/* BISON Declarations */</span><br><span class="line">%token NUM</span><br><span class="line">%left &#x27;-&#x27; &#x27;+&#x27;</span><br><span class="line">%left &#x27;*&#x27; &#x27;/&#x27;</span><br><span class="line">%left NEG     /* negation--unary minus */</span><br><span class="line">%right &#x27;^&#x27;    /* exponentiation        */</span><br><span class="line"></span><br><span class="line">/* Grammar follows */</span><br><span class="line">%%</span><br><span class="line">input:    /* empty string */</span><br><span class="line">             | input line</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">line:     &#x27;\n&#x27;</span><br><span class="line">            | exp &#x27;\n&#x27;  &#123; printf (&quot;\t%.10g\n&quot;, $1); &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">exp:      NUM                &#123; $$ = $1;         &#125;</span><br><span class="line">           | exp &#x27;+&#x27; exp        &#123; $$ = $1 + $3;    &#125;</span><br><span class="line">        | exp &#x27;-&#x27; exp        &#123; $$ = $1 - $3;    &#125;</span><br><span class="line">        | exp &#x27;*&#x27; exp        &#123; $$ = $1 * $3;    &#125;</span><br><span class="line">        | exp &#x27;/&#x27; exp        &#123; $$ = $1 / $3;    &#125;</span><br><span class="line">        | &#x27;-&#x27; exp  %prec NEG &#123; $$ = -$2;        &#125;</span><br><span class="line">        | exp &#x27;^&#x27; exp        &#123; $$ = pow ($1, $3); &#125;</span><br><span class="line">        | &#x27;(&#x27; exp &#x27;)&#x27;        &#123; $$ = $2;         &#125;</span><br><span class="line">;</span><br><span class="line">%%</span><br><span class="line">#include &lt;ctype.h&gt;</span><br><span class="line">main ()</span><br><span class="line">&#123;</span><br><span class="line">  yyparse ();</span><br><span class="line">&#125;</span><br><span class="line">yyerror (s)  /* Called by yyparse on error */</span><br><span class="line">     char *s;</span><br><span class="line">&#123;</span><br><span class="line">  printf (&quot;%s\n&quot;, s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">yylex ()</span><br><span class="line">&#123;</span><br><span class="line">  int c;</span><br><span class="line"></span><br><span class="line">  /* skip white space  */</span><br><span class="line">  while ((c = getchar ()) == &#x27; &#x27; || c == &#x27;\t&#x27;)</span><br><span class="line">    ;</span><br><span class="line">  /* process numbers   */</span><br><span class="line">  if (c == &#x27;.&#x27; || isdigit (c))</span><br><span class="line">    &#123;</span><br><span class="line">      ungetc (c, stdin);</span><br><span class="line">      scanf (&quot;%lf&quot;, &amp;yylval);</span><br><span class="line">      return NUM;</span><br><span class="line">    &#125;</span><br><span class="line">  /* return end-of-file  */</span><br><span class="line">  if (c == EOF)</span><br><span class="line">    return 0;</span><br><span class="line">  /* return single chars */</span><br><span class="line">  return c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成并编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bison bison parse.y</span><br><span class="line">gcc parse.tab.c -lm</span><br><span class="line"># ./a.out </span><br><span class="line">3+2</span><br><span class="line">5</span><br></pre></td></tr></table></figure>





<h4 id="下面描述常用的变量的使用"><a href="#下面描述常用的变量的使用" class="headerlink" title="下面描述常用的变量的使用"></a>下面描述常用的变量的使用</h4><h5 id="token"><a href="#token" class="headerlink" title="%token"></a>%token</h5><p><code>%token</code>  放在定义段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%token NUMBER</span><br></pre></td></tr></table></figure>
<p>会在生成c文件的时候变成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define NUMBER 258 </span><br></pre></td></tr></table></figure>
<p>所以可以理解<code>%token</code>是一种简写,可以减少<code>#define</code>的使用</p>
<h5 id="YYSTYPE"><a href="#YYSTYPE" class="headerlink" title="YYSTYPE"></a>YYSTYPE</h5><blockquote>
<p>In real parsers, the values of different symbols use different data types, e.g.,<br>int and double for numeric symbols, char * for strings, and pointers to<br>structures for higher level symbols. If you have multiple value types, you<br>have to list all the value types used in a parser so that yacc can create a C<br>union typedef called YYSTYPE to contain them. (Fortunately, yacc gives<br>you a lot of help ensuring that you use the right value type for each<br>symbol .) </p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/germanoa/compiladores/blob/master/doc/ebook/Lex%20and%20%20YACC%20-%202nd%20Edition%20-%20Levine,%20Mason%20Brown..pdf">引用自lex &amp; yacc</a></p>
<p>YYSTYPE 是一个类型的宏定义,目的是给终结符合非终结符确定类型的集合</p>
<p><code>%union</code>  是YYSTYPE定义的简写 </p>
<p><code>%token</code> 是定义词素枚举值的简写</p>
<p><code>%type</code> 是非终结符的类型定义的简写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">%union &#123;</span><br><span class="line">  double dval;</span><br><span class="line">  int vblno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%token NUMBER</span><br></pre></td></tr></table></figure>
<p>使用<code>--defines</code>参数生成头文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># bison --defines test.y</span><br></pre></td></tr></table></figure>
<p>最后会生成如下的文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">enum yytokentype&#123;</span><br><span class="line">    NUMBER = 258</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">union YYSTYPE&#123;</span><br><span class="line">  double dval;</span><br><span class="line">  int vblno;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>如果给token 添加类型的话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%token &lt;vblno&gt; NAME</span><br><span class="line">%token &lt;dval&gt; NUMBER</span><br><span class="line">%type &lt;dval&gt; expression</span><br></pre></td></tr></table></figure>
<blockquote>
<p>In action code, yacc automatically qualifies symbol value references<br>with the appropriate field’name, e.g., if the third symbol is a NUMBER,<br>a reference to $3 acts like $3,dval.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/germanoa/compiladores/blob/master/doc/ebook/Lex%20and%20%20YACC%20-%202nd%20Edition%20-%20Levine,%20Mason%20Brown..pdf">引用自lex &amp; yacc</a></p>
<p>在语义动作的代码里面,如果第三个元素是NUMBER 的话, <code>$3</code>等价于<code>$3.dval</code> </p>
<p>相关阅读</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1fe5a61fd9dc">https://www.jianshu.com/p/1fe5a61fd9dc</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/bison/manual/html_node/A-Complete-C_002b_002b-Example.html">https://www.gnu.org/software/bison/manual/html_node/A-Complete-C_002b_002b-Example.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/germanoa/compiladores/blob/master/doc/ebook/Lex%20and%20%20YACC%20-%202nd%20Edition%20-%20Levine,%20Mason%20Brown..pdf">https://github.com/germanoa/compiladores/blob/master/doc/ebook/Lex%20and%20%20YACC%20-%202nd%20Edition%20-%20Levine,%20Mason%20Brown..pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://linux.101hacks.com/unix/bison/">https://linux.101hacks.com/unix/bison/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.gnu.org/software/bison/manual/bison.html">https://www.gnu.org/software/bison/manual/bison.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/10/13/https-tls-ssl/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/13/https-tls-ssl/" class="post-title-link" itemprop="url">https_tls_ssl</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-13 22:06:21" itemprop="dateCreated datePublished" datetime="2019-10-13T22:06:21+08:00">2019-10-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近找了个华为云的vps,想做个简单的网址，于是一番注册域名和http证书。</p>
<p>结过弄了很久发现居然访问不了。</p>
<p>其实原因是没有备案，我的证书配置是正常的。</p>
<h2 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h2><h3 id="通过curl-定位"><a href="#通过curl-定位" class="headerlink" title="通过curl 定位"></a>通过curl 定位</h3><p>直接<code>curl -v url</code>可以看到详细的握手过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">./curl https://gitlab.shakudada.xyz -v</span><br><span class="line">* STATE: INIT =&gt; CONNECT handle 0x1a23898; line 1491 (connection #-5000)</span><br><span class="line">* Added connection 0. The cache now contains 1 members</span><br><span class="line">* STATE: CONNECT =&gt; WAITRESOLVE handle 0x1a23898; line 1532 (connection #0)</span><br><span class="line">*   Trying 139.9.222.124:443...</span><br><span class="line">* TCP_NODELAY set</span><br><span class="line">* STATE: WAITRESOLVE =&gt; WAITCONNECT handle 0x1a23898; line 1611 (connection #0)</span><br><span class="line">* Connected to gitlab.shakudada.xyz (139.9.222.124) port 443 (#0)</span><br><span class="line">* STATE: WAITCONNECT =&gt; SENDPROTOCONNECT handle 0x1a23898; line 1667 (connection #0)</span><br><span class="line">* Marked for [keep alive]: HTTP default</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* Cipher selection: ALL:!EXPORT:!EXPORT40:!EXPORT56:!aNULL:!LOW:!RC4:@STRENGTH</span><br><span class="line">* successfully set certificate verify locations:</span><br><span class="line">*   CAfile: /etc/ssl/certs/ca-certificates.crt</span><br><span class="line">  CApath: none</span><br><span class="line">* TLSv1.2 (OUT), TLS header, Certificate Status (22):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* STATE: SENDPROTOCONNECT =&gt; PROTOCONNECT handle 0x1a23898; line 1682 (connection #0)</span><br><span class="line">* error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol</span><br><span class="line">* Marked for [closure]: Failed HTTPS connection</span><br><span class="line">* multi_done</span><br><span class="line">* Closing connection 0</span><br><span class="line">* The cache now contains 0 members</span><br><span class="line">* Expire cleared (transfer 0x1a23898)</span><br><span class="line">curl: (35) error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol</span><br><span class="line">dinosaur@dinosaur-X550VXK:~/curl/mycurl/bin$</span><br></pre></td></tr></table></figure>

<p>在<code>client hello</code> 后就失败了，所以直接tcpdump 看看包数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i wlp3s0  host 139.9.222.124 and  port 443 -A -X</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中<code>139.9.222.124</code>就是我那没有备案的ip</p>
<p>以下是抓包，去掉了开始的tcp的三次握手</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">22:22:23.280367 IP 192.168.1.106.33170 &gt; 139.9.222.124.https: Flags [P.], seq 1:518, ack 1, win 229, options [nop,nop,TS val 434651673 ecr 3365805465], length 517</span><br><span class="line">	0x0000:  4500 0239 15ab 4000 4006 f77b c0a8 016a  E..9..@.@..&#123;...j</span><br><span class="line">	0x0010:  8b09 de7c 8192 01bb f6ab 981d 4d9a ceb8  ...|........M...</span><br><span class="line">	0x0020:  8018 00e5 22f2 0000 0101 080a 19e8 4219  ....&quot;.........B.</span><br><span class="line">	0x0030:  c89e 1d99 1603 0102 0001 0001 fc03 0304  ................</span><br><span class="line">	0x0040:  6e2a ea14 6844 e2e1 db8c 1ee3 3582 e33f  n*..hD......5..?</span><br><span class="line">	0x0050:  9128 2ad2 cd1c bac2 1e70 dd4f 6587 d700  .(*......p.Oe...</span><br><span class="line">	0x0060:  009e c030 c02c c028 c024 c014 c00a 00a5  ...0.,.(.$......</span><br><span class="line">	0x0070:  00a3 00a1 009f 006b 006a 0069 0068 0039  .......k.j.i.h.9</span><br><span class="line">	0x0080:  0038 0037 0036 0088 0087 0086 0085 c032  .8.7.6.........2</span><br><span class="line">	0x0090:  c02e c02a c026 c00f c005 009d 003d 0035  ...*.&amp;.......=.5</span><br><span class="line">	0x00a0:  0084 c02f c02b c027 c023 c013 c009 00a4  .../.+.&#x27;.#......</span><br><span class="line">	0x00b0:  00a2 00a0 009e 0067 0040 003f 003e 0033  .......g.@.?.&gt;.3</span><br><span class="line">	0x00c0:  0032 0031 0030 009a 0099 0098 0097 0045  .2.1.0.........E</span><br><span class="line">	0x00d0:  0044 0043 0042 c031 c02d c029 c025 c00e  .D.C.B.1.-.).%..</span><br><span class="line">	0x00e0:  c004 009c 003c 002f 0096 0041 c012 c008  .....&lt;./...A....</span><br><span class="line">	0x00f0:  0016 0013 0010 000d c00d c003 000a 00ff  ................</span><br><span class="line">	0x0100:  0100 0135 0000 0019 0017 0000 1467 6974  ...5.........git</span><br><span class="line">	0x0110:  6c61 622e 7368 616b 7564 6164 612e 7879  lab.shakudada.xy</span><br><span class="line">	0x0120:  7a00 0b00 0403 0001 0200 0a00 1c00 1a00  z...............</span><br><span class="line">	0x0130:  1700 1900 1c00 1b00 1800 1a00 1600 0e00  ................</span><br><span class="line">	0x0140:  0d00 0b00 0c00 0900 0a00 0d00 2000 1e06  ................</span><br><span class="line">	0x0150:  0106 0206 0305 0105 0205 0304 0104 0204  ................</span><br><span class="line">	0x0160:  0303 0103 0203 0302 0102 0202 0300 0f00  ................</span><br><span class="line">	0x0170:  0101 3374 0000 0010 000b 0009 0868 7474  ..3t.........htt</span><br><span class="line">	0x0180:  702f 312e 3100 1500 b000 0000 0000 0000  p/1.1...........</span><br><span class="line">	0x0190:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x01a0:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x01b0:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x01c0:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x01d0:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x01e0:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x01f0:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x0200:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x0210:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x0220:  0000 0000 0000 0000 0000 0000 0000 0000  ................</span><br><span class="line">	0x0230:  0000 0000 0000 0000 00                   .........</span><br><span class="line">22:22:23.292507 IP 139.9.222.124.https &gt; 192.168.1.106.33170: Flags [FP.], seq 1:650, ack 518, win 8192, length 649</span><br><span class="line">	0x0000:  4500 02b1 15ac 4000 f606 4102 8b09 de7c  E.....@...A....|</span><br><span class="line">	0x0010:  c0a8 016a 01bb 8192 4d9a ceb8 f6ab 9a22  ...j....M......&quot;</span><br><span class="line">	0x0020:  5019 2000 d25b 0000 4854 5450 2f31 2e31  P....[..HTTP/1.1</span><br><span class="line">	0x0030:  2034 3033 2046 6f72 6269 6464 656e 0a43  .403.Forbidden.C</span><br><span class="line">	0x0040:  6f6e 7465 6e74 2d54 7970 653a 2074 6578  ontent-Type:.tex</span><br><span class="line">	0x0050:  742f 6874 6d6c 3b20 6368 6172 7365 743d  t/html;.charset=</span><br><span class="line">	0x0060:  7574 662d 380a 5365 7276 6572 3a20 4144  utf-8.Server:.AD</span><br><span class="line">	0x0070:  4d2f 322e 312e 310a 436f 6e6e 6563 7469  M/2.1.1.Connecti</span><br><span class="line">	0x0080:  6f6e 3a20 636c 6f73 650a 436f 6e74 656e  on:.close.Conten</span><br><span class="line">	0x0090:  742d 4c65 6e67 7468 3a20 3533 300a 0a3c  t-Length:.530..&lt;</span><br><span class="line">	0x00a0:  6874 6d6c 3e0a 3c68 6561 643e 0a3c 6d65  html&gt;.&lt;head&gt;.&lt;me</span><br><span class="line">	0x00b0:  7461 2068 7474 702d 6571 7569 763d 2243  ta.http-equiv=&quot;C</span><br><span class="line">	0x00c0:  6f6e 7465 6e74 2d54 7970 6522 2063 6f6e  ontent-Type&quot;.con</span><br><span class="line">	0x00d0:  7465 6e74 3d22 7465 7874 6d6c 3b63 6861  tent=&quot;textml;cha</span><br><span class="line">	0x00e0:  7273 6574 3d47 4232 3331 3222 202f 3e0a  rset=GB2312&quot;./&gt;.</span><br><span class="line">	0x00f0:  2020 203c 7374 796c 653e 626f 6479 7b62  ...&lt;style&gt;body&#123;b</span><br><span class="line">	0x0100:  6163 6b67 726f 756e 642d 636f 6c6f 723a  ackground-color:</span><br><span class="line">	0x0110:  2346 4646 4646 467d 3c2f 7374 796c 653e  #FFFFFF&#125;&lt;/style&gt;</span><br><span class="line">	0x0120:  200a 3c74 6974 6c65 3ee9 9d9e e6b3 95e9  ..&lt;title&gt;.......</span><br><span class="line">	0x0130:  98bb e696 ad32 3334 3c2f 7469 746c 653e  .....234&lt;/title&gt;</span><br><span class="line">	0x0140:  0a20 203c 7363 7269 7074 206c 616e 6775  ...&lt;script.langu</span><br><span class="line">	0x0150:  6167 653d 226a 6176 6173 6372 6970 7422  age=&quot;javascript&quot;</span><br><span class="line">	0x0160:  2074 7970 653d 2274 6578 742f 6a61 7661  .type=&quot;text/java</span><br><span class="line">	0x0170:  7363 7269 7074 223e 0a20 2020 2020 2020  script&quot;&gt;........</span><br><span class="line">	0x0180:  2020 7769 6e64 6f77 2e6f 6e6c 6f61 6420  ..window.onload.</span><br><span class="line">	0x0190:  3d20 6675 6e63 7469 6f6e 2028 2920 7b20  =.function.().&#123;.</span><br><span class="line">	0x01a0:  0a20 2020 2020 2020 2020 2020 646f 6375  ............docu</span><br><span class="line">	0x01b0:  6d65 6e74 2e67 6574 456c 656d 656e 7442  ment.getElementB</span><br><span class="line">	0x01c0:  7949 6428 226d 6169 6e46 7261 6d65 2229  yId(&quot;mainFrame&quot;)</span><br><span class="line">	0x01d0:  2e73 7263 3d20 2268 7474 703a 2f2f 3131  .src=.&quot;http://11</span><br><span class="line">	0x01e0:  342e 3131 352e 3139 322e 3234 363a 3930  4.115.192.246:90</span><br><span class="line">	0x01f0:  3830 2f65 7272 6f72 2e68 746d 6c22 3b0a  80/error.html&quot;;.</span><br><span class="line">	0x0200:  2020 2020 2020 2020 2020 2020 7d0a 3c2f  ............&#125;.&lt;/</span><br><span class="line">	0x0210:  7363 7269 7074 3e20 2020 0a3c 2f68 6561  script&gt;....&lt;/hea</span><br><span class="line">	0x0220:  643e 0a20 203c 626f 6479 3e0a 2020 2020  d&gt;...&lt;body&gt;.....</span><br><span class="line">	0x0230:  3c69 6672 616d 6520 7374 796c 653d 2277  &lt;iframe.style=&quot;w</span><br><span class="line">	0x0240:  6964 7468 3a31 3030 253b 2068 6569 6768  idth:100%;.heigh</span><br><span class="line">	0x0250:  743a 3130 3025 3b22 2069 643d 226d 6169  t:100%;&quot;.id=&quot;mai</span><br><span class="line">	0x0260:  6e46 7261 6d65 2220 7372 633d 2222 2066  nFrame&quot;.src=&quot;&quot;.f</span><br><span class="line">	0x0270:  7261 6d65 626f 7264 6572 3d22 3022 2073  rameborder=&quot;0&quot;.s</span><br><span class="line">	0x0280:  6372 6f6c 6c69 6e67 3d22 6e6f 223e 3c2f  crolling=&quot;no&quot;&gt;&lt;/</span><br><span class="line">	0x0290:  6966 7261 6d65 3e0a 2020 2020 3c2f 626f  iframe&gt;.....&lt;/bo</span><br><span class="line">	0x02a0:  6479 3e0a 2020 2020 2020 3c2f 6874 6d6c  dy&gt;.......&lt;/html</span><br><span class="line">	0x02b0:  3e                                       &gt;</span><br><span class="line">22:22:23.292552 IP 192.168.1.106.33170 &gt; 139.9.222.124.https: Flags [.], ack 651, win 239, options [nop,nop,TS val 434651685 ecr 3365805465], length 0</span><br><span class="line">	0x0000:  4500 0034 15ac 4000 4006 f97f c0a8 016a  E..4..@.@......j</span><br><span class="line">	0x0010:  8b09 de7c 8192 01bb f6ab 9a22 4d9a d142  ...|.......&quot;M..B</span><br><span class="line">	0x0020:  8010 00ef d4f7 0000 0101 080a 19e8 4225  ..............B%</span><br><span class="line">	0x0030:  c89e 1d99                                ....</span><br><span class="line">22:22:23.292562 IP 139.9.222.124.https &gt; 192.168.1.106.33170: Flags [.], ack 518, win 235, options [nop,nop,TS val 3365805485 ecr 434651673], length 0</span><br><span class="line">	0x0000:  4500 0034 1ff1 4000 3106 fe3a 8b09 de7c  E..4..@.1..:...|</span><br><span class="line">	0x0010:  c0a8 016a 01bb 8192 4d9a ceb8 f6ab 9a22  ...j....M......&quot;</span><br><span class="line">	0x0020:  8010 00eb d77d 0000 0101 080a c89e 1dad  .....&#125;..........</span><br><span class="line">	0x0030:  19e8 4219  </span><br></pre></td></tr></table></figure>


<p>4500 这两个字节开头明显就是ip报头，4代表ipv4,5则是ip报头的长度，也就是ip报头长度是5*4&#x3D;20；</p>
<h4 id="ip报头"><a href="#ip报头" class="headerlink" title="ip报头"></a>ip报头</h4><p>也就是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x0000:  4500 0239 15ab 4000 4006 f77b c0a8 016a  E..9..@.@..&#123;...j</span><br><span class="line">0x0010:  8b09 de7c </span><br></pre></td></tr></table></figure>
<p>一直到de7c都是ip报头</p>
<h4 id="tcp-报头"><a href="#tcp-报头" class="headerlink" title="tcp 报头"></a>tcp 报头</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x0000:  4500 0239 15ab 4000 4006 f77b c0a8 016a  E..9..@.@..&#123;...j</span><br><span class="line">0x0010:  8b09 de7c 8192 01bb &lt;- 01bb就是443也就是目的端口</span><br></pre></td></tr></table></figure>
<p><code>1*16*16+11*16+16=443</code></p>
<p>版本：IP协议的版本，目前的IP协议版本号为4，下一代IP协议版本号为6。</p>
<p>首部长度：IP报头的长度。固定部分的长度（20字节）和可变部分的长度之和。共占4位。最大为1111，即10进制的15，代表IP报头的最大长度可以为15个32bits（4字节），也就是最长可为15*4&#x3D;60字节，除去固定部分的长度20字节，可变部分的长度最大为40字节。</p>
<p>翻了一下<a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc8446">rfc8446</a>,TLSV12的<code>client hello</code>的版本<code>magic number</code>是<code>0x0303</code>,搜索了一下果然有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct &#123;</span><br><span class="line">         ProtocolVersion legacy_version = 0x0303;    /* TLS v1.2 */</span><br><span class="line">         Random random;</span><br><span class="line">         opaque legacy_session_id&lt;0..32&gt;;</span><br><span class="line">         CipherSuite cipher_suites&lt;2..2^16-2&gt;;</span><br><span class="line">         opaque legacy_compression_methods&lt;1..2^8-1&gt;;</span><br><span class="line">         Extension extensions&lt;8..2^16-1&gt;;</span><br><span class="line">     &#125; ClientHello;</span><br></pre></td></tr></table></figure>

<p>但是返回的明文很明显不是一个错误的链接</p>
<p>所以被sni阻断了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In the OCSPStatusRequest, the &quot;ResponderIDs&quot; provides a list of OCSP</span><br><span class="line">   responders that the client trusts.  A zero-length &quot;responder_id_list&quot;</span><br><span class="line">   sequence has the special meaning that the responders are implicitly</span><br><span class="line">   known to the server - e.g., by prior arrangement.  &quot;Extensions&quot; is a</span><br><span class="line">   DER encoding of OCSP request extensions.</span><br><span class="line"></span><br><span class="line">   Both &quot;ResponderID&quot; and &quot;Extensions&quot; are DER-encoded ASN.1 types as</span><br><span class="line">   defined in [OCSP].  &quot;Extensions&quot; is imported from [PKIX].  A zero-</span><br><span class="line">   length &quot;request_extensions&quot; value means that there are no extensions</span><br><span class="line">   (as opposed to a zero-length ASN.1 SEQUENCE, which is not valid for</span><br><span class="line">   the &quot;Extensions&quot; type).</span><br><span class="line"></span><br><span class="line">   In the case of the &quot;id-pkix-ocsp-nonce&quot; OCSP extension, [OCSP] is</span><br><span class="line">   unclear about its encoding; for clarification, the nonce MUST be a</span><br><span class="line">   DER-encoded OCTET STRING, which is encapsulated as another OCTET</span><br><span class="line">   STRING (note that implementations based on an existing OCSP client</span><br><span class="line">   will need to be checked for conformance to this requirement).</span><br><span class="line"></span><br><span class="line">   Servers that receive a client hello containing the &quot;status_request&quot;</span><br><span class="line">   extension, MAY return a suitable certificate status response to the</span><br><span class="line">   client along with their certificate.  If OCSP is requested, they</span><br><span class="line">   SHOULD use the information contained in the extension when selecting</span><br><span class="line">   an OCSP responder, and SHOULD include request_extensions in the OCSP</span><br><span class="line">   request.</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/10/08/mysql-string-max-length/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/08/mysql-string-max-length/" class="post-title-link" itemprop="url">mysql字符串最大长度</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-08 22:23:08" itemprop="dateCreated datePublished" datetime="2019-10-08T22:23:08+08:00">2019-10-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>本文主要是记录mysql各种类型的字符串受什么限制。</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天遇到一个特别的事情：把一个pdf的文档转成html然后存进mysql里面，所以我用了<code>text</code> 的字段来存。<br>结果读出来的时候发现少了一截。搜索了一番才发现text居然最大只能支持16kb的<strong>字节</strong>的内容。 </p>
<h2 id="字节和字符"><a href="#字节和字符" class="headerlink" title="字节和字符"></a>字节和字符</h2><p>如果你写过php,你可以比较清晰地知道<code>strlen(&quot;你好&quot;)</code>和<code>mb_strlen(&quot;你好&quot;)</code>两者的区别。<br>如果是java的话，字节流的<code>InputStream</code> 和<code>OutputStream</code> 或者<code>writer</code>和<code>reader</code>这两个系列的区别你肯定也不陌生。</p>
<h2 id="mysql字符串的长度与类型关系"><a href="#mysql字符串的长度与类型关系" class="headerlink" title="mysql字符串的长度与类型关系"></a>mysql字符串的长度与类型关系</h2><blockquote>
<p>String Type Storage Requirements</p>
</blockquote>
<blockquote>
<p>In the following table, M represents the declared column length in characters for nonbinary string types and bytes for binary string types. L represents the actual length in bytes of a given string value.</p>
</blockquote>
<table>
<thead>
<tr>
<th>Data Type</th>
<th>Storage Required</th>
</tr>
</thead>
<tbody><tr>
<td>CHAR(M)</td>
<td>The compact family of InnoDB row formats optimize storage for variable-length character</td>
</tr>
<tr>
<td>BINARY(M)</td>
<td>M bytes, 0 &lt;&#x3D; M &lt;&#x3D; 255</td>
</tr>
<tr>
<td>VARCHAR(M), VARBINARY(M)</td>
<td>L + 1 bytes if column values require 0 − 255 bytes, L + 2 bytes if values may require more than 255 bytes</td>
</tr>
<tr>
<td>TINYBLOB, TINYTEXT</td>
<td>L + 1 bytes, where L &lt; 28</td>
</tr>
<tr>
<td>BLOB, TEXT</td>
<td>L + 2 bytes, where L &lt; 216</td>
</tr>
<tr>
<td>MEDIUMBLOB, MEDIUMTEXT</td>
<td>L + 3 bytes, where L &lt; 224</td>
</tr>
<tr>
<td>LONGBLOB, LONGTEXT</td>
<td>L + 4 bytes, where L &lt; 232</td>
</tr>
<tr>
<td>ENUM(‘value1’,’value2’,…)</td>
<td>1 or 2 bytes, depending on the number of enumeration values (65,535 values maximum)</td>
</tr>
<tr>
<td>SET(‘value1’,’value2’,…)</td>
<td>1, 2, 3, 4, or 8 bytes, depending on the number of set members (64 members maximum)</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/storage-requirements.html">来源</a></p>
<h3 id="CHAR"><a href="#CHAR" class="headerlink" title="CHAR"></a>CHAR</h3><p>CHAR 最大是255个<strong>字符</strong></p>
<p>用如下的sql创建256个字符的char类型字符串会报错误</p>
<blockquote>
<p>ERROR 1074 (42000): Column length too big for column ‘name’ (max &#x3D; 255); use BLOB or TEXT instead</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test123` ( `name` char(256)) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  my_error (nr=1074, MyFlags=0) at /home/dinosaur/Downloads/mysql-5.7.21/mysys/my_error.c:194</span><br><span class="line">#1  0x0000000000f93e75 in Create_field::init (this=0x7fb9b8006740, thd=0x7fb9b8000b70, fld_name=0x7fb9b8006730 &quot;name&quot;, fld_type=MYSQL_TYPE_STRING, fld_length=0x7fb9b8006738 &quot;256&quot;, fld_decimals=0x0, fld_type_modifier=0, </span><br><span class="line">    fld_default_value=0x0, fld_on_update_value=0x0, fld_comment=0x7fb9b8002fe0, fld_change=0x0, fld_interval_list=0x7fb9b8003150, fld_charset=0x0, fld_geom_type=0, fld_gcol_info=0x0)</span><br><span class="line">    at /home/dinosaur/Downloads/mysql-5.7.21/sql/field.cc:10962</span><br><span class="line">#2  0x000000000163ae21 in add_field_to_list (thd=0x7fb9b8000b70, field_name=0x7fba3d30c460, type=MYSQL_TYPE_STRING, length=0x7fb9b8006738 &quot;256&quot;, decimals=0x0, type_modifier=0, default_value=0x0, on_update_value=0x0, </span><br><span class="line">    comment=0x7fb9b8002fe0, change=0x0, interval_list=0x7fb9b8003150, cs=0x0, uint_geom_type=0, gcol_info=0x0) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:5798</span><br><span class="line">#3  0x000000000178e3f6 in MYSQLparse (YYTHD=0x7fb9b8000b70) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_yacc.yy:6337</span><br><span class="line">#4  0x000000000163d75a in parse_sql (thd=0x7fb9b8000b70, parser_state=0x7fba3d30d550, creation_ctx=0x0) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:7131</span><br><span class="line">#5  0x0000000001639f07 in mysql_parse (thd=0x7fb9b8000b70, parser_state=0x7fba3d30d550) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:5469</span><br><span class="line">#6  0x000000000162f0a3 in dispatch_command (thd=0x7fb9b8000b70, com_data=0x7fba3d30de00, command=COM_QUERY) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:1458</span><br><span class="line">#7  0x000000000162df32 in do_command (thd=0x7fb9b8000b70) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:999</span><br><span class="line">#8  0x0000000001770f97 in handle_connection (arg=0x570d510) at /home/dinosaur/Downloads/mysql-5.7.21/sql/conn_handler/connection_handler_per_thread.cc:300</span><br><span class="line">#9  0x0000000001de0b41 in pfs_spawn_thread (arg=0x5749fc0) at /home/dinosaur/Downloads/mysql-5.7.21/storage/perfschema/pfs.cc:2190</span><br><span class="line">#10 0x00007fba478aa6ba in start_thread (arg=0x7fba3d30e700) at pthread_create.c:333</span><br><span class="line">#11 0x00007fba46d3341d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</span><br></pre></td></tr></table></figure>


<h3 id="varchar最大长度"><a href="#varchar最大长度" class="headerlink" title="varchar最大长度"></a>varchar最大长度</h3><p>和char类似，想创建一个<code>65532</code>字符的varchar类型字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test123` ( `name` varchar(65533)) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果也是一样的错误</p>
<blockquote>
<p>ERROR 1074 (42000): Column length too big for column ‘name’ (max &#x3D; 16383); use BLOB or TEXT instead</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  my_error (nr=1074, MyFlags=0) at /home/dinosaur/Downloads/mysql-5.7.21/mysys/my_error.c:194</span><br><span class="line">#1  0x00000000016c9998 in prepare_blob_field (thd=0x7fb9b8000b70, sql_field=0x7fb9b8006840) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_table.cc:4715</span><br><span class="line">#2  0x00000000016c6a33 in mysql_prepare_create_table (thd=0x7fb9b8000b70, error_schema_name=0x7fb9b8006728 &quot;test&quot;, error_table_name=0x7fb9b8006168 &quot;test123&quot;, create_info=0x7fba3d30c6b0, alter_info=0x7fba3d30c600, </span><br><span class="line">    tmp_table=false, db_options=0x7fba3d30b080, file=0x7fb9b8006ac0, key_info_buffer=0x7fba3d30c170, key_count=0x7fba3d30c16c, select_field_count=0) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_table.cc:3721</span><br><span class="line">#3  0x00000000016cac22 in create_table_impl (thd=0x7fb9b8000b70, db=0x7fb9b8006728 &quot;test&quot;, table_name=0x7fb9b8006168 &quot;test123&quot;, error_table_name=0x7fb9b8006168 &quot;test123&quot;, path=0x7fba3d30c180 &quot;./test/test123&quot;, </span><br><span class="line">    create_info=0x7fba3d30c6b0, alter_info=0x7fba3d30c600, internal_tmp_table=false, select_field_count=0, no_ha_table=false, is_trans=0x7fba3d30c3da, key_info=0x7fba3d30c170, key_count=0x7fba3d30c16c)</span><br><span class="line">    at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_table.cc:5131</span><br><span class="line">#4  0x00000000016cb884 in mysql_create_table_no_lock (thd=0x7fb9b8000b70, db=0x7fb9b8006728 &quot;test&quot;, table_name=0x7fb9b8006168 &quot;test123&quot;, create_info=0x7fba3d30c6b0, alter_info=0x7fba3d30c600, select_field_count=0, </span><br><span class="line">    is_trans=0x7fba3d30c3da) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_table.cc:5417</span><br><span class="line">#5  0x00000000016cb9a2 in mysql_create_table (thd=0x7fb9b8000b70, create_table=0x7fb9b80061a0, create_info=0x7fba3d30c6b0, alter_info=0x7fba3d30c600) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_table.cc:5463</span><br><span class="line">#6  0x00000000016335be in mysql_execute_command (thd=0x7fb9b8000b70, first_level=true) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:3248</span><br><span class="line">#7  0x000000000163a31c in mysql_parse (thd=0x7fb9b8000b70, parser_state=0x7fba3d30d550) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:5582</span><br><span class="line">#8  0x000000000162f0a3 in dispatch_command (thd=0x7fb9b8000b70, com_data=0x7fba3d30de00, command=COM_QUERY) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:1458</span><br><span class="line">#9  0x000000000162df32 in do_command (thd=0x7fb9b8000b70) at /home/dinosaur/Downloads/mysql-5.7.21/sql/sql_parse.cc:999</span><br><span class="line">#10 0x0000000001770f97 in handle_connection (arg=0x570d510) at /home/dinosaur/Downloads/mysql-5.7.21/sql/conn_handler/connection_handler_per_thread.cc:300</span><br><span class="line">#11 0x0000000001de0b41 in pfs_spawn_thread (arg=0x5749fc0) at /home/dinosaur/Downloads/mysql-5.7.21/storage/perfschema/pfs.cc:2190</span><br><span class="line">#12 0x00007fba478aa6ba in start_thread (arg=0x7fba3d30e700) at pthread_create.c:333</span><br><span class="line">#13 0x00007fba46d3341d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</span><br><span class="line"></span><br><span class="line">(gdb) p sql_field-&gt;length </span><br><span class="line">$2 = 262132</span><br></pre></td></tr></table></figure>


<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static bool prepare_blob_field(THD *thd, Create_field *sql_field)</span><br><span class="line">&#123;</span><br><span class="line">  DBUG_ENTER(&quot;prepare_blob_field&quot;);</span><br><span class="line"></span><br><span class="line">  if (sql_field-&gt;length &gt; MAX_FIELD_VARCHARLENGTH &amp;&amp;      // sql_field-&gt;length = 262132</span><br><span class="line">      !(sql_field-&gt;flags &amp; BLOB_FLAG))</span><br><span class="line">  &#123;</span><br><span class="line">    /* Convert long VARCHAR columns to TEXT or BLOB */</span><br><span class="line">    char warn_buff[MYSQL_ERRMSG_SIZE];</span><br><span class="line"></span><br><span class="line">    if (sql_field-&gt;def || thd-&gt;is_strict_mode())      // 严格模式下会打印errorERROR 1074 (42000): Column length too big for </span><br><span class="line">    &#123;                                                   // column &#x27;name&#x27; (max = 16383); use BLOB or TEXT instead</span><br><span class="line">      my_error(ER_TOO_BIG_FIELDLENGTH, MYF(0), sql_field-&gt;field_name,</span><br><span class="line">               static_cast&lt;ulong&gt;(MAX_FIELD_VARCHARLENGTH /            // MAX_FIELD_VARCHARLENGTH = 65535</span><br><span class="line">                                  sql_field-&gt;charset-&gt;mbmaxlen));     // sql_field-&gt;charset-&gt;mbmaxlen = 4</span><br><span class="line">      DBUG_RETURN(1);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>


<p>也就是严格模式下，varchar 最大是65535字节的内容，改成<code>varchar(16383)</code>看看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE `test123` ( `name` varchar(16383)) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8mb4;</span><br><span class="line">Query OK, 0 rows affected (0.26 sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ok,没有问题</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/10/02/learn-es-invert-index/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/10/02/learn-es-invert-index/" class="post-title-link" itemprop="url">倒排索引</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-10-02 09:47:25" itemprop="dateCreated datePublished" datetime="2019-10-02T09:47:25+08:00">2019-10-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="es编译"><a href="#es编译" class="headerlink" title="es编译"></a>es编译</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradle idea</span><br></pre></td></tr></table></figure>
<p>跑了很久</p>
<blockquote>
<p>BUILD SUCCESSFUL in 49m 34s<br>334 actionable tasks: 334 executed</p>
</blockquote>
<p>es 堆栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">prepareRequest:61, RestCatAction (org.elasticsearch.rest.action.cat)</span><br><span class="line">handleRequest:80, BaseRestHandler (org.elasticsearch.rest)</span><br><span class="line">handleRequest:69, SecurityRestFilter (org.elasticsearch.xpack.security.rest)</span><br><span class="line">dispatchRequest:240, RestController (org.elasticsearch.rest)</span><br><span class="line">tryAllHandlers:337, RestController (org.elasticsearch.rest)</span><br><span class="line">dispatchRequest:174, RestController (org.elasticsearch.rest)</span><br><span class="line">dispatchRequest:324, AbstractHttpServerTransport (org.elasticsearch.http)</span><br><span class="line">handleIncomingRequest:374, AbstractHttpServerTransport (org.elasticsearch.http)</span><br><span class="line">incomingRequest:303, AbstractHttpServerTransport (org.elasticsearch.http)</span><br><span class="line">channelRead0:66, Netty4HttpRequestHandler (org.elasticsearch.http.netty4)</span><br><span class="line">channelRead0:31, Netty4HttpRequestHandler (org.elasticsearch.http.netty4)</span><br><span class="line">channelRead:105, SimpleChannelInboundHandler (io.netty.channel)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:58, Netty4HttpPipeliningHandler (org.elasticsearch.http.netty4)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:102, MessageToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">channelRead:111, MessageToMessageCodec (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:102, MessageToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:102, MessageToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:323, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">channelRead:297, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:286, IdleStateHandler (io.netty.handler.timeout)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:1434, DefaultChannelPipeline$HeadContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:965, DefaultChannelPipeline (io.netty.channel)</span><br><span class="line">read:163, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)</span><br><span class="line">processSelectedKey:644, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">processSelectedKeysPlain:544, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">processSelectedKeys:498, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">run:458, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">run:897, SingleThreadEventExecutor$5 (io.netty.util.concurrent)</span><br><span class="line">run:834, Thread (java.lang)</span><br></pre></td></tr></table></figure>
<p>以及</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">handleRequest:97, BaseRestHandler (org.elasticsearch.rest)</span><br><span class="line">handleRequest:69, SecurityRestFilter (org.elasticsearch.xpack.security.rest)</span><br><span class="line">dispatchRequest:240, RestController (org.elasticsearch.rest)</span><br><span class="line">tryAllHandlers:337, RestController (org.elasticsearch.rest)</span><br><span class="line">dispatchRequest:174, RestController (org.elasticsearch.rest)</span><br><span class="line">dispatchRequest:324, AbstractHttpServerTransport (org.elasticsearch.http)</span><br><span class="line">handleIncomingRequest:374, AbstractHttpServerTransport (org.elasticsearch.http)</span><br><span class="line">incomingRequest:303, AbstractHttpServerTransport (org.elasticsearch.http)</span><br><span class="line">channelRead0:66, Netty4HttpRequestHandler (org.elasticsearch.http.netty4)</span><br><span class="line">channelRead0:31, Netty4HttpRequestHandler (org.elasticsearch.http.netty4)</span><br><span class="line">channelRead:105, SimpleChannelInboundHandler (io.netty.channel)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:58, Netty4HttpPipeliningHandler (org.elasticsearch.http.netty4)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:102, MessageToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">channelRead:111, MessageToMessageCodec (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:102, MessageToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:102, MessageToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:323, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">channelRead:297, ByteToMessageDecoder (io.netty.handler.codec)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:286, IdleStateHandler (io.netty.handler.timeout)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:340, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">channelRead:1434, DefaultChannelPipeline$HeadContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:362, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">invokeChannelRead:348, AbstractChannelHandlerContext (io.netty.channel)</span><br><span class="line">fireChannelRead:965, DefaultChannelPipeline (io.netty.channel)</span><br><span class="line">read:163, AbstractNioByteChannel$NioByteUnsafe (io.netty.channel.nio)</span><br><span class="line">processSelectedKey:644, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">processSelectedKeysPlain:544, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">processSelectedKeys:498, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">run:458, NioEventLoop (io.netty.channel.nio)</span><br><span class="line">run:897, SingleThreadEventExecutor$5 (io.netty.util.concurrent)</span><br><span class="line">run:834, Thread (java.lang)</span><br></pre></td></tr></table></figure>
<h4 id="倒排索引简介"><a href="#倒排索引简介" class="headerlink" title="倒排索引简介"></a>倒排索引简介</h4><ul>
<li><a target="_blank" rel="noopener" href="https://people.eng.unimelb.edu.au//jzobel/fulltext/compsurv06.pdf">相关论文文档  Inverted Files for Text Search Engines</a></li>
</ul>
<p><strong>到排索引解决什么问题？</strong> </p>
<p>当我们有一个文档<code>a.txt</code>,里面有一堆文字<code>hello wrold ,i am dinosaur</code>。</p>
<p>我们需要从所有文档里面判断这个文档里面是否存在<code>world</code> 这个词汇，应该怎么做呢？</p>
<p>当文档的数量很少的时候，可以</p>
<ul>
<li>1 打开文件</li>
<li>2 从头开始去读取文件内容判断是否包含<code>world</code></li>
</ul>
<p>那么当我们不仅仅只有一个文档<code>a.txt</code>,我们还有<code>b.txt</code>和<code>c.txt</code>的时候，我们怎么判断某个词<code>word</code>是否在这些文档里面呢？如果<code>word</code>在里面，又在那些文档的第几行呢？</p>
<p>如果我们还用之前的从头开始一个个文件读的话，如果文档数量少还好，如果文档很多，我们就<code>非常慢</code>才能读完所有的文档。</p>
<p>倒排索引解决的其中一个问题就是如何快速定位某个词是是否在这些文档中，如果在又在哪些文档里面。</p>
<h4 id="相关例子"><a href="#相关例子" class="headerlink" title="相关例子"></a>相关例子</h4><ul>
<li><a target="_blank" rel="noopener" href="https://nlp.stanford.edu/IR-book/html/htmledition/a-first-take-at-building-an-inverted-index-1.html">例子一</a></li>
<li><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/inverted-index/">例子二</a></li>
</ul>
<h4 id="baseline-invert-index"><a href="#baseline-invert-index" class="headerlink" title="baseline invert index"></a>baseline invert index</h4><p>倒排索引包括主要两个部分： </p>
<ul>
<li>第一部分<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="4.914ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 2172 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D464" d="M580 385Q580 406 599 424T641 443Q659 443 674 425T690 368Q690 339 671 253Q656 197 644 161T609 80T554 12T482 -11Q438 -11 404 5T355 48Q354 47 352 44Q311 -11 252 -11Q226 -11 202 -5T155 14T118 53T104 116Q104 170 138 262T173 379Q173 380 173 381Q173 390 173 393T169 400T158 404H154Q131 404 112 385T82 344T65 302T57 280Q55 278 41 278H27Q21 284 21 287Q21 293 29 315T52 366T96 418T161 441Q204 441 227 416T250 358Q250 340 217 250T184 111Q184 65 205 46T258 26Q301 26 334 87L339 96V119Q339 122 339 128T340 136T341 143T342 152T345 165T348 182T354 206T362 238T373 281Q402 395 406 404Q419 431 449 431Q468 431 475 421T483 402Q483 389 454 274T422 142Q420 131 420 107V100Q420 85 423 71T442 42T487 26Q558 26 600 148Q609 171 620 213T632 273Q632 306 619 325T593 357T580 385Z"></path></g><g data-mml-node="mi" transform="translate(716,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(1201,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1652,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container>包含<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="0.817ex" height="1.441ex" role="img" focusable="false" viewBox="0 -626 361 637"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></svg></mjx-container>两个域：  <ul>
<li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.874ex" height="2.059ex" role="img" focusable="false" viewBox="0 -705 828.3 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g><g data-mml-node="TeXAtom" transform="translate(523,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></g></g></svg></mjx-container>: 文档(document)中包含词<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="0.817ex" height="1.441ex" role="img" focusable="false" viewBox="0 -626 361 637"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></svg></mjx-container>的<strong>文档个数</strong>，也就是说有多少个文档含有词<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="0.817ex" height="1.441ex" role="img" focusable="false" viewBox="0 -626 361 637"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></svg></mjx-container>,那么<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="1.874ex" height="2.059ex" role="img" focusable="false" viewBox="0 -705 828.3 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g><g data-mml-node="TeXAtom" transform="translate(523,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></g></g></svg></mjx-container>等于几。</li>
<li>指向<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="11.69ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 5167 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(345,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(945,0)"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g><g data-mml-node="mi" transform="translate(1430,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(1896,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(2347,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(2708,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(3174,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(3694,0)"><path data-c="1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path></g><g data-mml-node="mi" transform="translate(3992,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(4337,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(4806,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></svg></mjx-container>的指针</li>
</ul>
</li>
<li>第二部分<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="9.459ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 4181 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(345,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(945,0)"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"></path></g><g data-mml-node="mi" transform="translate(1430,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"></path></g><g data-mml-node="mi" transform="translate(1896,0)"><path data-c="1D45F" d="M21 287Q22 290 23 295T28 317T38 348T53 381T73 411T99 433T132 442Q161 442 183 430T214 408T225 388Q227 382 228 382T236 389Q284 441 347 441H350Q398 441 422 400Q430 381 430 363Q430 333 417 315T391 292T366 288Q346 288 334 299T322 328Q322 376 378 392Q356 405 342 405Q286 405 239 331Q229 315 224 298T190 165Q156 25 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 114 189T154 366Q154 405 128 405Q107 405 92 377T68 316T57 280Q55 278 41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(2347,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g><g data-mml-node="mi" transform="translate(2708,0)"><path data-c="1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"></path></g><g data-mml-node="mi" transform="translate(3006,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(3351,0)"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mi" transform="translate(3820,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></svg></mjx-container>是一个列表，列表的每个元素包括以下两个域： <ul>
<li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="5.21ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 2303 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(520,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(1005,0)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(1438,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1783,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container>: 文档对应的id,可以理解为文档主键</li>
<li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.464ex;" xmlns="http://www.w3.org/2000/svg" width="2.128ex" height="2.059ex" role="img" focusable="false" viewBox="0 -705 940.7 910"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D453" d="M118 -162Q120 -162 124 -164T135 -167T147 -168Q160 -168 171 -155T187 -126Q197 -99 221 27T267 267T289 382V385H242Q195 385 192 387Q188 390 188 397L195 425Q197 430 203 430T250 431Q298 431 298 432Q298 434 307 482T319 540Q356 705 465 705Q502 703 526 683T550 630Q550 594 529 578T487 561Q443 561 443 603Q443 622 454 636T478 657L487 662Q471 668 457 668Q445 668 434 658T419 630Q412 601 403 552T387 469T380 433Q380 431 435 431Q480 431 487 430T498 424Q499 420 496 407T491 391Q489 386 482 386T428 385H372L349 263Q301 15 282 -47Q255 -132 212 -173Q175 -205 139 -205Q107 -205 81 -186T55 -132Q55 -95 76 -78T118 -61Q162 -61 162 -103Q162 -122 151 -136T127 -157L118 -162Z"></path></g><g data-mml-node="TeXAtom" transform="translate(523,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></g></g></svg></mjx-container>: 该<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="5.21ex" height="1.595ex" role="img" focusable="false" viewBox="0 -694 2303 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g><g data-mml-node="mi" transform="translate(520,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"></path></g><g data-mml-node="mi" transform="translate(1005,0)"><path data-c="1D450" d="M34 159Q34 268 120 355T306 442Q362 442 394 418T427 355Q427 326 408 306T360 285Q341 285 330 295T319 325T330 359T352 380T366 386H367Q367 388 361 392T340 400T306 404Q276 404 249 390Q228 381 206 359Q162 315 142 235T121 119Q121 73 147 50Q169 26 205 26H209Q321 26 394 111Q403 121 406 121Q410 121 419 112T429 98T420 83T391 55T346 25T282 0T202 -11Q127 -11 81 37T34 159Z"></path></g><g data-mml-node="mi" transform="translate(1438,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"></path></g><g data-mml-node="mi" transform="translate(1783,0)"><path data-c="1D451" d="M366 683Q367 683 438 688T511 694Q523 694 523 686Q523 679 450 384T375 83T374 68Q374 26 402 26Q411 27 422 35Q443 55 463 131Q469 151 473 152Q475 153 483 153H487H491Q506 153 506 145Q506 140 503 129Q490 79 473 48T445 8T417 -8Q409 -10 393 -10Q359 -10 336 5T306 36L300 51Q299 52 296 50Q294 48 292 46Q233 -10 172 -10Q117 -10 75 30T33 157Q33 205 53 255T101 341Q148 398 195 420T280 442Q336 442 364 400Q369 394 369 396Q370 400 396 505T424 616Q424 629 417 632T378 637H357Q351 643 351 645T353 664Q358 683 366 683ZM352 326Q329 405 277 405Q242 405 210 374T160 293Q131 214 119 129Q119 126 119 118T118 106Q118 61 136 44T179 26Q233 26 290 98L298 109L352 326Z"></path></g></g></g></svg></mjx-container> 中包含词<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="0.817ex" height="1.441ex" role="img" focusable="false" viewBox="0 -626 361 637"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"></path></g></g></g></svg></mjx-container>的数量</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgchr.com/i/uwiAvq"><img src="https://s2.ax1x.com/2019/10/02/uwiAvq.png" alt="uwiAvq.png"></a></p>
<p>我自己写了的demo代码<a target="_blank" rel="noopener" href="https://github.com/769344359/invert_index">github 地址</a>,输出如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">keeper  3|[{1 1} {4 1} {5 1}]</span><br><span class="line">    In  1|[{2 1}]</span><br><span class="line"> house  2|[{2 1} {3 1}]</span><br><span class="line"> nignt  2|[{4 1} {5 1}]</span><br><span class="line">   did  1|[{4 1}]</span><br><span class="line">  dark  1|[{6 1}]</span><br><span class="line">   old  4|[{1 1} {2 1} {3 1} {4 1}]</span><br><span class="line"> night  3|[{1 1} {5 1} {6 1}]</span><br><span class="line">   had  1|[{3 1}]</span><br><span class="line">sleeps  1|[{6 1}]</span><br><span class="line">  keep  3|[{1 1} {3 1} {5 1}]</span><br><span class="line">   big  2|[{2 1} {3 1}]</span><br><span class="line"> keeps  3|[{1 1} {5 1} {6 1}]</span><br><span class="line">   the  6|[{1 1} {2 1} {3 1} {4 1} {5 1} {6 1}]</span><br><span class="line"> never  1|[{4 1}]</span><br><span class="line">   and  1|[{6 1}]</span><br><span class="line">   And  1|[{6 1}]</span><br><span class="line">    in  5|[{1 1} {2 1} {3 1} {5 1} {6 1}]</span><br><span class="line">   The  3|[{1 1} {3 1} {5 1}]</span><br><span class="line"> sleep  1|[{4 1}]</span><br><span class="line"> Where  1|[{4 1}]</span><br><span class="line">  town  2|[{1 1} {3 1}]</span><br><span class="line">  gown  1|[{2 1}]</span><br></pre></td></tr></table></figure>



<h4 id="构造倒排索引的步骤"><a href="#构造倒排索引的步骤" class="headerlink" title="构造倒排索引的步骤"></a>构造倒排索引的步骤</h4><ul>
<li>1 读取文档</li>
<li>2 分词</li>
<li>3 对分词正规化（normalized）</li>
<li>4 建立包含词频和偏移量的倒排索引</li>
</ul>
<h2 id="分词"><a href="#分词" class="headerlink" title="分词"></a>分词</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/forfuture1978/archive/2010/06/06/1752837.html">https://www.cnblogs.com/forfuture1978/archive/2010/06/06/1752837.html</a></p>
<p>Lucene 的堆栈,主要的逻辑都在<code>invert</code>方法里面 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">incrementToken:48, FilteringTokenFilter (org.apache.lucene.analysis)</span><br><span class="line">invert:812, DefaultIndexingChain$PerField (org.apache.lucene.index)</span><br><span class="line">processField:442, DefaultIndexingChain (org.apache.lucene.index)</span><br><span class="line">processDocument:406, DefaultIndexingChain (org.apache.lucene.index)</span><br><span class="line">updateDocument:250, DocumentsWriterPerThread (org.apache.lucene.index)</span><br><span class="line">updateDocument:495, DocumentsWriter (org.apache.lucene.index)</span><br><span class="line">updateDocument:1594, IndexWriter (org.apache.lucene.index)</span><br><span class="line">addDocument:1213, IndexWriter (org.apache.lucene.index)</span><br><span class="line">indexDoc:198, IndexFiles (com.dinosaur)</span><br><span class="line">visitFile:155, IndexFiles$1 (com.dinosaur)</span><br><span class="line">visitFile:151, IndexFiles$1 (com.dinosaur)</span><br><span class="line">walkFileTree:2670, Files (java.nio.file)</span><br><span class="line">walkFileTree:2742, Files (java.nio.file)</span><br><span class="line">indexDocs:151, IndexFiles (com.dinosaur)</span><br><span class="line">main:113, IndexFiles (com.dinosaur)</span><br></pre></td></tr></table></figure>


<p>Lucene分词的核心在于incrementToken获取token</p>
<p>举个例子</p>
<p>Lucene的标准分词器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">private final CharTermAttribute termAtt = addAttribute(CharTermAttribute.class);  // final的单例</span><br><span class="line">@Override</span><br><span class="line">public final boolean incrementToken() throws IOException {</span><br><span class="line">  ...</span><br><span class="line">      scanner.getText(termAtt);  // scanner 返回一个词并将那个词设置到termAtt上面</span><br><span class="line">  ... </span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<ul>
<li>相关阅读</li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq924862077/article/details/80985377">https://blog.csdn.net/qq924862077/article/details/80985377</a></li>
<li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000017831398">https://segmentfault.com/a/1190000017831398</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/elastic/elasticsearch/issues/34361">https://github.com/elastic/elasticsearch/issues/34361</a></li>
<li><a target="_blank" rel="noopener" href="https://lanffy.github.io/2019/04/08/Elasticsearch-Compile-Source-And-Debug">https://lanffy.github.io/2019/04/08/Elasticsearch-Compile-Source-And-Debug</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/09/28/maven%E6%89%93%E5%8C%85NoClassDefFoundError-on-Maven-dependency/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/28/maven%E6%89%93%E5%8C%85NoClassDefFoundError-on-Maven-dependency/" class="post-title-link" itemprop="url">maven打包NoClassDefFoundError</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-28 18:47:47" itemprop="dateCreated datePublished" datetime="2019-09-28T18:47:47+08:00">2019-09-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="maven打包NoClassDefFoundError"><a href="#maven打包NoClassDefFoundError" class="headerlink" title="maven打包NoClassDefFoundError"></a>maven打包NoClassDefFoundError</h2><p>刚刚在学习怎么使用maven，可以编译通过，但是运行命令<code>java -jar xxx.jar</code> 的时候却报了错误<code>NoClassDefFoundError</code></p>
<h3 id="踩坑开始"><a href="#踩坑开始" class="headerlink" title="踩坑开始"></a>踩坑开始</h3><p>踩坑第一步是去stack overflow 找了一个答案，使用插件<code>maven-shade-plugin</code>，其实这个也是正确的答案</p>
<h4 id="这是正确答案"><a href="#这是正确答案" class="headerlink" title="这是正确答案"></a>这是正确答案</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;project&gt;</span><br><span class="line">  ...</span><br><span class="line">  &lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">  &lt;/build&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>


<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/10569417/6229548">相关链接</a></p>
<h4 id="我踩坑在哪里呢？"><a href="#我踩坑在哪里呢？" class="headerlink" title="我踩坑在哪里呢？"></a>我踩坑在哪里呢？</h4><p>我当时不了解xml节点<code>&lt;pluginManagement&gt;</code>下面的<code>plugins</code>节点</p>
<ul>
<li>这个是错误的写法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;project&gt;</span><br><span class="line">  ...</span><br><span class="line">  &lt;build&gt;</span><br><span class="line">  &lt;pluginManagement&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line">    &lt;/pluginManagement&gt;</span><br><span class="line">  &lt;/build&gt;</span><br><span class="line">  ...</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>

<h4 id="最终我的写法"><a href="#最终我的写法" class="headerlink" title="最终我的写法"></a>最终我的写法</h4><p>最终写法就是得放在<code>build</code> 节点的下一级，不能放在<code>pluginManagement</code>里面的<code>&lt;plugins&gt;</code>节点里面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;project&gt;</span><br><span class="line">  ...</span><br><span class="line">  &lt;build&gt;</span><br><span class="line">  &lt;plugins&gt;</span><br><span class="line">      &lt;plugin&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line">        &lt;executions&gt;</span><br><span class="line">          &lt;execution&gt;</span><br><span class="line">            &lt;phase&gt;package&lt;/phase&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">              &lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">          &lt;/execution&gt;</span><br><span class="line">        &lt;/executions&gt;</span><br><span class="line">      &lt;/plugin&gt;</span><br><span class="line">   &lt;/plugins&gt;</span><br><span class="line">  &lt;pluginManagement&gt;</span><br><span class="line">    ...</span><br><span class="line">  &lt;/pluginManagement&gt;</span><br><span class="line">&lt;/build&gt;</span><br><span class="line">...</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure>


<p>然后运行<code>mvn package</code> 就能打包所有依赖进去</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/09/21/hello-world-java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/21/hello-world-java/" class="post-title-link" itemprop="url">hello world java</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-21 09:41:37" itemprop="dateCreated datePublished" datetime="2019-09-21T09:41:37+08:00">2019-09-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="hello"><a href="#hello" class="headerlink" title="hello"></a>hello</h2><p>java hello world</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">public class HelloWorld &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        // Prints &quot;Hello, World&quot; to the terminal window.</span><br><span class="line">        System.out.println(&quot;Hello, World&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h4><p>编译 需要添加g 选项</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -g HelloWorld.java </span><br></pre></td></tr></table></figure>
<h4 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h4><p><strong>方法一：</strong> </p>
<p>使用<code>jdb</code> 调试hello wrold</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdb -classpath . HelloWorld</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; stop  in HelloWorld.main                                </span><br><span class="line">Deferring breakpoint HelloWorld.main.</span><br><span class="line">It will be set after the class is loaded.</span><br><span class="line">&gt; run</span><br><span class="line">run HelloWorld</span><br><span class="line">Set uncaught java.lang.Throwable</span><br><span class="line">Set deferred uncaught java.lang.Throwable</span><br><span class="line">&gt; </span><br><span class="line">VM Started: Set deferred breakpoint HelloWorld.main</span><br><span class="line"></span><br><span class="line">Breakpoint hit: &quot;thread=main&quot;, HelloWorld.main(), line=5 bci=0</span><br><span class="line">5            System.out.println(&quot;Hello, World&quot;);</span><br><span class="line"></span><br><span class="line">main[1] </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="使用maven-编写helloworld"><a href="#使用maven-编写helloworld" class="headerlink" title="使用maven 编写helloworld"></a>使用maven 编写helloworld</h2><p>当遇到<code>maven package</code>后，<code>java -java   some.jar</code> 说找不到main的时候可以参考以下答案<br><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/9689877/6229548">https://stackoverflow.com/a/9689877/6229548</a></p>
<h2 id="加载类"><a href="#加载类" class="headerlink" title="加载类"></a>加载类</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  open64 () at ../sysdeps/unix/syscall-template.S:84</span><br><span class="line">#1  0x00007ffff695b544 in os::open (path=0x7ffff7fcefd0 &quot;/home/dinosaur/jdk8/build/linux-x86_64-normal-server-slowdebug/jdk/classes/java/lang/Class.class&quot;, oflag=0, mode=0)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/os/linux/vm/os_linux.cpp:5188</span><br><span class="line">#2  0x00007ffff63ffdfc in ClassPathDirEntry::open_stream (this=0x7ffff006f178, name=0x7ffff000cce8 &quot;java/lang/Class.class&quot;, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/classLoader.cpp:210</span><br><span class="line">#3  0x00007ffff640055b in LazyClassPathEntry::open_stream (this=0x7ffff001ad48, name=0x7ffff000cce8 &quot;java/lang/Class.class&quot;, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/classLoader.cpp:330</span><br><span class="line">#4  0x00007ffff640209b in ClassLoader::load_classfile (h_name=0x7ffff4062108, __the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/classLoader.cpp:909</span><br><span class="line">#5  0x00007ffff6a8570a in SystemDictionary::load_instance_class (class_name=0x7ffff4062108, class_loader=..., __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1304</span><br><span class="line">#6  0x00007ffff6a838b8 in SystemDictionary::resolve_instance_class_or_null (name=0x7ffff4062108, class_loader=..., protection_domain=..., __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:779</span><br><span class="line">#7  0x00007ffff6a81ff7 in SystemDictionary::resolve_or_null (class_name=0x7ffff4062108, class_loader=..., protection_domain=..., __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:232</span><br><span class="line">#8  0x00007ffff6a819f2 in SystemDictionary::resolve_or_fail (class_name=0x7ffff4062108, class_loader=..., protection_domain=..., throw_error=true, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:171</span><br><span class="line">#9  0x00007ffff6a81d64 in SystemDictionary::resolve_or_fail (class_name=0x7ffff4062108, throw_error=true, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:212</span><br><span class="line">#10 0x00007ffff6a87277 in SystemDictionary::initialize_wk_klass (id=SystemDictionary::Class_klass_knum, init_opt=0, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1866</span><br><span class="line">#11 0x00007ffff6a873a7 in SystemDictionary::initialize_wk_klasses_until (limit_id=SystemDictionary::Cloneable_klass_knum, start_id=@0x7ffff7fd0a84: SystemDictionary::Object_klass_knum, </span><br><span class="line">    __the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1882</span><br><span class="line">#12 0x00007ffff6a8b13c in SystemDictionary::initialize_wk_klasses_through (end_id=SystemDictionary::Class_klass_knum, start_id=@0x7ffff7fd0a84: SystemDictionary::Object_klass_knum, </span><br><span class="line">    __the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.hpp:408</span><br><span class="line">#13 0x00007ffff6a874e0 in SystemDictionary::initialize_preloaded_classes (__the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1901</span><br><span class="line">#14 0x00007ffff6a87199 in SystemDictionary::initialize (__the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1843</span><br><span class="line">#15 0x00007ffff6ad68c9 in Universe::genesis (__the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/memory/universe.cpp:288</span><br><span class="line">#16 0x00007ffff6ad8db6 in universe2_init () at /home/dinosaur/jdk8/hotspot/src/share/vm/memory/universe.cpp:991</span><br><span class="line">#17 0x00007ffff66463b3 in init_globals () at /home/dinosaur/jdk8/hotspot/src/share/vm/runtime/init.cpp:114</span><br><span class="line">#18 0x00007ffff6ab93ef in Threads::create_vm (args=0x7ffff7fd0e80, canTryAgain=0x7ffff7fd0e03) at /home/dinosaur/jdk8/hotspot/src/share/vm/runtime/thread.cpp:3424</span><br><span class="line">#19 0x00007ffff6702ed0 in JNI_CreateJavaVM (vm=0x7ffff7fd0ed8, penv=0x7ffff7fd0ee0, args=0x7ffff7fd0e80) at /home/dinosaur/jdk8/hotspot/src/share/vm/prims/jni.cpp:5166</span><br><span class="line">#20 0x00007ffff7bc3bda in InitializeJVM (pvm=0x7ffff7fd0ed8, penv=0x7ffff7fd0ee0, ifn=0x7ffff7fd0f30) at /home/dinosaur/jdk8/jdk/src/share/bin/java.c:1145</span><br><span class="line">#21 0x00007ffff7bc1a36 in JavaMain (_args=0x7fffffffa910) at /home/dinosaur/jdk8/jdk/src/share/bin/java.c:371</span><br><span class="line">#22 0x00007ffff73d66ba in start_thread (arg=0x7ffff7fd1700) at pthread_create.c:333</span><br><span class="line">#23 0x00007ffff78f741d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>加载classloader</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  open64 () at ../sysdeps/unix/syscall-template.S:84</span><br><span class="line">#1  0x00007ffff695b544 in os::open (path=0x7ffff7fcefd0 &quot;/home/dinosaur/jdk8/build/linux-x86_64-normal-server-slowdebug/jdk/classes/java/lang/ClassLoader.class&quot;, oflag=0, mode=0)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/os/linux/vm/os_linux.cpp:5188</span><br><span class="line">#2  0x00007ffff63ffdfc in ClassPathDirEntry::open_stream (this=0x7ffff006f178, name=0x7ffff000cd08 &quot;java/lang/ClassLoader.class&quot;, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/classLoader.cpp:210</span><br><span class="line">#3  0x00007ffff640055b in LazyClassPathEntry::open_stream (this=0x7ffff001ad48, name=0x7ffff000cd08 &quot;java/lang/ClassLoader.class&quot;, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/classLoader.cpp:330</span><br><span class="line">#4  0x00007ffff640209b in ClassLoader::load_classfile (h_name=0x7ffff40621c8, __the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/classLoader.cpp:909</span><br><span class="line">#5  0x00007ffff6a8570a in SystemDictionary::load_instance_class (class_name=0x7ffff40621c8, class_loader=..., __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1304</span><br><span class="line">#6  0x00007ffff6a838b8 in SystemDictionary::resolve_instance_class_or_null (name=0x7ffff40621c8, class_loader=..., protection_domain=..., __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:779</span><br><span class="line">#7  0x00007ffff6a81ff7 in SystemDictionary::resolve_or_null (class_name=0x7ffff40621c8, class_loader=..., protection_domain=..., __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:232</span><br><span class="line">#8  0x00007ffff6a819f2 in SystemDictionary::resolve_or_fail (class_name=0x7ffff40621c8, class_loader=..., protection_domain=..., throw_error=true, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:171</span><br><span class="line">#9  0x00007ffff6a81d64 in SystemDictionary::resolve_or_fail (class_name=0x7ffff40621c8, throw_error=true, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:212</span><br><span class="line">#10 0x00007ffff6a87277 in SystemDictionary::initialize_wk_klass (id=SystemDictionary::ClassLoader_klass_knum, init_opt=0, __the_thread__=0x7ffff000c000)</span><br><span class="line">    at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1866</span><br><span class="line">#11 0x00007ffff6a873a7 in SystemDictionary::initialize_wk_klasses_until (limit_id=SystemDictionary::SoftReference_klass_knum, start_id=@0x7ffff7fd0a84: SystemDictionary::Cloneable_klass_knum, </span><br><span class="line">    __the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1882</span><br><span class="line">#12 0x00007ffff6a8b13c in SystemDictionary::initialize_wk_klasses_through (end_id=SystemDictionary::Reference_klass_knum, start_id=@0x7ffff7fd0a84: SystemDictionary::Cloneable_klass_knum, </span><br><span class="line">    __the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.hpp:408</span><br><span class="line">#13 0x00007ffff6a87553 in SystemDictionary::initialize_preloaded_classes (__the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1918</span><br><span class="line">#14 0x00007ffff6a87199 in SystemDictionary::initialize (__the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/classfile/systemDictionary.cpp:1843</span><br><span class="line">#15 0x00007ffff6ad68c9 in Universe::genesis (__the_thread__=0x7ffff000c000) at /home/dinosaur/jdk8/hotspot/src/share/vm/memory/universe.cpp:288</span><br><span class="line">#16 0x00007ffff6ad8db6 in universe2_init () at /home/dinosaur/jdk8/hotspot/src/share/vm/memory/universe.cpp:991</span><br><span class="line">#17 0x00007ffff66463b3 in init_globals () at /home/dinosaur/jdk8/hotspot/src/share/vm/runtime/init.cpp:114</span><br><span class="line">#18 0x00007ffff6ab93ef in Threads::create_vm (args=0x7ffff7fd0e80, canTryAgain=0x7ffff7fd0e03) at /home/dinosaur/jdk8/hotspot/src/share/vm/runtime/thread.cpp:3424</span><br><span class="line">#19 0x00007ffff6702ed0 in JNI_CreateJavaVM (vm=0x7ffff7fd0ed8, penv=0x7ffff7fd0ee0, args=0x7ffff7fd0e80) at /home/dinosaur/jdk8/hotspot/src/share/vm/prims/jni.cpp:5166</span><br><span class="line">#20 0x00007ffff7bc3bda in InitializeJVM (pvm=0x7ffff7fd0ed8, penv=0x7ffff7fd0ee0, ifn=0x7ffff7fd0f30) at /home/dinosaur/jdk8/jdk/src/share/bin/java.c:1145</span><br><span class="line">#21 0x00007ffff7bc1a36 in JavaMain (_args=0x7fffffffa910) at /home/dinosaur/jdk8/jdk/src/share/bin/java.c:371</span><br><span class="line">#22 0x00007ffff73d66ba in start_thread (arg=0x7ffff7fd1700) at pthread_create.c:333</span><br><span class="line">#23 0x00007ffff78f741d in clone () at ../sysdeps/unix/sysv/linux/x86_64/clone.S:109</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="打印hello-world"><a href="#打印hello-world" class="headerlink" title="打印hello world"></a>打印hello world</h2><p>这是打印hello world 的堆栈，估计是被优化了打印不了完整堆栈</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  write () at ../sysdeps/unix/syscall-template.S:84</span><br><span class="line">#1  0x00007ffff556779a in handleWrite (fd=1, buf=0x7ffff7fce270, len=12)</span><br><span class="line">    at /home/dinosaur/jdk8/jdk/src/solaris/native/java/io/io_util_md.c:164</span><br><span class="line">#2  0x00007ffff556710a in writeBytes (env=0x7ffff000c210, this=0x7ffff7fd0398, bytes=0x7ffff7fd0390, off=0, len=12, append=0 &#x27;\000&#x27;, </span><br><span class="line">    fid=0x47e1043) at /home/dinosaur/jdk8/jdk/src/share/native/java/io/io_util.c:189</span><br><span class="line">#3  0x00007ffff555a79c in Java_java_io_FileOutputStream_writeBytes (env=0x7ffff000c210, this=0x7ffff7fd0398, bytes=0x7ffff7fd0390, </span><br><span class="line">    off=0, len=12, append=0 &#x27;\000&#x27;) at /home/dinosaur/jdk8/jdk/src/solaris/native/java/io/FileOutputStream_md.c:70</span><br><span class="line">#4  0x00007fffe10298dc in ?? ()</span><br><span class="line">#5  0x0000000000000008 in ?? ()</span><br><span class="line">#6  0x0000000000000008 in ?? ()</span><br><span class="line">#7  0x00007ffff000c000 in ?? ()</span><br><span class="line">#8  0x00007fffe02c74d8 in ?? ()</span><br><span class="line">#9  0x00007fffe1028ee3 in ?? ()</span><br><span class="line">#10 0x00007ffff7fd0318 in ?? ()</span><br><span class="line">#11 0x00007fffe0173f60 in ?? ()</span><br><span class="line">#12 0x00007ffff7fd0398 in ?? ()</span><br><span class="line">#13 0x00007fffe0175120 in ?? ()</span><br><span class="line">#14 0x0000000000000000 in ?? ()</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">Hello, World</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line">#0  write () at ../sysdeps/unix/syscall-template.S:84</span><br><span class="line">#1  0x00007ffff556779a in handleWrite (fd=1, buf=0x7ffff7fce2d0, len=1)</span><br><span class="line">    at /home/dinosaur/jdk8/jdk/src/solaris/native/java/io/io_util_md.c:164</span><br><span class="line">#2  0x00007ffff556710a in writeBytes (env=0x7ffff000c210, this=0x7ffff7fd0400, bytes=0x7ffff7fd03f8, off=0, len=1, append=0 &#x27;\000&#x27;, </span><br><span class="line">    fid=0x47e1043) at /home/dinosaur/jdk8/jdk/src/share/native/java/io/io_util.c:189</span><br><span class="line">#3  0x00007ffff555a79c in Java_java_io_FileOutputStream_writeBytes (env=0x7ffff000c210, this=0x7ffff7fd0400, bytes=0x7ffff7fd03f8, </span><br><span class="line">    off=0, len=1, append=0 &#x27;\000&#x27;) at /home/dinosaur/jdk8/jdk/src/solaris/native/java/io/FileOutputStream_md.c:70</span><br><span class="line">#4  0x00007fffe10298dc in ?? ()</span><br><span class="line">#5  0x00007ffff7fd0410 in ?? ()</span><br><span class="line">#6  0x00007ffff672dd43 in JVM_ArrayCopy (env=0x7ffff000c210, ignored=0x7ffff7fd0400, src=0x7ffff7fd03f8, src_pos=0, </span><br><span class="line">    dst=0x7f00f6265bea, dst_pos=1, length=0) at /home/dinosaur/jdk8/hotspot/src/share/vm/prims/jvm.cpp:298</span><br><span class="line">#7  0x00007fffe1007500 in ?? ()</span><br><span class="line">#8  0x0000000000000000 in ?? ()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="java-class-file"><a href="#java-class-file" class="headerlink" title="java class file"></a>java class file</h2><p> <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/jvms8.pdf">4.1 The ClassFile Structure</a></p>
<blockquote>
<p>A class file consists of a stream of 8-bit bytes. All 16-bit, 32-bit, and 64-bit<br>quantities are constructed by reading in two, four, and eight consecutive 8-bit<br>bytes, respectively. Multibyte data items are always stored in big-endian order,<br>where the high bytes come first. In the Java SE platform, this format is supported<br>by interfaces java.io.DataInput and java.io.DataOutput and classes such as<br>java.io.DataInputStream and java.io.DataOutputStream.</p>
</blockquote>
<p>通过jvm文档，可以知道class文件存的<code>magic number</code>是<code>0xCAFEBABE</code>，存储方式是大端的</p>
<p> <a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se8/jvms8.pdf">4.1 The ClassFile Structure</a><br>A class file consists of a single ClassFile structure:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ClassFile &#123;</span><br><span class="line"> u4 magic;</span><br><span class="line"> u2 minor_version;</span><br><span class="line"> u2 major_version;</span><br><span class="line"> u2 constant_pool_count;</span><br><span class="line"> cp_info constant_pool[constant_pool_count-1];</span><br><span class="line"> u2 access_flags;</span><br><span class="line"> u2 this_class;</span><br><span class="line"> u2 super_class;</span><br><span class="line"> u2 interfaces_count;</span><br><span class="line"> u2 interfaces[interfaces_count];</span><br><span class="line"> u2 fields_count;</span><br><span class="line"> field_info fields[fields_count];</span><br><span class="line"> u2 methods_count;</span><br><span class="line"> method_info methods[methods_count];</span><br><span class="line"> u2 attributes_count;</span><br><span class="line"> attribute_info attributes[attributes_count];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The magic item supplies the magic number identifying the class file format;<br>it has the value 0xCAFEBABE.</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dinosaur@dinosaur-X550VXK:~/jdk8/build$ hexdump  HelloWorld.class -C</span><br></pre></td></tr></table></figure>
<p>使用hexdump查看class文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">00000000  ca fe ba be 00 00 00 34  00 1d 0a 00 06 00 0f 09  |.......4........|</span><br><span class="line">00000010  00 10 00 11 08 00 12 0a  00 13 00 14 07 00 15 07  |................|</span><br><span class="line">00000020  00 16 01 00 06 3c 69 6e  69 74 3e 01 00 03 28 29  |.....&lt;init&gt;...()|</span><br><span class="line">00000030  56 01 00 04 43 6f 64 65  01 00 0f 4c 69 6e 65 4e  |V...Code...LineN|</span><br><span class="line">00000040  75 6d 62 65 72 54 61 62  6c 65 01 00 04 6d 61 69  |umberTable...mai|</span><br><span class="line">00000050  6e 01 00 16 28 5b 4c 6a  61 76 61 2f 6c 61 6e 67  |n...([Ljava/lang|</span><br><span class="line">00000060  2f 53 74 72 69 6e 67 3b  29 56 01 00 0a 53 6f 75  |/String;)V...Sou|</span><br><span class="line">00000070  72 63 65 46 69 6c 65 01  00 0f 48 65 6c 6c 6f 57  |rceFile...HelloW|</span><br><span class="line">00000080  6f 72 6c 64 2e 6a 61 76  61 0c 00 07 00 08 07 00  |orld.java.......|</span><br><span class="line">00000090  17 0c 00 18 00 19 01 00  0c 48 65 6c 6c 6f 2c 20  |.........Hello, |</span><br><span class="line">000000a0  57 6f 72 6c 64 07 00 1a  0c 00 1b 00 1c 01 00 0a  |World...........|</span><br><span class="line">000000b0  48 65 6c 6c 6f 57 6f 72  6c 64 01 00 10 6a 61 76  |HelloWorld...jav|</span><br><span class="line">000000c0  61 2f 6c 61 6e 67 2f 4f  62 6a 65 63 74 01 00 10  |a/lang/Object...|</span><br><span class="line">000000d0  6a 61 76 61 2f 6c 61 6e  67 2f 53 79 73 74 65 6d  |java/lang/System|</span><br><span class="line">000000e0  01 00 03 6f 75 74 01 00  15 4c 6a 61 76 61 2f 69  |...out...Ljava/i|</span><br><span class="line">000000f0  6f 2f 50 72 69 6e 74 53  74 72 65 61 6d 3b 01 00  |o/PrintStream;..|</span><br><span class="line">00000100  13 6a 61 76 61 2f 69 6f  2f 50 72 69 6e 74 53 74  |.java/io/PrintSt|</span><br><span class="line">00000110  72 65 61 6d 01 00 07 70  72 69 6e 74 6c 6e 01 00  |ream...println..|</span><br><span class="line">00000120  15 28 4c 6a 61 76 61 2f  6c 61 6e 67 2f 53 74 72  |.(Ljava/lang/Str|</span><br><span class="line">00000130  69 6e 67 3b 29 56 00 21  00 05 00 06 00 00 00 00  |ing;)V.!........|</span><br><span class="line">00000140  00 02 00 01 00 07 00 08  00 01 00 09 00 00 00 1d  |................|</span><br><span class="line">00000150  00 01 00 01 00 00 00 05  2a b7 00 01 b1 00 00 00  |........*.......|</span><br><span class="line">00000160  01 00 0a 00 00 00 06 00  01 00 00 00 01 00 09 00  |................|</span><br><span class="line">00000170  0b 00 0c 00 01 00 09 00  00 00 25 00 02 00 01 00  |..........%.....|</span><br><span class="line">00000180  00 00 09 b2 00 02 12 03  b6 00 04 b1 00 00 00 01  |................|</span><br><span class="line">00000190  00 0a 00 00 00 0a 00 02  00 00 00 05 00 08 00 06  |................|</span><br><span class="line">000001a0  00 01 00 0d 00 00 00 02  00 0e                    |..........|</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们来看看hello world这个class文件的各种内容</p>
<p>第一个是magic number： <code>ca fe ba be</code> 四个字节<br>然后是minor_version：<code>00 00</code><br>major_version:<code>00 34</code>  </p>
<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/9229.html">https://coolshell.cn/articles/9229.html</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/openjdk/jdk/tree/jdk8-b116/langtools/src/share/classes/com/sun/tools/javac">https://github.com/openjdk/jdk/tree/jdk8-b116/langtools/src/share/classes/com/sun/tools/javac</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/whthomas/p/javac.html">https://www.cnblogs.com/whthomas/p/javac.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/09/21/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%98%AF%E4%BB%80%E4%B9%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/21/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E6%98%AF%E4%BB%80%E4%B9%88/" class="post-title-link" itemprop="url">环境变量是什么</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-21 09:41:16" itemprop="dateCreated datePublished" datetime="2019-09-21T09:41:16+08:00">2019-09-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h1><p>当我们使用shell 的命令<code>env</code>命令的时候可以看到很多字符串，那些就是这个进程的环境变量</p>
<h1 id="环境变量怎么存"><a href="#环境变量怎么存" class="headerlink" title="环境变量怎么存"></a>环境变量怎么存</h1><blockquote>
<p>The first two arguments are just the same. The third argument envp gives the program’s environment; it is the same as the value of environ. See Environment Variables. POSIX.1 does not allow this three-argument form, so to be portable it is best to write main to take two arguments, and use the value of <strong>environ</strong>.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.oracle.com/cd/E36784_01/html/E36872/exec-2.html#REFMAN2exec-2">posix 相关文档</a></p>
<blockquote>
<p>where argc is the argument count and argv is an array of character pointers to the arguments themselves. In addition, the following variable:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern char **environ;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>is initialized as a pointer to an array of character pointers to the environment strings. The argv and environ arrays are each terminated by a null pointer. The null pointer terminating the argv array is not counted in argc.</p>
</blockquote>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>下面是例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line"></span><br><span class="line">extern char **environ;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char *argv[]) &#123;</span><br><span class="line">  printf(&quot;environment variables:\n&quot;);</span><br><span class="line">  int i = 0;</span><br><span class="line">  while (environ[i]) &#123;</span><br><span class="line">    printf(&quot;%p\t%s\n&quot;, environ[i], environ[i]);</span><br><span class="line">    i++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  printf(&quot;argv:\n&quot;);</span><br><span class="line">  for (int i = 0; i &lt; argc; i++) &#123;</span><br><span class="line">    printf(&quot;%p\t%s\n&quot;, argv[i], argv[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译后会把这些打印出来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -o main</span><br><span class="line">dinosaur@dinosaur-X550VXK:~/test$ ./main </span><br><span class="line">environment variables:</span><br><span class="line">0x7ffc250920c7	XDG_VTNR=7</span><br><span class="line">0x7ffc250920d2	LC_PAPER=zh_CN.UTF-8</span><br><span class="line">0x7ffc250920e7	LC_ADDRESS=zh_CN.UTF-8</span><br><span class="line">0x7ffc250920fe	XDG_SESSION_ID=c1</span><br><span class="line">0x7ffc25092110	XDG_GREETER_DATA_DIR=/var/lib/lightdm-data/dinosaur</span><br><span class="line">0x7ffc25092144	LC_MONETARY=zh_CN.UTF-8</span><br><span class="line">0x7ffc2509215c	CLUTTER_IM_MODULE=xim</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="glibc变量"><a href="#glibc变量" class="headerlink" title="glibc变量"></a>glibc变量</h2><h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>定义在<code>glibc-master/posix/environ.c</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/* This file just defines the `__environ&#x27; variable (and alias `environ&#x27;).  */</span><br><span class="line"></span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;stddef.h&gt;</span><br><span class="line"></span><br><span class="line">/* This must be initialized; we cannot have a weak alias into bss.  */</span><br><span class="line">char **__environ = NULL;</span><br><span class="line">weak_alias (__environ, environ)    // 弱引用 其实environ 就是__environ</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="读getenv"><a href="#读getenv" class="headerlink" title="读getenv"></a>读getenv</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">char *</span><br><span class="line">getenv (const char *name)</span><br><span class="line">&#123;</span><br><span class="line">  size_t len = strlen (name);</span><br><span class="line">  char **ep;</span><br><span class="line">  uint16_t name_start;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    name_start = *(const uint16_t *) name;</span><br><span class="line">    ...</span><br><span class="line">    len -= 2;</span><br><span class="line">    name += 2;</span><br><span class="line"></span><br><span class="line">      for (ep = __environ; *ep != NULL; ++ep)</span><br><span class="line">	&#123;</span><br><span class="line">	  uint16_t ep_start = *(uint16_t *) *ep;</span><br><span class="line"></span><br><span class="line">	  if (name_start == ep_start &amp;&amp; !strncmp (*ep + 2, name, len)</span><br><span class="line">	      &amp;&amp; (*ep)[len + 2] == &#x27;=&#x27;)</span><br><span class="line">	    return &amp;(*ep)[len + 3];</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  return NULL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="写-putenv-setenv"><a href="#写-putenv-setenv" class="headerlink" title="写 putenv setenv"></a>写 putenv setenv</h3><p>putenv setenv 都调用<code>__add_to_environ</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">__add_to_environ (const char *name, const char *value, const char *combined,</span><br><span class="line">		  int replace)</span><br><span class="line">&#123;</span><br><span class="line">     const size_t namelen = strlen (name);</span><br><span class="line">  size_t vallen;</span><br><span class="line">    ...</span><br><span class="line">    vallen = strlen (value) + 1;</span><br><span class="line">    ...</span><br><span class="line">     const size_t varlen = namelen + 1 + vallen;</span><br><span class="line">     ...</span><br><span class="line">      memcpy (new_value, name, namelen);</span><br><span class="line">	  new_value[namelen] = &#x27;=&#x27;;</span><br><span class="line">	  memcpy (&amp;new_value[namelen + 1], value, vallen);</span><br><span class="line">      ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是<code>char ** environ</code> 变量存着 <code>key=value</code>的字符串</p>
<h2 id="如何以及什么时机继承"><a href="#如何以及什么时机继承" class="headerlink" title="如何以及什么时机继承"></a>如何以及什么时机继承</h2><p>&#x2F;&#x2F; todo 有空扒一下</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>环境变量是一堆字符串，继承通过进程父子关系</p>
<p>1 <a target="_blank" rel="noopener" href="https://www.polarxiong.com/archives/%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E7%9A%84%E6%9D%A5%E6%BA%90-%E5%8E%9F%E7%90%86%E4%B8%8E%E5%BA%94%E7%94%A8.html">环境变量的来源、原理与应用</a></p>
<p>2 <a target="_blank" rel="noopener" href="https://www.gnu.org/software/libc/manual/html_node/Program-Arguments.html#Program-Arguments">glibc 文档</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/09/19/cors-%E7%9B%B8%E5%85%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/19/cors-%E7%9B%B8%E5%85%B3/" class="post-title-link" itemprop="url">cors 相关</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-19 22:49:45" itemprop="dateCreated datePublished" datetime="2019-09-19T22:49:45+08:00">2019-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>谈到cors之前，必须先谈同源策略和跨域。</p>
<h4 id="为什么要跨域"><a href="#为什么要跨域" class="headerlink" title="为什么要跨域"></a>为什么要跨域</h4><p>同源策略限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于隔离潜在恶意文件的重要安全机制。而且这些是浏览器自己限制的。</p>
<p><a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6454">rfc 6454</a></p>
<blockquote>
<p>User agents interact with content created by a large number of<br>   authors.  Although many of those authors are well-meaning, some<br>   authors might be malicious.  To the extent that user agents undertake<br>   actions based on content they process, <strong>user agent</strong> implementors might<br>   wish to restrict the ability of malicious authors to disrupt the<br>   confidentiality or integrity of other content or servers.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000015597029">详细的相关内容</a></p>
<h2 id="cors"><a href="#cors" class="headerlink" title="cors"></a>cors</h2><p><a target="_blank" rel="noopener" href="https://www.poorren.com/cross-origin-resource-sharing-simple-complex">相关阅读</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.im/post/5c46af87e51d4552232feaeb">相关阅读2</a></p>
<h2 id="简单请求"><a href="#简单请求" class="headerlink" title="简单请求"></a>简单请求</h2><p><strong>简单请求</strong>就是不会触发cors预检请求的请求.</p>
<blockquote>
<p>某些请求不会触发 CORS 预检请求。本文称这样的请求为“简单请求”，请注意，该术语并不属于 Fetch （其中定义了 CORS）规范。若请求满足所有下述条件，则该请求可视为“简单请求”：</p>
</blockquote>
<p>使用下列方法之一：<br>GET<br>HEAD<br>POST<br>Fetch 规范定义了对 CORS 安全的首部字段集合，不得人为设置该集合之外的其他首部字段。该集合为：<br>Accept<br>Accept-Language<br>Content-Language<br>Content-Type （需要注意额外的限制）<br>DPR<br>Downlink<br>Save-Data<br>Viewport-Width<br>Width<br>Content-Type 的值仅限于下列三者之一：<br>text&#x2F;plain<br>multipart&#x2F;form-data<br>application&#x2F;x-www-form-urlencoded<br>请求中的任意XMLHttpRequestUpload 对象均没有注册任何事件监听器；XMLHttpRequestUpload 对象可以使用 XMLHttpRequest.upload 属性访问。<br>请求中没有使用 ReadableStream 对象。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2019/09/18/golang-interface-%E6%AF%94%E8%BE%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/09/18/golang-interface-%E6%AF%94%E8%BE%83/" class="post-title-link" itemprop="url">golang interface 比较</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2019-09-18 21:05:48" itemprop="dateCreated datePublished" datetime="2019-09-18T21:05:48+08:00">2019-09-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://golang.org/ref/spec#Comparison_operators">来源</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Interface values are comparable. Two interface values are equal if they have identical dynamic types and equal dynamic values or if both have value nil.</span><br><span class="line">A value x of non-interface type X and a value t of interface type T are comparable when values of type X are comparable and X implements T. They are equal if t&#x27;s dynamic type is identical to X and t&#x27;s dynamic value is equal to x.</span><br><span class="line"></span><br><span class="line">A comparison of two interface values with identical dynamic types causes a run-time panic if values of that type are not comparable. This behavior applies not only to direct interface value comparisons but also when comparing arrays of interface values or structs with interface-valued fields.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>interface 是可以比较的,当两个interface满足以下之一的时候两者相等：</p>
<ul>
<li>两个interface的动态类型和动态值两两相等</li>
<li>两个interface值都是<code>nil</code></li>
</ul>
<p>当一个是interface,一个不是interface的时候，满足以下条件才能可比较：</p>
<ul>
<li>x 是类型X的值，t是类型T的值。只有X是可比较且X是T的实现的时候，x和t是可比较的</li>
</ul>
<p>那么当一个是interface,一个不是interface的时候，可比较的时候，怎么样才能相等呢？</p>
<ul>
<li>当t的动态类型和X相同且t的动态值与x相同</li>
</ul>
<p>当比较两个interface的时候，如果他们的类型是不可比较的，那么会产生运行时<code>panic</code>，这种panic不仅仅会发生在interface直接比较。还会发生在interface数组比较或者包含interface作为structs中的字段时候的structs之间的比较。</p>
<h2 id="相关分析"><a href="#相关分析" class="headerlink" title="相关分析"></a><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27652856">相关分析</a></h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/24/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><span class="page-number current">25</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/26/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">dinosaur</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">256</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/769344359" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;769344359" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/thedinosaurmail@gmail.com" title="E-Mail → thedinosaurmail@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dinosaur</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
