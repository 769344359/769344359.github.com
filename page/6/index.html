<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"shakudada.xyz","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"appID":"79C1GXGOC6","apiKey":"225fa4bf2bc37c3e46a671682674fe37","indexName":"my-hexo-blog","hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="dinosaur">
<meta property="og:url" content="https://shakudada.xyz/page/6/index.html">
<meta property="og:site_name" content="dinosaur">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="dinosaur">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://shakudada.xyz/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>dinosaur</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dinosaur</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/04/14/java-rabbitmq-%E5%88%9D%E5%A7%8B%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/14/java-rabbitmq-%E5%88%9D%E5%A7%8B%E5%8C%96/" class="post-title-link" itemprop="url">java rabbitmq 初始化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-14 19:28:17" itemprop="dateCreated datePublished" datetime="2023-04-14T19:28:17+08:00">2023-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>了解java的spring boot 的rabbitmq的启动流程</p>
<h2 id="堆栈"><a href="#堆栈" class="headerlink" title="堆栈"></a>堆栈</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">declareQueues:700, RabbitAdmin (org.springframework.amqp.rabbit.core)</span><br><span class="line">lambda$initialize$12:606, RabbitAdmin (org.springframework.amqp.rabbit.core)</span><br><span class="line">doInRabbit:-1, 1826902085 (org.springframework.amqp.rabbit.core.RabbitAdmin$$Lambda$965)</span><br><span class="line">invokeAction:2151, RabbitTemplate (org.springframework.amqp.rabbit.core)</span><br><span class="line">doExecute:2110, RabbitTemplate (org.springframework.amqp.rabbit.core)</span><br><span class="line">execute:2062, RabbitTemplate (org.springframework.amqp.rabbit.core)</span><br><span class="line">execute:2042, RabbitTemplate (org.springframework.amqp.rabbit.core)</span><br><span class="line">initialize:604, RabbitAdmin (org.springframework.amqp.rabbit.core)</span><br><span class="line">lambda$null$10:532, RabbitAdmin (org.springframework.amqp.rabbit.core)</span><br><span class="line">doWithRetry:-1, 999782961 (org.springframework.amqp.rabbit.core.RabbitAdmin$$Lambda$957)</span><br><span class="line">doExecute:287, RetryTemplate (org.springframework.retry.support)</span><br><span class="line">execute:164, RetryTemplate (org.springframework.retry.support)</span><br><span class="line">lambda$afterPropertiesSet$11:531, RabbitAdmin (org.springframework.amqp.rabbit.core)</span><br><span class="line">onCreate:-1, 1185831500 (org.springframework.amqp.rabbit.core.RabbitAdmin$$Lambda$950)</span><br><span class="line">lambda$onCreate$0:38, CompositeConnectionListener (org.springframework.amqp.rabbit.connection)</span><br><span class="line">accept:-1, 1588281004 (org.springframework.amqp.rabbit.connection.CompositeConnectionListener$$Lambda$956)</span><br><span class="line">forEach:803, CopyOnWriteArrayList (java.util.concurrent)</span><br><span class="line">onCreate:38, CompositeConnectionListener (org.springframework.amqp.rabbit.connection)</span><br><span class="line">createConnection:757, CachingConnectionFactory (org.springframework.amqp.rabbit.connection)</span><br><span class="line">createConnection:216, ConnectionFactoryUtils (org.springframework.amqp.rabbit.connection)</span><br><span class="line">doExecute:2089, RabbitTemplate (org.springframework.amqp.rabbit.core)</span><br><span class="line">execute:2062, RabbitTemplate (org.springframework.amqp.rabbit.core)</span><br><span class="line">execute:2042, RabbitTemplate (org.springframework.amqp.rabbit.core)</span><br><span class="line">declareExchange:221, RabbitAdmin (org.springframework.amqp.rabbit.core)</span><br><span class="line">cdpOrderTopicExchange:27, RabbitConfig (com.patpat.mms.mdp.base.core.rest.config)</span><br><span class="line">CGLIB$cdpOrderTopicExchange$7:-1, RabbitConfig$$EnhancerBySpringCGLIB$$65dbc353 (com.patpat.mms.mdp.base.core.rest.config)</span><br><span class="line">invoke:-1, RabbitConfig$$EnhancerBySpringCGLIB$$65dbc353$$FastClassBySpringCGLIB$$bdc910b3 (com.patpat.mms.mdp.base.core.rest.config)</span><br><span class="line">invokeSuper:244, MethodProxy (org.springframework.cglib.proxy)</span><br><span class="line">intercept:331, ConfigurationClassEnhancer$BeanMethodInterceptor (org.springframework.context.annotation)</span><br><span class="line">cdpOrderTopicExchange:-1, RabbitConfig$$EnhancerBySpringCGLIB$$65dbc353 (com.patpat.mms.mdp.base.core.rest.config)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (jdk.internal.reflect)</span><br><span class="line">invoke:566, Method (java.lang.reflect)</span><br><span class="line">instantiate:154, SimpleInstantiationStrategy (org.springframework.beans.factory.support)</span><br><span class="line">instantiate:652, ConstructorResolver (org.springframework.beans.factory.support)</span><br><span class="line">instantiateUsingFactoryMethod:637, ConstructorResolver (org.springframework.beans.factory.support)</span><br><span class="line">instantiateUsingFactoryMethod:1341, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)</span><br><span class="line">createBeanInstance:1181, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)</span><br><span class="line">doCreateBean:556, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)</span><br><span class="line">createBean:516, AbstractAutowireCapableBeanFactory (org.springframework.beans.factory.support)</span><br><span class="line">lambda$doGetBean$0:324, AbstractBeanFactory (org.springframework.beans.factory.support)</span><br><span class="line">getObject:-1, 1735872041 (org.springframework.beans.factory.support.AbstractBeanFactory$$Lambda$295)</span><br><span class="line">getSingleton:234, DefaultSingletonBeanRegistry (org.springframework.beans.factory.support)</span><br><span class="line">doGetBean:322, AbstractBeanFactory (org.springframework.beans.factory.support)</span><br><span class="line">getBean:202, AbstractBeanFactory (org.springframework.beans.factory.support)</span><br><span class="line">preInstantiateSingletons:897, DefaultListableBeanFactory (org.springframework.beans.factory.support)</span><br><span class="line">finishBeanFactoryInitialization:879, AbstractApplicationContext (org.springframework.context.support)</span><br><span class="line">refresh:551, AbstractApplicationContext (org.springframework.context.support)</span><br><span class="line">refresh:755, SpringApplication (org.springframework.boot)</span><br><span class="line">refresh:747, SpringApplication (org.springframework.boot)</span><br><span class="line">refreshContext:402, SpringApplication (org.springframework.boot)</span><br><span class="line">run:312, SpringApplication (org.springframework.boot)</span><br><span class="line">loadContext:120, SpringBootContextLoader (org.springframework.boot.test.context)</span><br><span class="line">loadContextInternal:99, DefaultCacheAwareContextLoaderDelegate (org.springframework.test.context.cache)</span><br><span class="line">loadContext:124, DefaultCacheAwareContextLoaderDelegate (org.springframework.test.context.cache)</span><br><span class="line">getApplicationContext:123, DefaultTestContext (org.springframework.test.context.support)</span><br><span class="line">setUpRequestContextIfNecessary:190, ServletTestExecutionListener (org.springframework.test.context.web)</span><br><span class="line">prepareTestInstance:132, ServletTestExecutionListener (org.springframework.test.context.web)</span><br><span class="line">prepareTestInstance:244, TestContextManager (org.springframework.test.context)</span><br><span class="line">createTest:227, SpringJUnit4ClassRunner (org.springframework.test.context.junit4)</span><br><span class="line">runReflectiveCall:289, SpringJUnit4ClassRunner$1 (org.springframework.test.context.junit4)</span><br><span class="line">run:12, ReflectiveCallable (org.junit.internal.runners.model)</span><br><span class="line">methodBlock:291, SpringJUnit4ClassRunner (org.springframework.test.context.junit4)</span><br><span class="line">runChild:246, SpringJUnit4ClassRunner (org.springframework.test.context.junit4)</span><br><span class="line">runChild:97, SpringJUnit4ClassRunner (org.springframework.test.context.junit4)</span><br><span class="line">run:331, ParentRunner$4 (org.junit.runners)</span><br><span class="line">schedule:79, ParentRunner$1 (org.junit.runners)</span><br><span class="line">runChildren:329, ParentRunner (org.junit.runners)</span><br><span class="line">access$100:66, ParentRunner (org.junit.runners)</span><br><span class="line">evaluate:293, ParentRunner$2 (org.junit.runners)</span><br><span class="line">evaluate:61, RunBeforeTestClassCallbacks (org.springframework.test.context.junit4.statements)</span><br><span class="line">evaluate:70, RunAfterTestClassCallbacks (org.springframework.test.context.junit4.statements)</span><br><span class="line">evaluate:306, ParentRunner$3 (org.junit.runners)</span><br><span class="line">run:413, ParentRunner (org.junit.runners)</span><br><span class="line">run:190, SpringJUnit4ClassRunner (org.springframework.test.context.junit4)</span><br><span class="line">run:137, JUnitCore (org.junit.runner)</span><br><span class="line">startRunnerWithArgs:69, JUnit4IdeaTestRunner (com.intellij.junit4)</span><br><span class="line">execute:38, IdeaTestRunner$Repeater$1 (com.intellij.rt.junit)</span><br><span class="line">repeat:11, TestsRepeater (com.intellij.rt.execution.junit)</span><br><span class="line">startRunnerWithArgs:35, IdeaTestRunner$Repeater (com.intellij.rt.junit)</span><br><span class="line">prepareStreamsAndStart:235, JUnitStarter (com.intellij.rt.junit)</span><br><span class="line">main:54, JUnitStarter (com.intellij.rt.junit)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/04/14/kafka%E7%BC%96%E8%AF%91%E5%92%8C%E5%90%AF%E5%8A%A8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/14/kafka%E7%BC%96%E8%AF%91%E5%92%8C%E5%90%AF%E5%8A%A8-1/" class="post-title-link" itemprop="url">kafka编译和启动</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-14 08:05:13" itemprop="dateCreated datePublished" datetime="2023-04-14T08:05:13+08:00">2023-04-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>了解kafka使用</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">## 拉代码</span><br><span class="line">git clone https://github.com/apache/kafka.git</span><br><span class="line">## 切换目录</span><br><span class="line">cd kafka/</span><br><span class="line">## 编译 打包</span><br><span class="line">./gradlew jar</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译好之后需要启动zookeeper 和kafka</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## 在一个窗口启动zookeeper</span><br><span class="line">bin/zookeeper-server-start.sh config/zookeeper.properties</span><br><span class="line"></span><br><span class="line">## 在另外一个窗口启动kafka</span><br><span class="line">bin/zookeeper-server-start.sh config/zookeeper.properties</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/04/12/arroyo-%E7%BC%96%E8%AF%91%E5%92%8C%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/12/arroyo-%E7%BC%96%E8%AF%91%E5%92%8C%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">arroyo 编译和使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-12 13:30:48" itemprop="dateCreated datePublished" datetime="2023-04-12T13:30:48+08:00">2023-04-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p><a target="_blank" rel="noopener" href="https://github.com/ArroyoSystems/arroyo">github 地址</a><br>Arroyo 是分布式流式引擎,使用Rust编写.因为要试用,所以写了这篇</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><ul>
<li><p>安装rust</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --proto &#x27;=https&#x27; --tlsv1.2 -sSf https://sh.rustup.rs | sh</span><br></pre></td></tr></table></figure></li>
<li><p>拉取代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ArroyoSystems/arroyo.git</span><br></pre></td></tr></table></figure>
</li>
<li><p>安装postgresql</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install postgresql</span><br></pre></td></tr></table></figure></li>
</ul>
<p>配置路径：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/postgresql/14/main/pg_hba.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">## 链接postgresql</span><br><span class="line">sudo -u postgres psql</span><br><span class="line">## 创建database arroyo</span><br><span class="line">create database arroyo;</span><br><span class="line">## 执行sql , 要执行这个路径的</span><br><span class="line">source  arroyo/arroyo-api/migrations/V1__initial.sql</span><br><span class="line"></span><br><span class="line">##postgresql 创建用户</span><br><span class="line">create user arroyo with password &#x27;arroyo&#x27;;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">## 重启postgresql</span><br><span class="line">sudo systemctl restart postgresql.service</span><br></pre></td></tr></table></figure>


<ul>
<li>编译<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">## 切换目录</span><br><span class="line">cd arroyo</span><br><span class="line">## 编译</span><br><span class="line">cargo build</span><br><span class="line">## 如果编译不了,用</span><br><span class="line">cargo build --no-default-features </span><br></pre></td></tr></table></figure>
编译结果：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Compiling datafusion-optimizer v20.0.0</span><br><span class="line"> Compiling datafusion v20.0.0</span><br><span class="line"> Compiling arroyo-sql v0.1.0 (/home/dai/rust/arroyo/arroyo-sql)</span><br><span class="line"> Compiling arroyo-sql-macro v0.1.0 (/home/dai/rust/arroyo/arroyo-sql-macro)</span><br><span class="line"> Compiling arroyo-sql-testing v0.1.0 (/home/dai/rust/arroyo/arroyo-sql-testing)</span><br><span class="line">  Finished dev [unoptimized + debuginfo] target(s) in 2m 13s</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="错误和处理"><a href="#错误和处理" class="headerlink" title="错误和处理"></a>错误和处理</h2><p>发现没有ssl的库,我的系统是Ubuntu,所以执行<code>sudo apt install libssl-dev</code> , 如果编译不了用<code>cargo build --no-default-features</code> 试试</p>
<p><a target="_blank" rel="noopener" href="https://github.com/getsentry/sentry-rust/issues/227">相关阅读</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/04/09/direct-memory-in-java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/09/direct-memory-in-java/" class="post-title-link" itemprop="url">direct memory in java</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-09 10:51:51" itemprop="dateCreated datePublished" datetime="2023-04-09T10:51:51+08:00">2023-04-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>lucene 使用了direct memory,这类内存是非jvm直接管理的内存</p>
<p><code>DirectByteBufferR</code> 是read only 版本的<code>DirectByteBuffer</code>，所以<code>DirectByteBuffer</code>和<code>DirectByteBufferR</code>是差不多的类</p>
<h2 id="lucene的mmap"><a href="#lucene的mmap" class="headerlink" title="lucene的mmap"></a>lucene的mmap</h2><p>lucene 会使用DirectByteBufferR,这里申请的内存地址是<code>140063879776283</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">main[1] dump receiver</span><br><span class="line"> receiver = &#123;</span><br><span class="line">    $assertionsDisabled: true</span><br><span class="line">    java.nio.DirectByteBuffer.ARRAY_BASE_OFFSET: 16</span><br><span class="line">    java.nio.DirectByteBuffer.UNALIGNED: true</span><br><span class="line">    java.nio.DirectByteBuffer.att: instance of java.nio.DirectByteBufferR(id=1500)</span><br><span class="line">    java.nio.DirectByteBuffer.cleaner: null</span><br><span class="line">    java.nio.DirectByteBuffer.$assertionsDisabled: true</span><br><span class="line">    java.nio.MappedByteBuffer.fd: instance of java.io.FileDescriptor(id=1501)</span><br><span class="line">    java.nio.MappedByteBuffer.isSync: false</span><br><span class="line">    java.nio.MappedByteBuffer.SCOPED_MEMORY_ACCESS: instance of jdk.internal.misc.ScopedMemoryAccess(id=1502)</span><br><span class="line">    java.nio.ByteBuffer.ARRAY_BASE_OFFSET: 16</span><br><span class="line">    java.nio.ByteBuffer.hb: null</span><br><span class="line">    java.nio.ByteBuffer.offset: 0</span><br><span class="line">    java.nio.ByteBuffer.isReadOnly: true</span><br><span class="line">    java.nio.ByteBuffer.bigEndian: false</span><br><span class="line">    java.nio.ByteBuffer.nativeByteOrder: true</span><br><span class="line">    java.nio.ByteBuffer.$assertionsDisabled: true</span><br><span class="line">    java.nio.Buffer.UNSAFE: instance of jdk.internal.misc.Unsafe(id=1503)</span><br><span class="line">    java.nio.Buffer.SCOPED_MEMORY_ACCESS: instance of jdk.internal.misc.ScopedMemoryAccess(id=1502)</span><br><span class="line">    java.nio.Buffer.SPLITERATOR_CHARACTERISTICS: 16464</span><br><span class="line">    java.nio.Buffer.mark: -1</span><br><span class="line">    java.nio.Buffer.position: 0</span><br><span class="line">    java.nio.Buffer.limit: 7</span><br><span class="line">    java.nio.Buffer.capacity: 7</span><br><span class="line">    java.nio.Buffer.address: 140063879776283</span><br><span class="line">    java.nio.Buffer.segment: null</span><br><span class="line">    java.nio.Buffer.$assertionsDisabled: true</span><br><span class="line">&#125;</span><br><span class="line">main[1] where</span><br><span class="line">  [1] org.apache.lucene.store.ByteBufferGuard.getByte (ByteBufferGuard.java:118)</span><br><span class="line">  [2] org.apache.lucene.store.ByteBufferIndexInput$SingleBufferImpl.readByte (ByteBufferIndexInput.java:593)</span><br><span class="line">  [3] org.apache.lucene.codecs.lucene90.Lucene90NormsProducer$3.longValue (Lucene90NormsProducer.java:388)</span><br><span class="line">  [4] org.apache.lucene.search.LeafSimScorer.getNormValue (LeafSimScorer.java:47)</span><br><span class="line">  [5] org.apache.lucene.search.LeafSimScorer.score (LeafSimScorer.java:60)</span><br><span class="line">  [6] org.apache.lucene.search.TermScorer.score (TermScorer.java:75)</span><br><span class="line">  [7] org.apache.lucene.search.TopScoreDocCollector$SimpleTopScoreDocCollector$1.collect (TopScoreDocCollector.java:73)</span><br><span class="line">  [8] org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll (Weight.java:305)</span><br><span class="line">  [9] org.apache.lucene.search.Weight$DefaultBulkScorer.score (Weight.java:247)</span><br><span class="line">  [10] org.apache.lucene.search.BulkScorer.score (BulkScorer.java:38)</span><br><span class="line">  [11] org.apache.lucene.search.IndexSearcher.search (IndexSearcher.java:770)</span><br><span class="line">  [12] org.apache.lucene.search.IndexSearcher.search (IndexSearcher.java:693)</span><br><span class="line">  [13] org.apache.lucene.search.IndexSearcher.search (IndexSearcher.java:687)</span><br><span class="line">  [14] org.apache.lucene.search.IndexSearcher.searchAfter (IndexSearcher.java:532)</span><br><span class="line">  [15] org.apache.lucene.search.IndexSearcher.search (IndexSearcher.java:542)</span><br><span class="line">  [16] org.apache.lucene.demo.SearchFiles.doPagingSearch (SearchFiles.java:180)</span><br><span class="line">  [17] org.apache.lucene.demo.SearchFiles.main (SearchFiles.java:150)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>查看<code>_7.cfs</code> 文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C /home/dai/index/_7.cfs</span><br><span class="line">00000000  3f d7 6c 17 14 4c 75 63  65 6e 65 39 30 43 6f 6d  |?.l..Lucene90Com|</span><br><span class="line">00000010  70 6f 75 6e 64 44 61 74  61 00 00 00 00 6b f0 66  |poundData....k.f|</span><br><span class="line">00000020  56 c3 12 5b 07 08 12 3a  32 4d 4b 92 f8 00 00 00  |V..[...:2MK.....|</span><br><span class="line">00000030  3f d7 6c 17 17 4c 75 63  65 6e 65 39 30 46 69 65  |?.l..Lucene90Fie|</span><br><span class="line">00000040  6c 64 73 49 6e 64 65 78  4d 65 74 61 00 00 00 01  |ldsIndexMeta....|</span><br><span class="line">00000050  6b f0 66 56 c3 12 5b 07  08 12 3a 32 4d 4b 92 f8  |k.fV..[...:2MK..|</span><br><span class="line">00000060  00 80 80 05 07 00 00 00  0a 00 00 00 02 00 00 00  |................|</span><br><span class="line">00000070  30 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |0...............|</span><br><span class="line">00000080  00 00 e0 40 00 00 00 00  00 00 00 00 00 30 00 00  |...@.........0..|</span><br><span class="line">00000090  00 00 00 00 00 36 00 00  00 00 00 00 00 00 00 5d  |.....6.........]|</span><br><span class="line">000000a0  43 00 00 00 00 00 00 00  00 00 30 00 00 00 00 00  |C.........0.....|</span><br><span class="line">000000b0  00 00 13 01 00 00 00 00  00 00 01 01 07 c0 28 93  |..............(.|</span><br><span class="line">000000c0  e8 00 00 00 00 00 00 00  00 46 80 fe 32 00 00 00  |.........F..2...|</span><br><span class="line">000000d0  3f d7 6c 17 19 4c 75 63  65 6e 65 39 30 50 6f 69  |?.l..Lucene90Poi|</span><br><span class="line">000000e0  6e 74 73 46 6f 72 6d 61  74 49 6e 64 65 78 00 00  |ntsFormatIndex..|</span><br><span class="line">000000f0  00 00 6b f0 66 56 c3 12  5b 07 08 12 3a 32 4d 4b  |..k.fV..[...:2MK|</span><br><span class="line">00000100  92 f8 00 32 c0 28 93 e8  00 00 00 00 00 00 00 00  |...2.(..........|</span><br><span class="line">00000110  0a 2f 94 55 00 00 00 00  3f d7 6c 17 18 4c 75 63  |./.U....?.l..Luc|</span><br><span class="line">00000120  65 6e 65 39 30 50 6f 69  6e 74 73 46 6f 72 6d 61  |ene90PointsForma|</span><br><span class="line">00000130  74 4d 65 74 61 00 00 00  00 6b f0 66 56 c3 12 5b  |tMeta....k.fV..[|</span><br><span class="line">00000140  07 08 12 3a 32 4d 4b 92  f8 00 01 00 00 00 3f d7  |...:2MK.......?.|</span><br><span class="line">00000150  6c 17 03 42 4b 44 00 00  00 09 01 01 80 04 08 01  |l..BKD..........|</span><br><span class="line">00000160  80 00 01 81 b4 f6 00 0f  80 00 01 81 b5 2b 3d 9d  |.............+=.|</span><br><span class="line">00000170  07 07 01 32 00 00 00 00  00 00 00 33 00 00 00 00  |...2.......3....|</span><br><span class="line">00000180  00 00 00 ff ff ff ff 44  00 00 00 00 00 00 00 72  |.......D.......r|</span><br><span class="line">00000190  00 00 00 00 00 00 00 c0  28 93 e8 00 00 00 00 00  |........(.......|</span><br><span class="line">000001a0  00 00 00 09 71 1c 79 00  3f d7 6c 17 12 42 6c 6f  |....q.y.?.l..Blo|</span><br><span class="line">000001b0  63 6b 54 72 65 65 54 65  72 6d 73 4d 65 74 61 00  |ckTreeTermsMeta.|</span><br><span class="line">000001c0  00 00 00 6b f0 66 56 c3  12 5b 07 08 12 3a 32 4d  |...k.fV..[...:2M|</span><br><span class="line">000001d0  4b 92 f8 0a 4c 75 63 65  6e 65 39 30 5f 30 3f d7  |K...Lucene90_0?.|</span><br><span class="line">000001e0  6c 17 1b 4c 75 63 65 6e  65 39 30 50 6f 73 74 69  |l..Lucene90Posti|</span><br><span class="line">000001f0  6e 67 73 57 72 69 74 65  72 54 65 72 6d 73 00 00  |ngsWriterTerms..|</span><br><span class="line">00000200  00 00 6b f0 66 56 c3 12  5b 07 08 12 3a 32 4d 4b  |..k.fV..[...:2MK|</span><br><span class="line">00000210  92 f8 0a 4c 75 63 65 6e  65 39 30 5f 30 80 01 02  |...Lucene90_0...|</span><br><span class="line">00000220  02 8c 01 0c db 01 03 62  af 05 67 cf 09 6d 95 14  |.......b..g..m..|</span><br><span class="line">00000230  c2 02 a5 01 06 01 30 03  cd b1 69 37 3f d7 6c 17  |......0...i7?.l.|</span><br><span class="line">00000240  03 46 53 54 00 00 00 08  01 0d 14 95 6d 09 cf 67  |.FST........m..g|</span><br><span class="line">00000250  05 af 62 03 01 db 0c 00  00 01 00 07 02 a2 37 07  |..b...........7.|</span><br><span class="line">00000260  07 16 2f 68 6f 6d 65 2f  64 61 69 2f 64 6f 63 73  |../home/dai/docs|</span><br><span class="line">00000270  2f 61 61 61 2e 74 78 74  1f 2f 68 6f 6d 65 2f 64  |/aaa.txt./home/d|</span><br><span class="line">00000280  61 69 2f 64 6f 63 73 2f  69 6e 64 65 78 2f 77 72  |ai/docs/index/wr|</span><br><span class="line">00000290  69 74 65 2e 6c 6f 63 6b  38 3f d7 6c 17 03 46 53  |ite.lock8?.l..FS|</span><br><span class="line">000002a0  54 00 00 00 08 01 03 37  a2 02 00 00 01 49 00 00  |T......7.....I..|</span><br><span class="line">000002b0  00 00 00 00 00 c9 07 00  00 00 00 00 00 c0 28 93  |..............(.|</span><br><span class="line">000002c0  e8 00 00 00 00 00 00 00  00 c1 1b ff e4 00 00 00  |................|</span><br><span class="line">000002d0  3f d7 6c 17 18 4c 75 63  65 6e 65 39 30 50 6f 69  |?.l..Lucene90Poi|</span><br><span class="line">000002e0  6e 74 73 46 6f 72 6d 61  74 44 61 74 61 00 00 00  |ntsFormatData...|</span><br><span class="line">000002f0  00 6b f0 66 56 c3 12 5b  07 08 12 3a 32 4d 4b 92  |.k.fV..[...:2MK.|</span><br><span class="line">00000300  f8 00 07 10 00 01 00 06  00 04 00 00 00 05 00 03  |................|</span><br><span class="line">00000310  00 02 00 04 80 00 01 81  00 b4 03 f6 00 0f f6 55  |...............U|</span><br><span class="line">00000320  d3 f8 31 29 b5 04 2b 3d  81 2b 3d 81 2b 3d 85 2b  |..1)..+=.+=.+=.+|</span><br><span class="line">00000330  3d 9d c0 28 93 e8 00 00  00 00 00 00 00 00 28 e1  |=..(..........(.|</span><br><span class="line">00000340  c0 de 00 00 00 00 00 00  3f d7 6c 17 19 4c 75 63  |........?.l..Luc|</span><br><span class="line">00000350  65 6e 65 39 30 50 6f 73  74 69 6e 67 73 57 72 69  |ene90PostingsWri|</span><br><span class="line">00000360  74 65 72 50 6f 73 00 00  00 00 6b f0 66 56 c3 12  |terPos....k.fV..|</span><br><span class="line">00000370  5b 07 08 12 3a 32 4d 4b  92 f8 0a 4c 75 63 65 6e  |[...:2MK...Lucen|</span><br><span class="line">00000380  65 39 30 5f 30 1e 01 03  b1 01 06 0b 0b a4 01 05  |e90_0...........|</span><br><span class="line">00000390  0d 21 06 02 0b a5 01 0c  0d 0a 0e 19 18 20 09 0b  |.!........... ..|</span><br><span class="line">000003a0  5f 19 45 06 30 08 0a 22  02 02 75 51 58 06 0b 03  |_.E.0..&quot;..uQX...|</span><br><span class="line">000003b0  05 03 07 7c 05 23 96 01  02 3c 54 30 37 01 11 18  |...|.#...&lt;T07...|</span><br><span class="line">000003c0  0a 40 30 29 0b 32 92 01  ae 01 03 1f 21 03 88 01  |.@0).2......!...|</span><br><span class="line">000003d0  23 27 d5 01 73 18 0f 5f  07 3a 04 04 06 06 07 06  |#&#x27;..s.._.:......|</span><br><span class="line">000003e0  12 19 38 04 00 72 0c 7d  52 3b 04 04 06 06 07 06  |..8..r.&#125;R;......|</span><br><span class="line">000003f0  25 06 38 04 11 46 3e 08  4c 42 11 10 0f 1f bc 01  |%.8..F&gt;.LB......|</span><br><span class="line">00000400  0b 1c 1a 06 8a 01 20 39  04 04 06 06 07 06 12 51  |...... 9.......Q|</span><br><span class="line">00000410  04 c8 01 15 00 7e 44 06  06 07 06 17 06 08 06 04  |.....~D.........|</span><br><span class="line">00000420  38 04 30 30 12 1d 05 07  19 06 05 02 00 05 05 06  |8.00............|</span><br><span class="line">00000430  02 07 0c 05 07 31 05 2a  06 01 06 09 06 06 08 0b  |.....1.*........|</span><br><span class="line">00000440  04 00 00 1a 00 1c 0c d1  01 06 2f 07 60 07 15 06  |........../.`...|</span><br><span class="line">00000450  01 01 cb 01 63 1a 26 a8  01 9f 01 13 06 2b 99 01  |....c.&amp;......+..|</span><br><span class="line">00000460  b4 01 01 68 28 09 d4 01  09 1b 0d 6f 0a 16 1b 10  |...h(......o....|</span><br><span class="line">00000470  17 80 01 05 71 cf 01 d0  01 06 d2 01 06 17 1e 04  |....q...........|</span><br><span class="line">00000480  05 0d 07 0c 05 07 31 05  2a 07 06 09 06 06 17 08  |......1.*.......|</span><br><span class="line">00000490  04 04 0c 04 0d 12 2a 01  25 76 0e 07 0f 20 14 1e  |......*.%v... ..|</span><br><span class="line">000004a0  53 06 1e 08 a3 01 38 0a  0b a6 01 da 01 03 5e 2b  |S.....8.......^+|</span><br><span class="line">000004b0  c5 01 61 18 01 ba 01 38  03 05 0d 07 0c 05 07 31  |..a....8.......1|</span><br><span class="line">000004c0  05 2a 07 06 09 06 06 17  03 04 04 03 03 02 05 0d  |.*..............|</span><br><span class="line">000004d0  07 0c 05 07 31 05 2a 07  06 09 06 06 17 02 08 02  |....1.*.........|</span><br><span class="line">000004e0  02 c9 01 c0 28 93 e8 00  00 00 00 00 00 00 00 63  |....(..........c|</span><br><span class="line">000004f0  69 b5 c7 00 00 00 00 00  3f d7 6c 17 15 4c 75 63  |i.......?.l..Luc|</span><br><span class="line">00000500  65 6e 65 39 30 4e 6f 72  6d 73 4d 65 74 61 64 61  |ene90NormsMetada|</span><br><span class="line">00000510  74 61 00 00 00 00 6b f0  66 56 c3 12 5b 07 08 12  |ta....k.fV..[...|</span><br><span class="line">00000520  3a 32 4d 4b 92 f8 00 02  00 00 00 ff ff ff ff ff  |:2MK............|</span><br><span class="line">00000530  ff ff ff 00 00 00 00 00  00 00 00 ff ff ff 07 00  |................|</span><br><span class="line">00000540  00 00 01 2b 00 00 00 00  00 00 00 ff ff ff ff c0  |...+............|</span><br><span class="line">00000550  28 93 e8 00 00 00 00 00  00 00 00 72 ba cc 7e 00  |(..........r..~.|</span><br><span class="line">00000560  3f d7 6c 17 12 4c 75 63  65 6e 65 39 30 46 69 65  |?.l..Lucene90Fie|</span><br><span class="line">00000570  6c 64 49 6e 66 6f 73 00  00 00 00 6b f0 66 56 c3  |ldInfos....k.fV.|</span><br><span class="line">00000580  12 5b 07 08 12 3a 32 4d  4b 92 f8 00 03 04 70 61  |.[...:2MK.....pa|</span><br><span class="line">00000590  74 68 00 02 01 00 ff ff  ff ff ff ff ff ff 02 1d  |th..............|</span><br><span class="line">000005a0  50 65 72 46 69 65 6c 64  50 6f 73 74 69 6e 67 73  |PerFieldPostings|</span><br><span class="line">000005b0  46 6f 72 6d 61 74 2e 66  6f 72 6d 61 74 08 4c 75  |Format.format.Lu|</span><br><span class="line">000005c0  63 65 6e 65 39 30 1d 50  65 72 46 69 65 6c 64 50  |cene90.PerFieldP|</span><br><span class="line">000005d0  6f 73 74 69 6e 67 73 46  6f 72 6d 61 74 2e 73 75  |ostingsFormat.su|</span><br><span class="line">000005e0  66 66 69 78 01 30 00 00  00 08 6d 6f 64 69 66 69  |ffix.0....modifi|</span><br><span class="line">000005f0  65 64 01 00 00 00 ff ff  ff ff ff ff ff ff 00 01  |ed..............|</span><br><span class="line">00000600  01 08 00 00 08 63 6f 6e  74 65 6e 74 73 02 00 03  |.....contents...|</span><br><span class="line">00000610  00 ff ff ff ff ff ff ff  ff 02 1d 50 65 72 46 69  |...........PerFi|</span><br><span class="line">00000620  65 6c 64 50 6f 73 74 69  6e 67 73 46 6f 72 6d 61  |eldPostingsForma|</span><br><span class="line">00000630  74 2e 66 6f 72 6d 61 74  08 4c 75 63 65 6e 65 39  |t.format.Lucene9|</span><br><span class="line">00000640  30 1d 50 65 72 46 69 65  6c 64 50 6f 73 74 69 6e  |0.PerFieldPostin|</span><br><span class="line">00000650  67 73 46 6f 72 6d 61 74  2e 73 75 66 66 69 78 01  |gsFormat.suffix.|</span><br><span class="line">00000660  30 00 00 00 c0 28 93 e8  00 00 00 00 00 00 00 00  |0....(..........|</span><br><span class="line">00000670  1f ee 84 f9 00 00 00 00  3f d7 6c 17 1c 4c 75 63  |........?.l..Luc|</span><br><span class="line">00000680  65 6e 65 39 30 53 74 6f  72 65 64 46 69 65 6c 64  |ene90StoredField|</span><br><span class="line">00000690  73 46 61 73 74 44 61 74  61 00 00 00 01 6b f0 66  |sFastData....k.f|</span><br><span class="line">000006a0  56 c3 12 5b 07 08 12 3a  32 4d 4b 92 f8 00 00 1e  |V..[...:2MK.....|</span><br><span class="line">000006b0  00 01 08 18 1d 21 21 1d  1c 18 0a 13 0b 15 12 10  |.....!!.........|</span><br><span class="line">000006c0  15 0f 15 12 10 15 12 a0  00 16 2f 68 6f 6d 65 2f  |........../home/|</span><br><span class="line">000006d0  64 61 f0 04 69 2f 64 6f  63 73 2f 62 62 62 2e 74  |da..i/docs/bbb.t|</span><br><span class="line">000006e0  78 74 00 1b 2f 68 6f 01  05 00 e0 69 2f 64 6f 63  |xt../ho....i/doc|</span><br><span class="line">000006f0  73 2f 69 6e 64 65 78 2f  5f 73 30 2e 63 66 73 00  |s/index/_s0.cfs.|</span><br><span class="line">00000700  1f 0f 00 50 61 69 2f 64  6f f0 04 63 73 2f 69 6e  |...Pai/do..cs/in|</span><br><span class="line">00000710  64 65 78 2f 73 65 67 6d  65 6e 74 73 5f 31 24 00  |dex/segments_1$.|</span><br><span class="line">00000720  1f 0a 00 90 69 2f 64 6f  63 73 2f 69 6e f0 04 64  |....i/docs/in..d|</span><br><span class="line">00000730  65 78 2f 77 72 69 74 65  2e 6c 6f 63 6b 00 1b 2f  |ex/write.lock../|</span><br><span class="line">00000740  68 6f 01 05 00 e0 69 2f  64 6f 63 73 2f 69 6e 64  |ho....i/docs/ind|</span><br><span class="line">00000750  65 78 2f 5f 73 30 2e 63  66 65 00 1a 0f 00 50 61  |ex/_s0.cfe....Pa|</span><br><span class="line">00000760  69 2f 64 6f f0 04 63 73  2f 69 6e 64 65 78 2f 5f  |i/do..cs/index/_|</span><br><span class="line">00000770  30 2e 73 69 00 16 2f 68  6f 01 05 00 e0 69 2f 64  |0.si../ho....i/d|</span><br><span class="line">00000780  6f 63 73 2f 61 61 61 2e  74 78 74 c0 28 93 e8 00  |ocs/aaa.txt.(...|</span><br><span class="line">00000790  00 00 00 00 00 00 00 52  80 f1 02 00 00 00 00 00  |.......R........|</span><br><span class="line">000007a0  3f d7 6c 17 13 42 6c 6f  63 6b 54 72 65 65 54 65  |?.l..BlockTreeTe|</span><br><span class="line">000007b0  72 6d 73 49 6e 64 65 78  00 00 00 00 6b f0 66 56  |rmsIndex....k.fV|</span><br><span class="line">000007c0  c3 12 5b 07 08 12 3a 32  4d 4b 92 f8 0a 4c 75 63  |..[...:2MK...Luc|</span><br><span class="line">000007d0  65 6e 65 39 30 5f 30 00  00 c0 28 93 e8 00 00 00  |ene90_0...(.....|</span><br><span class="line">000007e0  00 00 00 00 00 6e c7 b4  6e 00 00 00 00 00 00 00  |.....n..n.......|</span><br><span class="line">000007f0  3f d7 6c 17 11 4c 75 63  65 6e 65 39 30 4e 6f 72  |?.l..Lucene90Nor|</span><br><span class="line">00000800  6d 73 44 61 74 61 00 00  00 00 6b f0 66 56 c3 12  |msData....k.fV..|</span><br><span class="line">00000810  5b 07 08 12 3a 32 4d 4b  92 f8 00 08 44 0e 00 21  |[...:2MK....D..!|      &lt;------------- here  08 44 0e 00 21</span><br><span class="line">00000820  29 04 c0 28 93 e8 00 00  00 00 00 00 00 00 43 ab  |)..(..........C.|      &lt;------------  04 就是norm</span><br><span class="line">00000830  9e 6c 00 00 00 00 00 00  3f d7 6c 17 19 4c 75 63  |.l......?.l..Luc|</span><br><span class="line">00000840  65 6e 65 39 30 50 6f 73  74 69 6e 67 73 57 72 69  |ene90PostingsWri|</span><br><span class="line">00000850  74 65 72 44 6f 63 00 00  00 00 6b f0 66 56 c3 12  |terDoc....k.fV..|</span><br><span class="line">00000860  5b 07 08 12 3a 32 4d 4b  92 f8 0a 4c 75 63 65 6e  |[...:2MK...Lucen|</span><br><span class="line">00000870  65 39 30 5f 30 03 03 02  05 08 03 01 02 02 0b 03  |e90_0...........|</span><br><span class="line">00000880  07 02 02 07 01 03 02 02  07 02 02 07 03 07 03 07  |................|</span><br><span class="line">00000890  05 02 15 03 04 02 03 02  10 03 05 03 05 05 02 10  |................|</span><br><span class="line">000008a0  02 03 05 03 02 10 02 02  05 03 c0 28 93 e8 00 00  |...........(....|</span><br><span class="line">000008b0  00 00 00 00 00 00 8d fa  92 14 00 00 00 00 00 00  |................|</span><br><span class="line">000008c0  3f d7 6c 17 12 42 6c 6f  63 6b 54 72 65 65 54 65  |?.l..BlockTreeTe|</span><br><span class="line">000008d0  72 6d 73 44 69 63 74 00  00 00 00 6b f0 66 56 c3  |rmsDict....k.fV.|</span><br><span class="line">000008e0  12 5b 07 08 12 3a 32 4d  4b 92 f8 0a 4c 75 63 65  |.[...:2MK...Luce|</span><br><span class="line">000008f0  6e 65 39 30 5f 30 36 84  0e 30 30 75 62 75 6e 74  |ne90_06..00ubunt|</span><br><span class="line">00000900  75 30 2e 32 32 2e 30 34  2e 31 31 31 30 2e 30 2e  |u0.22.04.1110.0.|</span><br><span class="line">00000910  30 31 36 35 36 36 30 31  39 31 38 38 33 36 31 37  |0165660191883617|</span><br><span class="line">00000920  2e 30 2e 33 31 65 31 69  31 6d 31 6d 31 6d 32 33  |.0.31e1i1m1m1m23|</span><br><span class="line">00000930  33 33 35 2e 31 35 2e 30  36 37 39 5f 30 5f 30 5f  |335.15.0679_0_0_|</span><br><span class="line">00000940  6c 75 63 65 6e 65 39 30  66 69 65 6c 64 5f 30 5f  |lucene90field_0_|</span><br><span class="line">00000950  6c 75 63 65 6e 65 39 30  66 69 65 6c 64 73 69 6e  |lucene90fieldsin|</span><br><span class="line">00000960  64 65 78 5f 30 5f 6c 75  63 65 6e 65 39 30 66 69  |dex_0_lucene90fi|</span><br><span class="line">00000970  65 6c 64 73 69 6e 64 65  78 66 69 6c 65 5f 70 6f  |eldsindexfile_po|</span><br><span class="line">00000980  69 6e 74 65 72 73 5f 31  5f 30 cb b9 5f 6c 75 63  |inters_1_0.._luc|</span><br><span class="line">00000990  65 6e 65 39 30 5f 30 5f  6c 75 63 65 6e 65 39 30  |ene90_0_lucene90|</span><br><span class="line">000009a0  66 69 65 6c 64 73 69 6e  64 65 78 61 61 61 61 2e  |fieldsindexaaaa.|</span><br><span class="line">000009b0  74 78 74 61 61 6d 62 6f  79 64 6f 67 6f 6f 64 69  |txtaamboydogoodi|</span><br><span class="line">000009c0  69 73 6b 6e 6f 77 74 68  69 6e 67 77 68 61 74 79  |isknowthingwhaty|</span><br><span class="line">000009d0  6f 75 61 6d 61 6d 64 36  34 36 01 10 01 06 0d 06  |ouamamd646......|</span><br><span class="line">000009e0  08 02 01 01 02 06 01 01  01 02 10 16 25 04 0b 14  |............%...|</span><br><span class="line">000009f0  01 07 1f 02 05 1c 02 04  02 01 04 00 03 02 02 03  |................|</span><br><span class="line">00000a00  02 01 07 02 01 02 01 04  06 07 02 04 01 06 01 02  |................|</span><br><span class="line">00000a10  02 05 3a 7a 01 3d 11 06  00 02 04 05 03 01 01 01  |..:z.=..........|</span><br><span class="line">00000a20  01 0f 03 01 02 01 01 01  02 11 01 01 01 0f 01 11  |................|</span><br><span class="line">00000a30  01 0f 02 00 02 08 01 08  01 01 01 01 05 01 09 01  |................|</span><br><span class="line">00000a40  0b 05 00 01 08 01 05 01  03 15 01 03 01 38 b4 09  |.............8..|</span><br><span class="line">00000a50  62 62 62 62 2e 74 78 74  62 65 73 74 5f 73 70 65  |bbbb.txtbest_spe|</span><br><span class="line">00000a60  65 64 62 6b 64 62 6c 6f  63 6b 74 72 65 65 74 65  |edbkdblocktreete|</span><br><span class="line">00000a70  72 6d 73 64 69 63 74 62  6c 6f 63 6b 74 72 65 65  |rmsdictblocktree|</span><br><span class="line">00000a80  74 65 72 6d 73 69 6e 64  65 78 62 6c 6f 63 6b 74  |termsindexblockt|</span><br><span class="line">00000a90  72 65 65 74 65 72 6d 73  6d 65 74 61 62 6f 79 62  |reetermsmetaboyb|</span><br><span class="line">00000aa0  75 69 6c 64 63 63 66 65  63 66 73 63 6f 6e 74 65  |uildccfecfsconte|</span><br><span class="line">00000ab0  6e 74 73 63 73 64 64 61  69 64 6f 64 6f 63 64 6f  |ntscsddaidodocdo|</span><br><span class="line">00000ac0  63 5f 64 6f 63 5f 69 64  73 5f 30 64 6f 63 73 65  |c_doc_ids_0docse|</span><br><span class="line">00000ad0  75 66 66 64 6d 66 64 74  66 64 78 66 6c 75 73 68  |uffdmfdtfdxflush|</span><br><span class="line">00000ae0  66 6e 6d 66 73 74 38 01  07 0a 03 12 13 12 03 05  |fnmfst8.........|</span><br><span class="line">00000af0  01 03 03 08 02 01 03 02  03 04 09 04 03 03 03 03  |................|</span><br><span class="line">00000b00  05 03 03 1b 04 00 02 01  0d 02 02 05 02 01 04 01  |................|</span><br><span class="line">00000b10  02 0a 04 00 05 02 0a 01  04 01 04 01 05 02 01 3d  |...............=|</span><br><span class="line">00000b20  8e 01 77 04 01 02 11 02  0f 01 01 01 01 01 01 02  |..w.............|</span><br><span class="line">00000b30  15 02 03 01 0f 01 11 04  01 01 0f 01 01 02 00 02  |................|</span><br><span class="line">00000b40  06 01 03 00 0b 04 04 02  0b 01 01 01 01 01 01 0b  |................|</span><br><span class="line">00000b50  00 01 06 03 06 04 03 05  01 03 01 0b 01 50 cc 20  |.............P. |</span><br><span class="line">00000b60  67 67 65 6e 65 72 69 63  67 6f 6f 64 68 68 6f 6d  |ggenericgoodhhom|</span><br><span class="line">00000b70  65 69 69 64 73 5f 30 69  6e 64 65 78 69 73 6a 6a  |eiids_0indexisjj|</span><br><span class="line">00000b80  61 76 61 2e 72 75 6e 74  69 6d 65 2e 76 65 72 73  |ava.runtime.vers|</span><br><span class="line">00000b90  69 6f 6e 6a 61 76 61 2e  76 65 6e 64 6f 72 6a 61  |ionjava.vendorja|</span><br><span class="line">00000ba0  76 61 2e 76 65 72 73 69  6f 6e 6a 61 76 61 2e 76  |va.versionjava.v|</span><br><span class="line">00000bb0  6d 2e 76 65 72 73 69 6f  6e 6b 64 64 6b 64 69 6b  |m.versionkddkdik|</span><br><span class="line">00000bc0  64 6d 30 6b 6e 6f 77 6c  6c 69 6e 75 78 6c 75 63  |dm0knowllinuxluc|</span><br><span class="line">00000bd0  65 6e 65 2e 76 65 72 73  69 6f 6e 6c 75 63 65 6e  |ene.versionlucen|</span><br><span class="line">00000be0  65 39 30 6c 75 63 65 6e  65 39 30 5f 30 6c 75 63  |e90lucene90_0luc|</span><br><span class="line">00000bf0  65 6e 65 39 30 63 6f 6d  70 6f 75 6e 64 64 61 74  |ene90compounddat|</span><br><span class="line">00000c00  61 6c 75 63 65 6e 65 39  30 63 6f 6d 70 6f 75 6e  |alucene90compoun|</span><br><span class="line">00000c10  64 65 6e 74 72 69 65 73  6c 75 63 65 6e 65 39 30  |dentrieslucene90|</span><br><span class="line">00000c20  66 69 65 6c 64 69 6e 66  6f 73 6c 75 63 65 6e 65  |fieldinfoslucene|</span><br><span class="line">00000c30  39 30 66 69 65 6c 64 73  69 6e 64 65 78 69 64 78  |90fieldsindexidx|</span><br><span class="line">00000c40  6c 75 63 65 6e 65 39 30  66 69 65 6c 64 73 69 6e  |lucene90fieldsin|</span><br><span class="line">00000c50  64 65 78 6d 65 74 61 6c  75 63 65 6e 65 39 30 6e  |dexmetalucene90n|</span><br><span class="line">00000c60  6f 72 6d 73 64 61 74 61  6c 75 63 65 6e 65 39 30  |ormsdatalucene90|</span><br><span class="line">00000c70  6e 6f 72 6d 73 6d 65 74  61 64 61 74 61 6c 75 63  |normsmetadataluc|</span><br><span class="line">00000c80  65 6e 65 39 30 70 6f 69  6e 74 73 66 6f 72 6d 61  |ene90pointsforma|</span><br><span class="line">00000c90  74 64 61 74 61 6c 75 63  65 6e 65 39 30 70 6f 69  |tdatalucene90poi|</span><br><span class="line">00000ca0  6e 74 73 66 6f 72 6d 61  74 69 6e 64 65 78 6c 75  |ntsformatindexlu|</span><br><span class="line">00000cb0  63 65 6e 65 39 30 70 6f  69 6e 74 73 66 6f 72 6d  |cene90pointsform|</span><br><span class="line">00000cc0  61 74 6d 65 74 61 6c 75  63 65 6e 65 39 30 70 6f  |atmetalucene90po|</span><br><span class="line">00000cd0  73 74 69 6e 67 73 77 72  69 74 65 72 64 6f 63 6c  |stingswriterdocl|</span><br><span class="line">00000ce0  75 63 65 6e 65 39 30 70  6f 73 74 69 6e 67 73 77  |ucene90postingsw|</span><br><span class="line">00000cf0  72 69 74 65 72 70 6f 73  6c 75 63 65 6e 65 39 30  |riterposlucene90|</span><br><span class="line">00000d00  70 6f 73 74 69 6e 67 73  77 72 69 74 65 72 74 65  |postingswriterte|</span><br><span class="line">00000d10  72 6d 73 6c 75 63 65 6e  65 39 30 73 65 67 6d 65  |rmslucene90segme|</span><br><span class="line">00000d20  6e 74 69 6e 66 6f 6c 75  63 65 6e 65 39 30 73 74  |ntinfolucene90st|</span><br><span class="line">00000d30  6f 72 65 64 66 69 65 6c  64 73 66 61 73 74 64 61  |oredfieldsfastda|</span><br><span class="line">00000d40  74 61 6c 75 63 65 6e 65  39 30 73 74 6f 72 65 64  |talucene90stored|</span><br><span class="line">00000d50  66 69 65 6c 64 73 66 6f  72 6d 61 74 2e 6d 6f 64  |fieldsformat.mod|</span><br><span class="line">00000d60  65 6c 75 63 65 6e 65 39  33 50 01 07 04 01 04 01  |elucene93P......|</span><br><span class="line">00000d70  05 05 02 01 14 0b 0c 0f  03 03 04 04 01 05 0e 08  |................|</span><br><span class="line">00000d80  0a 14 17 12 16 17 11 15  18 19 18 19 19 1b 13 1c  |................|</span><br><span class="line">00000d90  1f 08 16 05 04 00 02 09  06 00 01 02 0a 01 02 01  |................|</span><br><span class="line">00000da0  0f 08 15 03 02 01 02 05  21 56 a8 01 04 b9 01 05  |........!V......|</span><br><span class="line">00000db0  01 13 01 00 01 04 01 03  00 0a 06 01 04 01 01 03  |................|</span><br><span class="line">00000dc0  0b 05 01 11 02 01 01 01  01 01 01 03 01 01 01 01  |................|</span><br><span class="line">00000dd0  01 0f 01 00 01 0c 05 19  01 01 0f 01 01 03 01 06  |................|</span><br><span class="line">00000de0  0d 01 0b 01 01 02 01 01  01 01 01 01 01 02 01 02  |................|</span><br><span class="line">00000df0  01 01 01 01 01 01 01 02  11 02 0f 01 11 01 0b 01  |................|</span><br><span class="line">00000e00  5b a4 0f 6d 6f 64 69 66  69 65 64 6e 76 64 6e 76  |[..modifiednvdnv|</span><br><span class="line">00000e10  6d 6f 6f 63 73 6f 73 6f  73 2e 61 72 63 68 6f 73  |moocsosos.archos|</span><br><span class="line">00000e20  2e 76 65 72 73 69 6f 6e  70 70 61 69 70 61 74 68  |.versionppaipath|</span><br><span class="line">00000e30  70 65 72 66 69 65 6c 64  70 6f 73 74 69 6e 67 73  |perfieldpostings|</span><br><span class="line">00000e40  66 6f 72 6d 61 74 2e 66  6f 72 6d 61 74 70 65 72  |format.formatper|</span><br><span class="line">00000e50  66 69 65 6c 64 70 6f 73  74 69 6e 67 73 66 6f 72  |fieldpostingsfor|</span><br><span class="line">00000e60  6d 61 74 2e 73 75 66 66  69 78 70 6f 73 70 72 69  |mat.suffixpospri|</span><br><span class="line">00000e70  76 61 74 65 70 d7 99 70  d7 9b 70 d7 9c 71 71 78  |vatep..p..p..qqx|</span><br><span class="line">00000e80  72 73 65 67 6d 65 6e 74  73 73 69 73 69 6e 64 65  |rsegmentssisinde|</span><br><span class="line">00000e90  78 66 69 6c 65 5f 70 6f  69 6e 74 65 72 73 5f 31  |xfile_pointers_1|</span><br><span class="line">00000ea0  73 6f 75 72 63 65 74 68  69 6e 67 74 69 6d 74 69  |sourcethingtimti|</span><br><span class="line">00000eb0  6d 65 73 74 61 6d 70 74  69 70 78 74 6d 64 74 6d  |mestamptipxtmdtm|</span><br><span class="line">00000ec0  70 75 75 62 75 6e 74 75  76 78 77 63 77 68 61 74  |puubuntuvxwcwhat|</span><br><span class="line">00000ed0  77 72 69 74 65 2e 6c 6f  63 6b 77 72 69 74 65 2e  |write.lockwrite.|</span><br><span class="line">00000ee0  6c 6f 63 6b 38 78 79 79  6f 75 79 6f 75 37 7a 7a  |lock8xyyouyou7zz|</span><br><span class="line">00000ef0  74 37 cb b9 cd b1 69 5a  08 03 03 01 03 02 07 0a  |t7....iZ........|</span><br><span class="line">00000f00  01 03 04 1d 1d 03 07 03  03 03 01 03 08 02 15 06  |................|</span><br><span class="line">00000f10  05 03 09 04 03 03 01 06  02 02 04 0a 0b 01 01 03  |................|</span><br><span class="line">00000f20  04 01 03 02 03 21 07 02  02 05 02 01 03 02 01 02  |.....!..........|</span><br><span class="line">00000f30  01 03 08 0f 03 04 00 13  02 03 02 01 02 01 05 02  |................|</span><br><span class="line">00000f40  01 0b 08 11 08 10 01 60  be 01 01 9e 02 0d 02 01  |.......`........|</span><br><span class="line">00000f50  01 01 01 0b 01 11 03 01  01 01 01 0f 01 01 03 01  |................|</span><br><span class="line">00000f60  01 01 02 01 03 0d 03 05  01 00 01 0a 02 13 01 01  |................|</span><br><span class="line">00000f70  00 01 04 05 02 0b 01 0d  01 0f 01 11 01 13 01 11  |................|</span><br><span class="line">00000f80  01 05 01 03 01 01 01 0b  01 01 04 11 03 0f 02 01  |................|</span><br><span class="line">00000f90  02 03 02 05 01 01 02 01  02 0d 01 0f 01 05 01 01  |................|</span><br><span class="line">00000fa0  02 00 01 0c 15 0c 01 14  0f d4 0b 2f 68 6f 6d 65  |.........../home|</span><br><span class="line">00000fb0  2f 64 61 69 2f 64 6f 63  73 2f 61 61 61 2e 74 78  |/dai/docs/aaa.tx|</span><br><span class="line">00000fc0  74 2f 68 6f 6d 65 2f 64  61 69 2f 64 6f 63 73 2f  |t/home/dai/docs/|</span><br><span class="line">00000fd0  62 62 62 2e 74 78 74 2f  68 6f 6d 65 2f 64 61 69  |bbb.txt/home/dai|</span><br><span class="line">00000fe0  2f 64 6f 63 73 2f 69 6e  64 65 78 2f 5f 30 2e 63  |/docs/index/_0.c|</span><br><span class="line">00000ff0  66 65 2f 68 6f 6d 65 2f  64 61 69 2f 64 6f 63 73  |fe/home/dai/docs|</span><br><span class="line">00001000  2f 69 6e 64 65 78 2f 5f  30 2e 63 66 73 2f 68 6f  |/index/_0.cfs/ho|</span><br><span class="line">00001010  6d 65 2f 64 61 69 2f 64  6f 63 73 2f 69 6e 64 65  |me/dai/docs/inde|</span><br><span class="line">00001020  78 2f 5f 30 2e 73 69 2f  68 6f 6d 65 2f 64 61 69  |x/_0.si/home/dai|</span><br><span class="line">00001030  2f 64 6f 63 73 2f 69 6e  64 65 78 2f 73 65 67 6d  |/docs/index/segm|</span><br><span class="line">00001040  65 6e 74 73 5f 31 2f 68  6f 6d 65 2f 64 61 69 2f  |ents_1/home/dai/|</span><br><span class="line">00001050  64 6f 63 73 2f 69 6e 64  65 78 2f 77 72 69 74 65  |docs/index/write|</span><br><span class="line">00001060  2e 6c 6f 63 6b 0e 16 16  1b 1b 1a 1f 1f 01 0d 09  |.lock...........|</span><br><span class="line">00001070  e4 01 06 17 11 0b 11 0b  05 c0 28 93 e8 00 00 00  |..........(.....|</span><br><span class="line">00001080  00 00 00 00 00 26 7d 6b  cb 00 00 00 00 00 00 00  |.....&amp;&#125;k........|</span><br><span class="line">00001090  3f d7 6c 17 16 4c 75 63  65 6e 65 39 30 46 69 65  |?.l..Lucene90Fie|</span><br><span class="line">000010a0  6c 64 73 49 6e 64 65 78  49 64 78 00 00 00 00 6b  |ldsIndexIdx....k|</span><br><span class="line">000010b0  f0 66 56 c3 12 5b 07 08  12 3a 32 4d 4b 92 f8 00  |.fV..[...:2MK...|</span><br><span class="line">000010c0  c0 28 93 e8 00 00 00 00  00 00 00 00 be 7c 21 a1  |.(...........|!.|</span><br><span class="line">000010d0  c0 28 93 e8 00 00 00 00  00 00 00 00 15 f4 63 e8  |.(............c.|</span><br><span class="line">000010e0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>gdb 读取内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/32xb 140063879776283</span><br><span class="line">0x7f6329ccc81b:	0x08	0x44	0x0e	0x00	0x21	0x29	0x04	0xc0</span><br><span class="line">0x7f6329ccc823:	0x28	0x93	0xe8	0x00	0x00	0x00	0x00	0x00</span><br><span class="line">0x7f6329ccc82b:	0x00	0x00	0x00	0x43	0xab	0x9e	0x6c	0x00</span><br><span class="line">0x7f6329ccc833:	0x00	0x00	0x00	0x00	0x00	0x3f	0xd7	0x6c</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><h3 id="DirectByteBufferR-继承关系"><a href="#DirectByteBufferR-继承关系" class="headerlink" title="DirectByteBufferR 继承关系"></a>DirectByteBufferR 继承关系</h3><p><img src="https://cdn4.shakudada.xyz/extendjava.png" alt="DirectByteBufferR extend"></p>
<p>依赖以下的脚本自动根据平台自动实现nio的<code>DirectByteBufferR</code>这个类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// 源码地址 jdk/make/modules/java.base/gensrc/GensrcBuffer.gmk</span><br><span class="line"># Direct byte buffer</span><br><span class="line">#</span><br><span class="line">DIRECT_X_BUF := Direct-X-Buffer</span><br><span class="line"></span><br><span class="line">$(eval $(call SetupGenBuffer,DirectByteBuffer, $(DIRECT_X_BUF), type:=byte, BIN:=1))</span><br><span class="line">$(eval $(call SetupGenBuffer,DirectByteBufferR,$(DIRECT_X_BUF), type:=byte, BIN:=1, RW:=R))</span><br></pre></td></tr></table></figure>

<p><code>DirectByteBufferR</code>  继承 <code>DirectByteBuffer</code>  ,  <code>DirectByteBuffer</code> 则继承<code>ByteBuffer</code>。<br>下面是编译后通过宏自动构建的DirectByteBufferR类，需要编译jvm的时候才能生成，我的在这个目录生成（编译jdk之后才会有这个文件，直接下载是没有这个文件的）<br><code>jdk/build/linux-x86_64-server-slowdebug/support/gensrc/java.base/java/nio/DirectByteBufferR.java</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">// -- This file was mechanically generated: Do not edit! -- //</span><br><span class="line"></span><br><span class="line">package java.nio;</span><br><span class="line"></span><br><span class="line">import java.io.FileDescriptor;</span><br><span class="line">import java.lang.ref.Reference;</span><br><span class="line">import java.util.Objects;</span><br><span class="line">import jdk.internal.access.foreign.MemorySegmentProxy;</span><br><span class="line">import jdk.internal.misc.ScopedMemoryAccess.Scope;</span><br><span class="line">import jdk.internal.misc.VM;</span><br><span class="line">import jdk.internal.ref.Cleaner;</span><br><span class="line">import sun.nio.ch.DirectBuffer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class DirectByteBufferR  extends DirectByteBuffer implements DirectBuffer</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">    // Primary constructor</span><br><span class="line">    //</span><br><span class="line">    DirectByteBufferR(int cap) &#123;                   // package-private</span><br><span class="line">        super(cap);</span><br><span class="line">        this.isReadOnly = true;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // For memory-mapped buffers -- invoked by FileChannelImpl via reflection</span><br><span class="line">    //</span><br><span class="line">    protected DirectByteBufferR(int cap, long addr,</span><br><span class="line">                                     FileDescriptor fd,</span><br><span class="line">                                     Runnable unmapper,</span><br><span class="line">                                     boolean isSync, MemorySegmentProxy segment)</span><br><span class="line">    &#123;</span><br><span class="line">        super(cap, addr, fd, unmapper, isSync, segment);</span><br><span class="line">        this.isReadOnly = true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>他的读取方法<code>DirectByteBufferR.get</code>是从<code>DirectByteBuffer</code>继承的,下面是实现：</p>
<p>实际是调用<code>SCOPED_MEMORY_ACCESS.getByte</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">// jdk/build/linux-x86_64-server-slowdebug/support/gensrc/java.base/java/nio/DirectByteBuffer.java</span><br><span class="line">    public byte get() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return ((SCOPED_MEMORY_ACCESS.getByte(scope(), null, ix(nextGetIndex()))));</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Reference.reachabilityFence(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public byte get(int i) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            return ((SCOPED_MEMORY_ACCESS.getByte(scope(), null, ix(checkIndex(i)))));</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            Reference.reachabilityFence(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>SCOPED_MEMORY_ACCESS</code>是在<code>MappedByteBuffer</code>里面定义的 ，而<code>DirectByteBuffer</code>是<code>MappedByteBuffer</code> 子类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">class DirectByteBuffer  extends MappedByteBuffer implements DirectBuffer</span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SCOPED_MEMORY_ACCESS.getByte</code>最后调用的是<code>UNSAFE.getByte</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class ScopedMemoryAccess &#123;</span><br><span class="line"></span><br><span class="line">    private static final Unsafe UNSAFE = Unsafe.getUnsafe();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @ForceInline</span><br><span class="line">    public byte getByte(Scope scope, Object base, long offset) &#123;</span><br><span class="line">        ...</span><br><span class="line">            return getByteInternal(scope, base, offset);  // 调用 内部函数</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @ForceInline @Scoped</span><br><span class="line">    private byte getByteInternal(Scope scope, Object base, long offset) &#123;</span><br><span class="line">            ...</span><br><span class="line">            return UNSAFE.getByte(base, offset);  // 最后调用的是UNSAFE.getByte</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><code>UNSAFE</code>是一个全局的静态变量,最后调用的是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// jdk/src/hotspot/share/prims/unsafe.cpp</span><br><span class="line"></span><br><span class="line">UNSAFE_ENTRY(java_type, Unsafe_Get##Type(JNIEnv *env, jobject unsafe, jobject obj, jlong offset)) &#123; \</span><br><span class="line">  return MemoryAccess&lt;java_type&gt;(thread, obj, offset).get(); \</span><br><span class="line">&#125; UNSAFE_END \</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>展开之后是调用MemoryAccess的get方法，实际是获取内存的值</p>
<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://cheng-dp.github.io/2018/12/11/direct-memory-and-direct-byte-buffer/">https://cheng-dp.github.io/2018/12/11/direct-memory-and-direct-byte-buffer/</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/523056198">https://zhuanlan.zhihu.com/p/523056198</a></li>
<li><a target="_blank" rel="noopener" href="https://resources.mpi-inf.mpg.de/d5/teaching/ss05/is05/javadoc/java/nio/DirectByteBuffer.html">https://resources.mpi-inf.mpg.de/d5/teaching/ss05/is05/javadoc/java/nio/DirectByteBuffer.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/wojiaxiaohuang2014/article/details/127636986">打印内存值</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/04/03/java-%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/04/03/java-%E5%9F%BA%E6%9C%AC%E7%B1%BB%E5%9E%8B/" class="post-title-link" itemprop="url">java 基本类型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-04-03 13:16:42" itemprop="dateCreated datePublished" datetime="2023-04-03T13:16:42+08:00">2023-04-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>了解java的基本类型,基本类型的大小和取值范围</p>
<p>platform:amd64</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>在c++ standard 里面</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>是否有符号</th>
<th>最小范围字节数</th>
<th>type</th>
</tr>
</thead>
<tbody><tr>
<td>char</td>
<td>implement defined [Type char is a distinct type that has an implementation-defined choice of “signed char” or “unsigned char” as its underlying type]</td>
<td>–</td>
<td></td>
</tr>
<tr>
<td>signed char</td>
<td>signed</td>
<td>–</td>
<td>signed type</td>
</tr>
<tr>
<td>short int</td>
<td>signed</td>
<td>–</td>
<td>signed type</td>
</tr>
<tr>
<td>int</td>
<td>signed</td>
<td>–</td>
<td>signed type</td>
</tr>
<tr>
<td>long int</td>
<td>signed</td>
<td>–</td>
<td>signed type</td>
</tr>
<tr>
<td>long long int</td>
<td>signed</td>
<td>–</td>
<td>signed type</td>
</tr>
</tbody></table>
<p>在linux 64位下面</p>
<table>
<thead>
<tr>
<th>java基本类型</th>
<th>c&#x2F;c++宏</th>
</tr>
</thead>
<tbody><tr>
<td>jint</td>
<td>int</td>
</tr>
<tr>
<td>jlong</td>
<td>long</td>
</tr>
<tr>
<td>jbyte</td>
<td>signed char</td>
</tr>
<tr>
<td>jboolean</td>
<td>unsigned char</td>
</tr>
<tr>
<td>jchar</td>
<td>unsigned short</td>
</tr>
<tr>
<td>jfloat</td>
<td>float</td>
</tr>
<tr>
<td>jdouble</td>
<td>double</td>
</tr>
<tr>
<td>jsize</td>
<td>jint 也就是int</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// jdk/src/java.base/unix/native/include/jni_md.h</span><br><span class="line">typedef int jint;</span><br><span class="line">#ifdef _LP64</span><br><span class="line">typedef long jlong;</span><br><span class="line">#else</span><br><span class="line">typedef long long jlong;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">typedef signed char jbyte;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// jdk/src/java.base/share/native/include/jni.h</span><br><span class="line">#ifndef JNI_TYPES_ALREADY_DEFINED_IN_JNI_MD_H</span><br><span class="line"></span><br><span class="line">typedef unsigned char   jboolean;</span><br><span class="line">typedef unsigned short  jchar;</span><br><span class="line">typedef short           jshort;</span><br><span class="line">typedef float           jfloat;</span><br><span class="line">typedef double          jdouble;</span><br><span class="line"></span><br><span class="line">typedef jint            jsize;</span><br></pre></td></tr></table></figure>


<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.ericgiguere.com/articles/ansi-c-summary.html">http://www.ericgiguere.com/articles/ansi-c-summary.html</a></li>
<li><a target="_blank" rel="noopener" href="https://isocpp.org/files/papers/N4860.pdf">page 70 c++20</a></li>
<li><a target="_blank" rel="noopener" href="https://en.cppreference.com/w/cpp/language/types">https://en.cppreference.com/w/cpp/language/types</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/03/29/java-unsafe/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/29/java-unsafe/" class="post-title-link" itemprop="url">java unsafe</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-29 19:46:24" itemprop="dateCreated datePublished" datetime="2023-03-29T19:46:24+08:00">2023-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>java的unsafe包是有很多底层的api暴露出来,举例,java的netty就大量使用这个api</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>下面是java的unsafe包里面的<code>allocateMemory</code>方法.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class UnsafeDemo &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        var unsafe = getUnsafe();</span><br><span class="line">        var memory = unsafe.allocateMemory(100);</span><br><span class="line">        System.out.println(memory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static Unsafe getUnsafe() &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Field field = Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);</span><br><span class="line">            field.setAccessible(true);</span><br><span class="line">            return (Unsafe) field.get(null);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里memory 返回的是一个地址</p>
<p>实际上是调用<code>Unsafe_AllocateMemory0</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">UNSAFE_ENTRY(jlong, Unsafe_AllocateMemory0(JNIEnv *env, jobject unsafe, jlong size)) &#123;</span><br><span class="line">  size_t sz = (size_t)size;</span><br><span class="line"></span><br><span class="line">  assert(is_aligned(sz, HeapWordSize), &quot;sz not aligned&quot;);</span><br><span class="line"></span><br><span class="line">  void* x = os::malloc(sz, mtOther);</span><br><span class="line"></span><br><span class="line">  return addr_to_java(x);</span><br><span class="line">&#125; UNSAFE_END</span><br></pre></td></tr></table></figure>

<p>最后调用的是glibc 的malloc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">void* os::malloc(size_t size, MEMFLAGS memflags, const NativeCallStack&amp; stack) &#123;</span><br><span class="line"></span><br><span class="line">  // Special handling for NMT preinit phase before arguments are parsed</span><br><span class="line">  void* rc = NULL;</span><br><span class="line">  if (NMTPreInit::handle_malloc(&amp;rc, size)) &#123;</span><br><span class="line">    // No need to fill with 0 because DumpSharedSpaces doesn&#x27;t use these</span><br><span class="line">    // early allocations.</span><br><span class="line">    return rc;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  DEBUG_ONLY(check_crash_protection());</span><br><span class="line"></span><br><span class="line">  // On malloc(0), implementations of malloc(3) have the choice to return either</span><br><span class="line">  // NULL or a unique non-NULL pointer. To unify libc behavior across our platforms</span><br><span class="line">  // we chose the latter.</span><br><span class="line">  size = MAX2((size_t)1, size);</span><br><span class="line"></span><br><span class="line">  // For the test flag -XX:MallocMaxTestWords</span><br><span class="line">  if (has_reached_max_malloc_test_peak(size)) &#123;</span><br><span class="line">    return NULL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  const size_t outer_size = size + MemTracker::overhead_per_malloc();</span><br><span class="line"></span><br><span class="line">  // Check for overflow.</span><br><span class="line">  if (outer_size &lt; size) &#123;</span><br><span class="line">    return NULL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ALLOW_C_FUNCTION(::malloc, void* const outer_ptr = ::malloc(outer_size);)      &lt;--  malloc 分配内存</span><br><span class="line">  if (outer_ptr == NULL) &#123;</span><br><span class="line">    return NULL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  void* const inner_ptr = MemTracker::record_malloc((address)outer_ptr, size, memflags, stack);</span><br><span class="line"></span><br><span class="line">  if (DumpSharedSpaces) &#123;</span><br><span class="line">    // Need to deterministically fill all the alignment gaps in C++ structures.</span><br><span class="line">    ::memset(inner_ptr, 0, size);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    DEBUG_ONLY(::memset(inner_ptr, uninitBlockPad, size);)</span><br><span class="line">  &#125;</span><br><span class="line">  DEBUG_ONLY(break_if_ptr_caught(inner_ptr);)</span><br><span class="line">  return inner_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zlk252620068/article/details/109841921">https://blog.csdn.net/zlk252620068/article/details/109841921</a></li>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/java-unsafe">https://www.baeldung.com/java-unsafe</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/mazhimazhi/p/13516634.html">java stack&#x2F;寄存器分布</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/stateis0/p/9062154.html">https://www.cnblogs.com/stateis0/p/9062154.html</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/03/23/tersorflow-%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/23/tersorflow-%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">tensorflow  入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-23 23:03:21" itemprop="dateCreated datePublished" datetime="2023-03-23T23:03:21+08:00">2023-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近chatgpt 很流行 ，所以想了解一下TensorFlow是怎么拟合数据的</p>
<h3 id="python-版本"><a href="#python-版本" class="headerlink" title="python 版本"></a>python 版本</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$python3 -V</span><br><span class="line">Python 3.10.6</span><br></pre></td></tr></table></figure>

<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>安装分为<a target="_blank" rel="noopener" href="https://www.tensorflow.org/install/pip">pip</a> 方式和<a target="_blank" rel="noopener" href="https://www.tensorflow.org/install/docker">jupyter</a>方式</p>
<p>我用的是pip安装的方式</p>
<ul>
<li><p>下载安装 Miniconda</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o Miniconda3-latest-Linux-x86_64.sh</span><br><span class="line">bash Miniconda3-latest-Linux-x86_64.sh</span><br></pre></td></tr></table></figure></li>
<li><p>创建一个叫tf 的environment</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">## 我的python是3.10 ， 根据自己情况改</span><br><span class="line">conda create --name tf python=3.10</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>安装tf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(tf) dai@myhost:~$ pip install tensorflow==2.11.*</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试运行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(tf) dai@myhost:~$ python3 -c &quot;import tensorflow as tf; print(tf.reduce_sum(tf.random.normal([1000, 1000])))&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38275604/article/details/106417600">https://blog.csdn.net/qq_38275604/article/details/106417600</a></li>
<li><a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/keras/Model#fit">https://www.tensorflow.org/api_docs/python/tf/keras/Model#fit</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/03/09/each-jvm-bytecode-implement-in-x86-with-asm/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/09/each-jvm-bytecode-implement-in-x86-with-asm/" class="post-title-link" itemprop="url">each jvm bytecode  implement in x86 with asm</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-03-09 07:15:57" itemprop="dateCreated datePublished" datetime="2023-03-09T07:15:57+08:00">2023-03-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>想要了解jvm的bytecode 的汇编实现 ，目标平台是x86</p>
<h3 id="汇编格式"><a href="#汇编格式" class="headerlink" title="汇编格式"></a>汇编格式</h3><p>同样一个汇编语句：<em>将1赋值给rax</em></p>
<p>汇编有两种表达方式</p>
<table>
<thead>
<tr>
<th>desc&#x2F;描述</th>
<th>intel</th>
<th>AT&amp;T</th>
</tr>
</thead>
<tbody><tr>
<td>将1写入rax寄存器</td>
<td>mov     eax,1</td>
<td>movl    $1,%eax</td>
</tr>
<tr>
<td>将rab+3 的地址的值写入rax</td>
<td>mov     eax,[ebx+3]</td>
<td>movl    3(%ebx),%eax</td>
</tr>
</tbody></table>
<h2 id="stack-frame"><a href="#stack-frame" class="headerlink" title="stack frame"></a>stack frame</h2><p>在x86 64 位的模式下 <code>rbcp</code> 是用<code>r13</code> , 描述的是下一个指令，<code>i = instruction</code><br><code>r14</code>则存了本地变量指针</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// Global Register Names</span><br><span class="line">static const Register rbcp     = LP64_ONLY(r13) NOT_LP64(rsi);</span><br><span class="line">static const Register rlocals  = LP64_ONLY(r14) NOT_LP64(rdi);</span><br></pre></td></tr></table></figure>

<p>这里LP64_ONLY()和NOT_LP64()是通过宏<a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/cpp/Common-Predefined-Macros.html">_LP64</a>来确定的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__LP64__</span><br><span class="line">_LP64</span><br><span class="line">These macros are defined, with value 1, if (and only if) the compilation is for a target where long int and pointer both use 64-bits and int uses 32-bit.</span><br></pre></td></tr></table></figure>
<h3 id="amd64-下面的寄存器"><a href="#amd64-下面的寄存器" class="headerlink" title="amd64 下面的寄存器"></a>amd64 下面的寄存器</h3><p>java的<code>stack frame</code></p>
<table>
<thead>
<tr>
<th>寄存器</th>
<th>含义、描述</th>
</tr>
</thead>
<tbody><tr>
<td>r14</td>
<td>存了本地变量的基地址</td>
</tr>
<tr>
<td>r13</td>
<td>指向下一个执行的bytecode</td>
</tr>
</tbody></table>
<p>类似c的堆栈，java 的栈如下：</p>
<p><img src="https://cdn4.shakudada.xyz/stack.png" alt="stack"></p>
<p><a target="_blank" rel="noopener" href="https://imada.sdu.dk/u/kslarsen/dm546/Material/IntelnATT.htm">相关阅读</a></p>
<h3 id="frame-用下面的结构描述"><a href="#frame-用下面的结构描述" class="headerlink" title="frame 用下面的结构描述"></a>frame 用下面的结构描述</h3><p>主要包括： </p>
<ul>
<li>_sp  :指向栈</li>
<li>_pc ： 指向指令<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">jdk/src/hotspot/share/runtime/frame.hpp</span><br><span class="line">class frame &#123;</span><br><span class="line"> private:</span><br><span class="line">  // Instance variables:</span><br><span class="line">  intptr_t* _sp; // stack pointer (from Thread::last_Java_sp)  , java 的stack 指针</span><br><span class="line">  address   _pc; // program counter (the next instruction after the call)   下一个指令的指针</span><br><span class="line"></span><br><span class="line">  CodeBlob* _cb; // CodeBlob that &quot;owns&quot; pc</span><br><span class="line">  enum deopt_state &#123;</span><br><span class="line">    not_deoptimized,</span><br><span class="line">    is_deoptimized,</span><br><span class="line">    unknown</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  deopt_state _deopt_state;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="bytecode"><a href="#bytecode" class="headerlink" title="bytecode"></a>bytecode</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">enum TosState &#123;         // describes the tos cache contents</span><br><span class="line">  btos = 0,             // byte, bool tos cached</span><br><span class="line">  ztos = 1,             // byte, bool tos cached</span><br><span class="line">  ctos = 2,             // char tos cached</span><br><span class="line">  stos = 3,             // short tos cached</span><br><span class="line">  itos = 4,             // int tos cached</span><br><span class="line">  ltos = 5,             // long tos cached</span><br><span class="line">  ftos = 6,             // float tos cached</span><br><span class="line">  dtos = 7,             // double tos cached</span><br><span class="line">  atos = 8,             // object cached</span><br><span class="line">  vtos = 9,             // tos not cached</span><br><span class="line">  number_of_states,</span><br><span class="line">  ilgl                  // illegal state: should not occur</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="iload"><a href="#iload" class="headerlink" title="iload"></a>iload</h3><table>
<thead>
<tr>
<th>bytecode</th>
<th>enum</th>
<th>asm</th>
</tr>
</thead>
<tbody><tr>
<td>iload</td>
<td>21</td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$65 = (address) 0x7fffe1012693 &quot;A\017\266]\002\203\373\025\017\204J&quot;</span><br><span class="line">(gdb) x/20i 0x7fffe1012693</span><br><span class="line">   0x7fffe1012693:	movzbl 0x2(%r13),%ebx</span><br><span class="line">   0x7fffe1012698:	cmp    $0x15,%ebx            &lt;---  下一个bytecode</span><br><span class="line">   0x7fffe101269b:	je     0x7fffe10126eb        &lt;--   跳转到 done</span><br><span class="line">   0x7fffe10126a1:	cmp    $0xe0,%ebx             &lt;-- 判断下一个是否是_fast_iload</span><br><span class="line">   0x7fffe10126a7:	mov    $0xe1,%ecx              &lt;------ 下一个是_fast_iload 则重写成fast_iload2</span><br><span class="line">   0x7fffe10126ac:	je     0x7fffe10126bd           &lt;--------  跳转到rewrite label</span><br><span class="line">   0x7fffe10126ae:	cmp    $0x34,%ebx</span><br><span class="line">   0x7fffe10126b1:	mov    $0xe2,%ecx</span><br><span class="line">   0x7fffe10126b6:	je     0x7fffe10126bd</span><br><span class="line">   0x7fffe10126b8:	mov    $0xe0,%ecx</span><br><span class="line">   0x7fffe10126bd:	movzbl 0x0(%r13),%ebx</span><br><span class="line">   0x7fffe10126c2:	cmp    $0x15,%ebx</span><br><span class="line">   0x7fffe10126c5:	je     0x7fffe10126e7</span><br><span class="line">   0x7fffe10126cb:	cmp    %ecx,%ebx</span><br><span class="line">   0x7fffe10126cd:	je     0x7fffe10126e7</span><br><span class="line">   0x7fffe10126d3:	movabs $0x7ffff74ef9d7,%rdi</span><br><span class="line">   0x7fffe10126dd:	and    $0xfffffffffffffff0,%rsp</span><br><span class="line">   0x7fffe10126e1:	call   0x7ffff694f3c0 &lt;_ZN14MacroAssembler7debug64EPclPl&gt;</span><br><span class="line">   0x7fffe10126e6:	hlt    </span><br><span class="line">   0x7fffe10126e7:	mov    %cl,0x0(%r13)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>源码分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">void TemplateTable::iload_internal(RewriteControl rc) &#123;</span><br><span class="line">  transition(vtos, itos);</span><br><span class="line">  if (RewriteFrequentPairs &amp;&amp; rc == may_rewrite) &#123;</span><br><span class="line">    Label rewrite, done;</span><br><span class="line">    Register bc = r4;</span><br><span class="line"></span><br><span class="line">    // get next bytecode</span><br><span class="line">    __ load_unsigned_byte(r1, at_bcp(Bytecodes::length_for(Bytecodes::_iload)));     </span><br><span class="line"></span><br><span class="line">    // if _iload, wait to rewrite to iload2.  We only want to rewrite the</span><br><span class="line">    // last two iloads in a pair.  Comparing against fast_iload means that</span><br><span class="line">    // the next bytecode is neither an iload or a caload, and therefore</span><br><span class="line">    // an iload pair.</span><br><span class="line">    __ cmpw(r1, Bytecodes::_iload);         &lt;--- 下一个bytecode</span><br><span class="line">    __ br(Assembler::EQ, done);             &lt;---- 跳转到done</span><br><span class="line"></span><br><span class="line">    // if _fast_iload rewrite to _fast_iload2</span><br><span class="line">    __ cmpw(r1, Bytecodes::_fast_iload);       &lt;-- 判断下一个是否是_fast_iload</span><br><span class="line">    __ movw(bc, Bytecodes::_fast_iload2);    &lt;------ 下一个是_fast_iload 则重写成fast_iload2</span><br><span class="line">    __ br(Assembler::EQ, rewrite);           &lt;--------  跳转到rewrite label  </span><br><span class="line"></span><br><span class="line">    // if _caload rewrite to _fast_icaload</span><br><span class="line">    __ cmpw(r1, Bytecodes::_caload);</span><br><span class="line">    __ movw(bc, Bytecodes::_fast_icaload);</span><br><span class="line">    __ br(Assembler::EQ, rewrite);</span><br><span class="line"></span><br><span class="line">    // else rewrite to _fast_iload</span><br><span class="line">    __ movw(bc, Bytecodes::_fast_iload);</span><br><span class="line"></span><br><span class="line">    // rewrite</span><br><span class="line">    // bc: new bytecode</span><br><span class="line">    __ bind(rewrite);</span><br><span class="line">    patch_bytecode(Bytecodes::_iload, bc, r1, false);</span><br><span class="line">    __ bind(done);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  // do iload, get the local value into tos</span><br><span class="line">  locals_index(r1);</span><br><span class="line">  __ ldr(r0, iaddress(r1));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="aconst-null"><a href="#aconst-null" class="headerlink" title="aconst_null"></a>aconst_null</h3><table>
<thead>
<tr>
<th>bytecode</th>
<th>desc</th>
<th>enum</th>
</tr>
</thead>
<tbody><tr>
<td>aconst_null</td>
<td>push a null reference onto the stack</td>
<td>0x01</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void TemplateTable::aconst_null() &#123;</span><br><span class="line">  transition(vtos, atos);</span><br><span class="line">  __ xorl(rax, rax);   // rax 就是栈顶</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="istore"><a href="#istore" class="headerlink" title="istore"></a>istore</h3><table>
<thead>
<tr>
<th>bytecode</th>
<th>desc</th>
<th>enum</th>
</tr>
</thead>
<tbody><tr>
<td>istore</td>
<td>Store int into local variable</td>
<td>54, &#x2F;&#x2F; 0x36</td>
</tr>
</tbody></table>
<p>可以通过这个bytecode 了解怎么访问本地变量 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void TemplateTable::istore() &#123;</span><br><span class="line">  transition(itos, vtos);   // 这里只是一个断言assert , 断言之前的状态是itos , 之后的状态是vtos , 实际上是由def来定义的</span><br><span class="line">  locals_index(rbx); // 将偏移 也就是index 写入rbx</span><br><span class="line">  __ movl(iaddress(rbx), rax); //iaddress 就是 rlocal + rbx 也就是获取最后的跳转地址 ,然后将rax写入偏移地址</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>iaddress(rbx)</code> 其实是rlocals+rbx 的偏移,也就是相对于本地变量的偏移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">static inline Address iaddress(Register r) &#123;</span><br><span class="line">  return Address(rlocals, r, Address::times_ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>iaddress</code> 的源码在这里: <code>src\hotspot\cpu\x86\assembler_x86.hpp</code><br>调用顺序是<code>iaddress</code> -&gt; <code>Address</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">static inline Address iaddress(Register r) &#123;</span><br><span class="line">  return Address(rlocals, r, Address::times_ptr);</span><br><span class="line">&#125;</span><br><span class="line">  Address(Register base, Register index, ScaleFactor scale, int disp = 0)</span><br><span class="line">    : _base (base),</span><br><span class="line">      _index(index),</span><br><span class="line">      _xmmindex(xnoreg),</span><br><span class="line">      _scale(scale),</span><br><span class="line">      _disp (disp),</span><br><span class="line">      _isxmmindex(false) &#123;</span><br><span class="line">    assert(!index-&gt;is_valid() == (scale == Address::no_scale),</span><br><span class="line">           &quot;inconsistent address&quot;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="def-istore展开"><a href="#def-istore展开" class="headerlink" title="def istore展开"></a>def istore展开</h4><p>前面不是看到<code>transition(itos, vtos); </code> , 这个<code>transition</code>只是一个类似测试时候的断言,真正是在<code>def</code> 处理的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">def(Bytecodes::_istore              , ubcp|____|clvm|____, itos, vtos, istore              ,  _           );</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面我们看看<code>def</code>展开,会慢慢展开成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">void TemplateTable::def(Bytecodes::Code code, int flags, TosState in, TosState out, void (*gen)(int arg), int arg) &#123;</span><br><span class="line">  ...</span><br><span class="line">  Template* t = is_wide ? template_for_wide(code) : template_for(code);</span><br><span class="line">  // setup entry</span><br><span class="line">  t-&gt;initialize(flags, in, out, gen, arg);</span><br><span class="line">  assert(t-&gt;bytecode() == code, &quot;just checkin&#x27;&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>这里的 in 和out 会在<code>TemplateInterpreterGenerator::generate_and_dispatch</code>的时候使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">void TemplateInterpreterGenerator::generate_and_dispatch(Template* t, TosState tos_out) &#123;</span><br><span class="line">#ifndef PRODUCT</span><br><span class="line">  // debugging code</span><br><span class="line">  if (CountBytecodes || TraceBytecodes || StopInterpreterAt &gt; 0) count_bytecode();</span><br><span class="line">  if (PrintBytecodeHistogram)                                    histogram_bytecode(t);</span><br><span class="line">  if (PrintBytecodePairHistogram)                                histogram_bytecode_pair(t);</span><br><span class="line">  if (TraceBytecodes)                                            trace_bytecode(t);</span><br><span class="line">  if (StopInterpreterAt &gt; 0)                                     stop_interpreter_at();</span><br><span class="line">  __ verify_FPU(1, t-&gt;tos_in());</span><br><span class="line">#endif // !PRODUCT</span><br><span class="line">  int step = 0;</span><br><span class="line">  if (!t-&gt;does_dispatch()) &#123;</span><br><span class="line">    step = t-&gt;is_wide() ? Bytecodes::wide_length_for(t-&gt;bytecode()) : Bytecodes::length_for(t-&gt;bytecode());</span><br><span class="line">    if (tos_out == ilgl) tos_out = t-&gt;tos_out();</span><br><span class="line">    // compute bytecode size</span><br><span class="line">    assert(step &gt; 0, &quot;just checkin&#x27;&quot;);</span><br><span class="line">    // setup stuff for dispatching next bytecode</span><br><span class="line">    if (ProfileInterpreter &amp;&amp; VerifyDataPointer</span><br><span class="line">        &amp;&amp; MethodData::bytecode_has_profile(t-&gt;bytecode())) &#123;</span><br><span class="line">      __ verify_method_data_pointer();</span><br><span class="line">    &#125;</span><br><span class="line">    __ dispatch_prolog(tos_out, step);</span><br><span class="line">  &#125;</span><br><span class="line">  // generate template</span><br><span class="line">  t-&gt;generate(_masm);</span><br><span class="line">  // advance</span><br><span class="line">  if (t-&gt;does_dispatch()) &#123;</span><br><span class="line">#ifdef ASSERT</span><br><span class="line">    // make sure execution doesn&#x27;t go beyond this point if code is broken</span><br><span class="line">    __ should_not_reach_here();</span><br><span class="line">#endif // ASSERT</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    // dispatch to next bytecode</span><br><span class="line">    __ dispatch_epilog(tos_out, step);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/perfma/p/15602013.html">https://www.cnblogs.com/perfma/p/15602013.html</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-6.html#jvms-6.5.iload_n">https://docs.oracle.com/javase/specs/jvms/se17/html/jvms-6.html#jvms-6.5.iload_n</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/437592111">https://zhuanlan.zhihu.com/p/437592111</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/List_of_Java_bytecode_instructions">https://en.wikipedia.org/wiki/List_of_Java_bytecode_instructions</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/02/28/utf8-encoding-and-java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/utf8-encoding-and-java/" class="post-title-link" itemprop="url">utf8 and utf16 and  encoding and java</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-28 10:09:37" itemprop="dateCreated datePublished" datetime="2023-02-28T10:09:37+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>java 的字符串会设计很多编码相关的问题,全部整理一下</p>
<h2 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a>知识点</h2><h3 id="Code-Unit"><a href="#Code-Unit" class="headerlink" title="Code Unit"></a>Code Unit</h3><p>code unit 描述的是一个编码的的最小单位(注意一个Unicode 平面对应的字符可能由多个code unit 组成)</p>
<table>
<thead>
<tr>
<th>编码</th>
<th>unit code</th>
</tr>
</thead>
<tbody><tr>
<td>utf-8</td>
<td>1字节</td>
</tr>
<tr>
<td>utf-16</td>
<td>2字节</td>
</tr>
</tbody></table>
<h2 id="java-的char"><a href="#java-的char" class="headerlink" title="java 的char"></a>java 的char</h2><p>java 的char 是2个字节,类型的范围是 <em>0 到 2^16 - 1</em>.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://shakudada.xyz/2023/02/21/clickhouse-mybatis-batch-insert-cpu-raise-up/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dinosaur">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dinosaur">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/21/clickhouse-mybatis-batch-insert-cpu-raise-up/" class="post-title-link" itemprop="url">clickhouse mybatis batch insert cpu raise up</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-21 13:55:21" itemprop="dateCreated datePublished" datetime="2023-02-21T13:55:21+08:00">2023-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-10-25 11:42:47" itemprop="dateModified" datetime="2023-10-25T11:42:47+08:00">2023-10-25</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p><img src="https://cdn4.shakudada.xyz/top.png" alt="背景"></p>
<p>使用jdbc clickhouse,批量写入,发现cpu升高非常多,升到了90%多</p>
<h2 id="排查及原因"><a href="#排查及原因" class="headerlink" title="排查及原因"></a>排查及原因</h2><h3 id="相关环境"><a href="#相关环境" class="headerlink" title="相关环境"></a>相关环境</h3><p>jdk: jdk11<br>clickhouse 使用的sql驱动: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;groupId&gt;com.clickhouse&lt;/groupId&gt;</span><br><span class="line"> &lt;artifactId&gt;clickhouse-jdbc&lt;/artifactId&gt;</span><br><span class="line"> &lt;version&gt;0.3.2-patch11&lt;/version&gt;</span><br></pre></td></tr></table></figure>


<p>原因:<br>使用mybatis plus 拼写sql,批量写入2000条<br>sql 用mybatis 的xml 拼写 类似:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into table values (row1_field1 , row1_field2 ),(row1_field1 , row1_field2) .... 这里是用mybatis 的xml foreache 2000 次</span><br></pre></td></tr></table></figure>

<p>线上warning日志:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Please consider to use one and only one values expression, for example: use &#x27;values(?)&#x27; instead of &#x27;values(?),(?)&#x27;.</span><br></pre></td></tr></table></figure>

<p>由于jdbc 的parser 比较慢,需要将perpare语句改成以下形式:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into table values ( ?, ? )  ## 只有一次 </span><br></pre></td></tr></table></figure>

<p>采用的是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// Note: &quot;insert into table values(?,?)&quot; is treated as &quot;insert into mytable&quot;</span><br><span class="line">try (PreparedStatement ps = conn.prepareStatement(&quot;insert into table values(?,?)&quot;)) &#123;</span><br><span class="line">    ps.setString(1, &quot;test&quot;); // id</span><br><span class="line">    ps.setObject(2, LocalDateTime.now()); // timestamp</span><br><span class="line">    ps.addBatch(); // append parameters to the query</span><br><span class="line">    ...</span><br><span class="line">    ps.executeBatch(); // issue the composed query: insert into mytable values(...)(...)...(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>cpu 从80%降低到30%以内<br>优化前:</p>
<p><img src="https://cdn4.shakudada.xyz/before.png" alt="优化前"></p>
<p>优化后:<br><img src="https://cdn4.shakudada.xyz/after.png" alt="优化后"></p>
<h2 id="相关阅读"><a href="#相关阅读" class="headerlink" title="相关阅读"></a>相关阅读</h2><ul>
<li><a target="_blank" rel="noopener" href="https://clickhouse.com/docs/en/integrations/language-clients/java/jdbc/#insert-1">https://clickhouse.com/docs/en/integrations/language-clients/java/jdbc/#insert-1</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/ClickHouse/clickhouse-java/issues/928">https://github.com/ClickHouse/clickhouse-java/issues/928</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/a783295110/article/details/123011034?spm=1001.2101.3001.6650.16&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-16-123011034-blog-120047936.pc_relevant_3mothn_strategy_recovery&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-16-123011034-blog-120047936.pc_relevant_3mothn_strategy_recovery&utm_relevant_index=24">https://blog.csdn.net/a783295110/article/details/123011034?spm=1001.2101.3001.6650.16&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-16-123011034-blog-120047936.pc_relevant_3mothn_strategy_recovery&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromBaidu%7ERate-16-123011034-blog-120047936.pc_relevant_3mothn_strategy_recovery&amp;utm_relevant_index=24</a></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">dinosaur</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">255</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">73</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/769344359" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;769344359" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/thedinosaurmail@gmail.com" title="E-Mail → thedinosaurmail@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dinosaur</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>














  

  

</body>
</html>
